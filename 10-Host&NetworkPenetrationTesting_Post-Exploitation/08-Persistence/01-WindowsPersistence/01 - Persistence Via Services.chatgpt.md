# 01 – Persistence Via Services (Windows)

Note: No transcript was provided. The following is a conservative, exam-focused summary inferred from the filename and common eJPT lab practices around Windows persistence via services. Use only on systems you own or have explicit authorization to test.

## What the video covers (Introduction / big picture)
- Concept of Windows services as long-lived processes managed by the Service Control Manager (SCM).
- Why services are a strong persistence mechanism: run at boot, can run as LocalSystem, can self-restart on failure.
- Two core approaches:
  - Create a new service that launches your program/script at startup.
  - Hijack/modify an existing service’s binary path to run your program.
- Audit/logging and operational cautions (Event ID 7045 on service creation, need for admin rights, quoting pitfalls).
- Tooling: sc.exe, PowerShell (New-Service/Set-Service), reg.exe, services.msc; optionally Sysinternals AccessChk and NSSM.

## Flow (ordered)
1. Confirm you have administrative privileges.
2. Enumerate services and their configurations.
3. Decide: create a new service or modify an existing one.
4. Stage a benign test script or binary locally (lab-safe) to verify persistence.
5. Register/configure the service (startup type, account, failure actions).
6. Start the service and validate execution.
7. Reboot test (optional) to confirm persistence across restarts.
8. Review logs and clean up (remove service/artifacts) when done.

## Tools highlighted
- sc.exe (built-in): create, configure, start/stop, delete services.
- PowerShell:
  - New-Service, Set-Service, Start-Service, Get-Service.
  - WMI/CIM classes (Win32_Service) for enumeration.
- reg.exe: query/edit HKLM\SYSTEM\CurrentControlSet\Services\<SvcName>.
- services.msc: GUI inspection.
- wevtutil: query Event Logs (e.g., service creation 7045).
- Optional:
  - Sysinternals AccessChk: check service permission issues.
  - NSSM (Non-Sucking Service Manager): wrap arbitrary programs as services.

## Typical command walkthrough (detailed, copy-paste friendly)

Important: Run an elevated cmd/PowerShell. Replace names/paths per your lab. The demo payload below is harmless (writes whoami to a file) so you can validate service execution safely.

1) Quick privilege and service enumeration
```
whoami /groups
whoami /priv

sc.exe query type= service state= all
sc.exe qc "Spooler"

wmic service get Name,State,StartMode,StartName,PathName /format:list

powershell -NoP -W Hidden -C "Get-Service | Sort-Object Status,Name | ft -AutoSize"
powershell -NoP -W Hidden -C "Get-WmiObject Win32_Service | Select Name,DisplayName,StartMode,StartName,State,PathName | ft -AutoSize"
```

2) Stage a benign test script (lab-safe)
```
echo @echo off> C:\ProgramData\svc-demo.bat
echo whoami ^> C:\ProgramData\svc-demo.txt>> C:\ProgramData\svc-demo.bat
```

3) Create a new service (sc.exe)
- BinPath quoting is critical. sc.exe requires a space after each equals.
```
sc.exe create WinUpdate binPath= "C:\Windows\System32\cmd.exe /c C:\ProgramData\svc-demo.bat" start= auto DisplayName= "Windows Update (Demo)"
sc.exe description WinUpdate "Demo: runs a harmless script at boot (lab)"
sc.exe start WinUpdate
sc.exe query WinUpdate
type C:\ProgramData\svc-demo.txt
```

4) Create a new service (PowerShell alternative)
```
powershell -NoP -W Hidden -C "New-Service -Name 'WinUpdate' -BinaryPathName 'C:\Windows\System32\cmd.exe /c C:\ProgramData\svc-demo.bat' -DisplayName 'Windows Update (Demo)' -Description 'Lab demo service' -StartupType Automatic"
powershell -NoP -W Hidden -C "Start-Service -Name 'WinUpdate'"
powershell -NoP -W Hidden -C "Get-Service -Name 'WinUpdate' | fl *"
```

5) Configure failure actions (service restarts if it crashes)
```
sc.exe failure WinUpdate reset= 86400 actions= restart/60000/restart/60000/restart/60000
sc.exe failureflag WinUpdate 1
sc.exe qfailure WinUpdate
```

6) Set delayed auto-start (optional; helps avoid race conditions)
- sc.exe doesn’t expose delayed-auto; set the registry value:
```
reg add "HKLM\SYSTEM\CurrentControlSet\Services\WinUpdate" /v DelayedAutoStart /t REG_DWORD /d 1 /f
```

7) Modify an existing service (hijack approach; be careful)
- Pick a rarely used or manual-start service to avoid breaking the system. Stop service first if running.
```
sc.exe qc "SomeService"
sc.exe stop "SomeService"
sc.exe config "SomeService" binPath= "\"C:\Windows\System32\cmd.exe\" /c C:\ProgramData\svc-demo.bat" start= demand
sc.exe start "SomeService"
type C:\ProgramData\svc-demo.txt
```

8) Registry method to view/edit ImagePath (alternative to sc config)
```
reg query "HKLM\SYSTEM\CurrentControlSet\Services\SomeService" /v ImagePath
reg add "HKLM\SYSTEM\CurrentControlSet\Services\SomeService" /v ImagePath /t REG_EXPAND_SZ /d "C:\Windows\System32\cmd.exe /c C:\ProgramData\svc-demo.bat" /f
```

9) Validate across reboot (optional)
```
shutdown /r /t 0
```
After reboot:
```
sc.exe query WinUpdate
type C:\ProgramData\svc-demo.txt
```

10) Event log triage (service creation is logged as 7045)
```
wevtutil qe System /q:"*[System[(EventID=7045)]]" /c:10 /f:text /rd:true
```

11) Cleanup (remove artifacts when done)
```
sc.exe stop WinUpdate
sc.exe delete WinUpdate
del /f /q C:\ProgramData\svc-demo.bat
del /f /q C:\ProgramData\svc-demo.txt
```

Optional: Check service DACLs with AccessChk (to find modifiable services)
```
accesschk64.exe -uwcqv "Users" * -k "HKLM\System\CurrentControlSet\Services"
accesschk64.exe -ucqv "<YourUser>" * -k "HKLM\System\CurrentControlSet\Services"
```

Optional: Install with NSSM if you need a robust wrapper
```
nssm install WinUpdate "C:\Windows\System32\cmd.exe" "/c C:\ProgramData\svc-demo.bat"
nssm set WinUpdate Start SERVICE_AUTO_START
sc.exe start WinUpdate
```

## Practical tips
- Admin rights required: Creating or modifying services needs elevated privileges.
- sc.exe syntax gotchas:
  - There must be a space after each equals, e.g., start= auto.
  - Quote the entire binPath if it contains spaces; for cmd.exe wrappers, often double-quote cmd.exe and escape inner quotes.
- Choose startup mode wisely:
  - Automatic or DelayedAutoStart for boot persistence.
  - Demand/manual if you plan to trigger it on demand.
- Failure actions make services resilient; set reset interval and multiple restarts.
- Don’t break the OS: If hijacking an existing service, pick non-critical ones and note original config to restore later.
- Logging and detection:
  - Event ID 7045 (System log) for new service creation.
  - Service changes can also be audited; plan tests and cleanup.
- 32-bit vs 64-bit: Prefer full paths like C:\Windows\System32\cmd.exe to avoid SysWOW64 redirection surprises.
- Testing: Use a benign action (write to a file) to confirm service execution before switching to any legitimate agent/tooling.
- Cleanup: Always remove your test service and artifacts when done.

## Minimal cheat sheet (one-screen flow)
```
:: 1) Stage a harmless test payload
echo @echo off> C:\ProgramData\svc-demo.bat
echo whoami ^> C:\ProgramData\svc-demo.txt>> C:\ProgramData\svc-demo.bat

:: 2) Create & start a persistent service
sc.exe create WinUpdate binPath= "C:\Windows\System32\cmd.exe /c C:\ProgramData\svc-demo.bat" start= auto DisplayName= "Windows Update (Demo)"
sc.exe description WinUpdate "Lab demo service"
sc.exe failure WinUpdate reset= 86400 actions= restart/60000/restart/60000/restart/60000
sc.exe failureflag WinUpdate 1
sc.exe start WinUpdate

:: 3) Verify execution and configure delayed start (optional)
type C:\ProgramData\svc-demo.txt
reg add "HKLM\SYSTEM\CurrentControlSet\Services\WinUpdate" /v DelayedAutoStart /t REG_DWORD /d 1 /f

:: 4) Reboot test (optional), then check
:: shutdown /r /t 0
sc.exe query WinUpdate

:: 5) Event log quick check
wevtutil qe System /q:"*[System[(EventID=7045)]]" /c:5 /f:text /rd:true

:: 6) Cleanup
sc.exe stop WinUpdate
sc.exe delete WinUpdate
del /f /q C:\ProgramData\svc-demo.bat
del /f /q C:\ProgramData\svc-demo.txt
```

## Summary
- Services are a reliable Windows persistence method because they can start at boot and run with powerful accounts like LocalSystem.
- In labs, you can either create a new service pointing to your executable/script or safely modify an existing, non-critical service’s ImagePath.
- sc.exe and PowerShell provide built-in ways to create, configure, and manage services; reg.exe lets you adjust ImagePath and delayed start.
- Configure failure actions for resilience and validate via logs (Event ID 7045). Always test with a harmless payload first and clean up afterward.