# 04 - Persistence Via RDP (Windows Persistence) — eJPT Study Notes

Note: No transcript was provided. The content below is inferred conservatively from the filename and typical eJPT Windows persistence topics. Where exact commands could enable unauthorized access, this summary keeps them high-level. Detailed commands focus on auditing, detection, and remediation in a lab or authorized environment.

## What the video covers (Introduction / big picture)
- Conceptual overview of Windows persistence via Remote Desktop Protocol (RDP).
- Preconditions: local admin/SYSTEM privileges on a target and network reachability to the RDP port.
- Core elements of RDP persistence:
  - RDP service state (TermService), autostart, and listening port.
  - System policy/registry settings that allow/disallow RDP and Network Level Authentication (NLA).
  - Local firewall rules permitting inbound RDP.
  - User accounts and group memberships permitting RDP logon.
- OPSEC and detection: event logs, group changes, firewall changes, registry traces.
- Defensive checks and remediation.

## Flow (ordered)
1. Confirm privilege level and host/network reachability.
2. Verify whether RDP is enabled at the OS level.
3. Verify the RDP service (TermService) status and startup type.
4. Check Windows Firewall rules for Remote Desktop.
5. Check listening port and binding (default TCP/3389).
6. Verify user rights: “Allow log on through Remote Desktop Services,” group memberships.
7. Test interactive RDP connection (mstsc) in a lab.
8. Review logs generated by RDP connections and configuration changes.
9. Defensive baselining and cleanup/remediation.

## Tools highlighted
- mstsc.exe (RDP client)
- PowerShell (Get-Service, Get-NetFirewallRule, Get-WinEvent)
- Windows command line tools:
  - reg.exe (registry queries)
  - sc.exe (service control)
  - netsh advfirewall (firewall rules)
  - net.exe (local groups/users queries)
  - netstat.exe (ports)
  - qwinsta/quser (RDP sessions)
  - wevtutil.exe (event logs)
- MMC snap-ins (GUI, for reference): services.msc, lusrmgr.msc, gpedit.msc, eventvwr.msc

## Typical command walkthrough (detailed, copy-paste friendly)

The following commands focus on auditing/detection and safe remediation in an authorized lab. They help you verify RDP-related persistence mechanisms and clean them up.

### Audit: RDP service and OS settings
```cmd
:: Service state and configuration
sc query TermService
sc qc TermService

:: Is RDP allowed at OS level? (0 = allowed, 1 = denied)
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections

:: Network Level Authentication (1 = require NLA, 0 = do not require)
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication

:: What port is RDP using? (default 3389, DWORD little-endian)
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber
```

```powershell
# PowerShell equivalents
Get-Service -Name TermService | Format-List *
Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections
Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication,PortNumber
```

### Audit: Firewall rules for RDP
```cmd
:: Show Remote Desktop firewall rules (Domain/Private/Public profiles)
netsh advfirewall firewall show rule name="Remote Desktop"

:: Show all rules in the "Remote Desktop" group
netsh advfirewall firewall show rule name=all | findstr /i "Remote Desktop"
```

```powershell
# PowerShell view of Remote Desktop firewall rules
Get-NetFirewallRule -DisplayGroup "Remote Desktop" | Get-NetFirewallPortFilter | Select-Object Name,Protocol,LocalPort,RemoteAddress
```

### Audit: Listening port and sessions
```cmd
:: Is something listening on 3389? (look for LISTENING)
netstat -ano | findstr /R /C:":3389 .*LISTENING"

:: List terminal sessions (remote/console)
qwinsta
quser
```

### Audit: Accounts and rights relevant to RDP
```cmd
:: Who is in the local "Remote Desktop Users" group?
net localgroup "Remote Desktop Users"

:: Who are local administrators? (often implicitly allowed RDP by policy)
net localgroup Administrators
```

Check effective logon rights via local security policy export:
```cmd
:: Export local security policy to a file and inspect entries
secedit /export /cfg "%TEMP%\secpol.cfg" >NUL 2>&1
type "%TEMP%\secpol.cfg" | findstr /I "SeRemoteInteractiveLogonRight SeDenyRemoteInteractiveLogonRight"
```
- SeRemoteInteractiveLogonRight = principals allowed to log on via RDP
- SeDenyRemoteInteractiveLogonRight = principals explicitly denied

### Audit: Event logs for RDP usage and configuration changes
```powershell
# RDP user authentication succeeded (Operational log)
Get-WinEvent -LogName "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational" `
  -FilterXPath "*[System[(EventID=1149)]]" -MaxEvents 50 |
  Select-Object TimeCreated, Id, ProviderName, Message

# RDP session logon/logoff activity (LSM Operational)
Get-WinEvent -LogName "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational" -MaxEvents 50 |
  Select-Object TimeCreated, Id, Message
```

```cmd
:: Successful logons via RDP (Security, LogonType=10)
wevtutil qe Security "/q:*[System[(EventID=4624)]] and *[EventData[Data[@Name='LogonType']='10']]" /f:text /c:20

:: Account created / group membership changes (Security)
wevtutil qe Security "/q:*[System[(EventID=4720 or EventID=4732 or EventID=4728 or EventID=4738)]]" /f:text /c:20

:: Firewall rule changes (Security 4946/4947/4948)
wevtutil qe Security "/q:*[System[(EventID=4946 or EventID=4947 or EventID=4948)]]" /f:text /c:20
```

### Remediation/Hardening (authorized environments)
```cmd
:: Disable RDP at OS level (1 = deny)
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1 /f

:: Require NLA (more secure: 1 = require)
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 1 /f

:: Disable the "Remote Desktop" firewall rules (to block inbound)
netsh advfirewall firewall set rule group="Remote Desktop" new enable=No

:: Optional: stop and disable the RDP service
sc stop TermService
sc config TermService start= disabled

:: Remove suspicious users from RDP-related groups (replace EVILUSER)
net localgroup "Remote Desktop Users" EVILUSER /delete
net localgroup Administrators EVILUSER /delete
```

## Practical tips
- RDP persistence is noisy: group changes, firewall changes, registry writes, and RDP logons leave multiple log artifacts.
- Default port 3389 is well known and frequently monitored. Changing ports is detectable via registry and netstat.
- NLA offloading: Requiring NLA is safer; disabling it increases risk and should be flagged.
- Closely monitor:
  - Local group changes (4732/4733), user creation (4720), account changes (4738).
  - RDP auth success (1149) and LogonType 10 (4624).
  - Firewall rule edits (4946–4948).
- For blue teams: baseline group memberships and firewall rules, alert on deviations, and audit “Allow log on through RDP” rights regularly.
- For lab testing: snapshot VMs before making changes; clearly document what you change so you can revert.

## Minimal cheat sheet (one-screen flow)
- Service/OS state:
  - sc query TermService
  - reg query HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server /v fDenyTSConnections
  - reg query HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp /v UserAuthentication
- Firewall:
  - netsh advfirewall firewall show rule name="Remote Desktop"
  - Get-NetFirewallRule -DisplayGroup "Remote Desktop"
- Port and sessions:
  - netstat -ano | findstr ":3389"
  - qwinsta / quser
- Users/rights:
  - net localgroup "Remote Desktop Users"
  - net localgroup Administrators
  - secedit /export /cfg "%TEMP%\secpol.cfg" && findstr /I "SeRemoteInteractiveLogonRight" "%TEMP%\secpol.cfg"
- Logs:
  - Get-WinEvent -LogName "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational" -FilterXPath "*[System[(EventID=1149)]]"
  - wevtutil qe Security "/q:*[System[(EventID=4624)]] and *[EventData[Data[@Name='LogonType']='10']]" /f:text /c:20
- Remediate:
  - reg add "...Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1 /f
  - netsh advfirewall firewall set rule group="Remote Desktop" new enable=No
  - sc config TermService start= disabled

## Summary
This module presents how persistence via RDP hinges on four pillars: the RDP service (TermService), OS policy/registry toggles (fDenyTSConnections, NLA), firewall allowances, and user/group rights permitting remote interactive logon. In practice, any persistence relying on RDP leaves multiple, well-correlated artifacts across registry, services, firewall rules, group membership, and event logs (1149, 4624 type 10, 4720/4732, 4946–4948). The walkthrough above provides concrete checks to rapidly assess a host’s RDP posture and to remediate in an authorized lab or incident response scenario.