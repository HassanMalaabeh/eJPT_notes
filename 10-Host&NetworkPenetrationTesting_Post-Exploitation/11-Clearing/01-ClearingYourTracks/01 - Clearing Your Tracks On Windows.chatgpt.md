# 01 – Clearing Your Tracks on Windows (Defender-focused eJPT Notes)

Note: No transcript was provided. The following is inferred conservatively from the filename/context and focuses on defensive detection and hardening rather than evasion. Use only in a lab with proper authorization.

## What the video covers (Introduction / big picture)
- Big picture: Windows creates many logs and artifacts that reveal user and tool activity. Attempted “track clearing” typically leaves its own indicators.
- Core learning: Where Windows records activity, what “log tampering” looks like, how to quickly detect it, and how to harden logging so important evidence is preserved and forwarded off-host.
- Emphasis: Event logs (Security/System/Application), PowerShell logs, common forensic artifacts, audit policy, and practical checks you can run during assessments/IR.

## Flow (ordered)
1. Review Windows logging surfaces (Event Logs, PowerShell/ETW, key artifacts).
2. Common things attackers try to hide and the traces that reveals them (e.g., cleared logs, audit policy changes, service restarts).
3. Quick checks to detect tampering and back up logs.
4. Configure stronger auditing, increase log sizes, enable PowerShell logging, and consider Sysmon.
5. Validate visibility by querying specific event IDs and artifact locations.
6. Best practices for centralization and prevention.

## Tools highlighted
- Event Viewer (eventvwr.msc) – interactive log review
- wevtutil – query/export/log info from the command line
- PowerShell Get-WinEvent / Get-EventLog – structured log queries
- auditpol – view/adjust advanced audit policy
- Local Security Policy (secpol.msc) / Group Policy (gpmc.msc) – hardening and rights
- Sysmon (Sysinternals) – enriched telemetry (process/file/network) with config
- wecutil / winrm – Windows Event Forwarding (centralization)
- File system/registry views – artifact inspection (no deletion)

## Typical command walkthrough (detailed, copy-paste friendly)

Note: Commands below focus on reviewing, backing up, and hardening logs; they do not provide instructions to evade detection.

- Basic environment info and current privileges:
```
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
whoami /user
whoami /priv
```

- List all log channels and inspect key log properties/retention:
```
wevtutil el
wevtutil gli Security
wevtutil gli System
wevtutil gli Application
wevtutil gli "Microsoft-Windows-PowerShell/Operational"
```

- Backup critical logs before analysis or changes:
```
mkdir C:\IR\Logs 2>NUL
wevtutil epl Security C:\IR\Logs\Security.evtx
wevtutil epl System C:\IR\Logs\System.evtx
wevtutil epl Application C:\IR\Logs\Application.evtx
wevtutil epl "Microsoft-Windows-PowerShell/Operational" C:\IR\Logs\PowerShell_Operational.evtx
wevtutil epl "Microsoft-Windows-WMI-Activity/Operational" C:\IR\Logs\WMI_Operational.evtx
```

- Hunt for indicators of log tampering and audit-policy changes:
```
:: Security log cleared
wevtutil qe Security /q:"*[System[(EventID=1102)]]" /f:text /c:10

:: Log cleared (System channel)
wevtutil qe System /q:"*[System[(EventID=104) and Provider[@Name='Microsoft-Windows-Eventlog']]]" /f:text /c:10

:: Event Log service down/up; system start/stop (context around log gaps)
wevtutil qe System /q:"*[System[(EventID=1100 or EventID=6005 or EventID=6006 or EventID=6008)]]" /f:text /c:25

:: Audit policy changes (monitor closely)
wevtutil qe Security /q:"*[System[(EventID=4719 or EventID=4902 or EventID=4906 or EventID=4907 or EventID=4908)]]" /f:text /c:25
```

- PowerShell logging checks (Operational channel exists and is populated):
```
powershell -NoLogo -NoProfile -Command "Get-WinEvent -LogName 'Microsoft-Windows-PowerShell/Operational' -MaxEvents 20 | Format-List TimeCreated,Id,Message"
```

- Review PowerShell history (PSReadLine):
```
type "%APPDATA%\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt" | more
```

- Quick artifact sanity checks (empty/abruptly reset collections can be suspicious):
```
:: Prefetch (may be disabled on some server SKUs)
powershell -NoProfile -Command "Get-ChildItem 'C:\Windows\Prefetch' -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 10 Name,LastWriteTime"

:: Jump Lists
powershell -NoProfile -Command "Get-ChildItem '$env:APPDATA\Microsoft\Windows\Recent\AutomaticDestinations' -ErrorAction SilentlyContinue | Sort-Object Length -Descending | Select-Object -First 10 Name,Length,LastWriteTime"

:: RDP cache
powershell -NoProfile -Command "Get-ChildItem '$env:APPDATA\Microsoft\Terminal Server Client\Cache' -ErrorAction SilentlyContinue | Measure-Object"
```

- Baseline and harden audit policy (visibility for process/logon/policy/system):
```
auditpol /list /subcategory:*
auditpol /get /category:*

:: Enable key subcategories (example baseline)
auditpol /set /subcategory:"Logon" /success:enable /failure:enable
auditpol /set /subcategory:"Account Lockout" /success:enable /failure:enable
auditpol /set /subcategory:"Process Creation" /success:enable
auditpol /set /subcategory:"Audit Policy Change" /success:enable /failure:enable
auditpol /set /subcategory:"Other System Events" /success:enable /failure:enable
auditpol /set /subcategory:"Security System Extension" /success:enable
auditpol /set /subcategory:"System Integrity" /success:enable
```

- Include command line in process creation events (helps spot suspicious commands):
```
reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\Audit /v ProcessCreationIncludeCmdLine_Enabled /t REG_DWORD /d 1 /f
```

- Enable richer PowerShell telemetry (Script Block + Module logging):
```
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging /v EnableScriptBlockLogging /t REG_DWORD /d 1 /f
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging /v EnableModuleLogging /t REG_DWORD /d 1 /f
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging\ModuleNames /v * /t REG_SZ /d * /f
```

- Increase critical log sizes to reduce overwrite risk:
```
wevtutil sl Security /ms:268435456
wevtutil sl "Microsoft-Windows-PowerShell/Operational" /ms:33554432
```

- Optional: Start a PowerShell transcript (for lab visibility):
```
powershell -NoProfile -Command "Start-Transcript -Path \"$env:USERPROFILE\Documents\ps_transcript.txt\" -Append"
```
(Stop with: Stop-Transcript)

- Optional: Sysmon (telemetry enrichment; requires download and config):
```
:: Run from an elevated prompt where sysmon64.exe and your config are present
sysmon64.exe -accepteula -i sysmonconfig.xml
```

- Optional: Event forwarding quick configuration (collector):
```
wecutil qc
winrm quickconfig
```

## Practical tips
- Back up logs immediately on arrival; review the backup, not the live log, to avoid accidental changes.
- Look for log clearing and audit-policy changes around the time of suspected activity. These actions usually generate distinct events (e.g., Security 1102; System 104/1100; Security 4719).
- Create a baseline of audit policy and log sizes; monitor for drift.
- Centralize logs (WEF/SIEM). If logs exist only on the endpoint, you’re one admin action away from losing them.
- Enable command-line auditing for process creation and PowerShell Script Block/Module logging for better reconstruction.
- Empty or abruptly “too clean” artifacts (Prefetch, Jump Lists, PS history) can be as suspicious as noisy ones—correlate with boot/service restart times and policy changes.
- Limit “Manage auditing and security log” user right to a minimal admin group; review members regularly.
- Time sync matters. Out-of-sync clocks hinder correlation and can mask activity windows.

## Minimal cheat sheet (one-screen flow)
```
:: 1) Enumerate + backup
wevtutil el
mkdir C:\IR\Logs 2>NUL
wevtutil epl Security C:\IR\Logs\Security.evtx
wevtutil epl System C:\IR\Logs\System.evtx
wevtutil epl Application C:\IR\Logs\Application.evtx
wevtutil epl "Microsoft-Windows-PowerShell/Operational" C:\IR\Logs\PS_Operational.evtx

:: 2) Log health/retention
wevtutil gli Security
wevtutil sl Security /ms:268435456

:: 3) Tamper indicators
wevtutil qe Security /q:"*[System[(EventID=1102)]]" /f:text /c:10
wevtutil qe System /q:"*[System[(EventID=104 or EventID=1100 or EventID=6005 or EventID=6006 or EventID=6008)]]" /f:text /c:25
wevtutil qe Security /q:"*[System[(EventID=4719 or EventID=4902 or EventID=4906 or EventID=4907 or EventID=4908)]]" /f:text /c:25

:: 4) PowerShell visibility
reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\Audit /v ProcessCreationIncludeCmdLine_Enabled /t REG_DWORD /d 1 /f
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging /v EnableScriptBlockLogging /t REG_DWORD /d 1 /f
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging /v EnableModuleLogging /t REG_DWORD /d 1 /f

:: 5) Quick artifact sanity checks
powershell -NoProfile -Command "Get-ChildItem 'C:\Windows\Prefetch' -ea SilentlyContinue | Sort LastWriteTime -desc | Select -First 10 Name,LastWriteTime"
powershell -NoProfile -Command "Get-ChildItem '$env:APPDATA\Microsoft\Windows\Recent\AutomaticDestinations' -ea SilentlyContinue | Sort Length -desc | Select -First 10 Name,Length,LastWriteTime"
type "%APPDATA%\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt" | more
```

## Summary
- Windows logs and artifacts provide strong visibility—and attempted “track clearing” typically produces its own audit events.
- Key events: Security 1102 (security log cleared), System 104/1100 (log cleared / service shutdown), and 4719 (audit policy changed). Correlate with boot/service events (6005/6006/6008) and PowerShell/WMI/Task Scheduler channels.
- Hardening steps: enable detailed audit subcategories, include process command lines, enable PowerShell Script Block/Module logging, increase log sizes, and centralize via WEF/SIEM. Consider Sysmon for richer telemetry.
- In lab settings, validate that these controls produce the expected events, and watch for suspicious gaps, resets, or “too clean” artifacts.