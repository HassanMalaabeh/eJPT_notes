# 10 - Establishing Persistence On Linux (eJPT)

Note: The transcript for this video was not provided. The following summary is inferred conservatively from the filename and the “05-LinuxPostExploitation” module context. For safety and ethics, this summary focuses on concepts, artifacts, verification, detection, and cleanup. It does not include step-by-step instructions for implanting persistence on systems you don’t own or lack explicit authorization to test.

## What the video covers (Introduction / big picture)
- Concept of persistence in Linux post-exploitation: maintaining access across reboots/logouts.
- Typical persistence surfaces attackers target and the forensic artifacts they leave.
- How to verify if persistence is active, how to detect common techniques, and how to clean them up.
- Operational security and ethics: only perform in an authorized lab; prefer low-impact methods; document and be ready to revert.
- For eJPT study: understand categories, common file paths, services, and how defenders can spot and remove them.

## Flow (ordered)
1. Confirm scope and authorization; snapshot/backup the target system (lab) before changes.
2. Identify current privileges (user vs root) and system init type (systemd vs SysV).
3. Map common persistence vectors:
   - Accounts and SSH keys
   - Scheduled tasks (cron, at, systemd timers)
   - Services/units (systemd/init scripts)
   - Shell/profile startup files
   - Boot scripts (rc.local), desktop autostart
   - Dynamic linker tricks (ld.so.preload), PAM
   - SUID/SGID binaries, malicious daemons
4. Verify whether any of these are present or active; correlate with logs.
5. Document artifacts (paths, timestamps, unit names, cron entries).
6. Remediate: disable, remove, restore, and monitor.
7. Post-cleanup verification and continuous monitoring.

## Tools highlighted
- System and service management: systemctl, journalctl, service, chkconfig/update-rc.d
- Schedulers: crontab, at, systemd timers
- SSH and accounts: sshd/sshd_config, authorized_keys, getent, passwd, shadow
- Discovery and triage: find, grep, awk, sed, diff, stat, lsattr/chattr
- Networking/process insight: ss, lsof, ps, systemd-cgls, netstat (legacy)
- Logging: journalctl, /var/log/auth.log or /var/log/secure, /var/log/syslog, /var/log/messages
- Security/detection aids: auditd, ausearch/aureport, rkhunter, chkrootkit, AIDE/Tripwire

## Typical command walkthrough (detailed, copy-paste friendly)
The following commands are defensive and verification-oriented. They help you audit a Linux host for common persistence techniques, identify suspicious entries, and clean up safely.

Baseline context
```
# Who am I and what init system am I using?
whoami; id
ps -p1 -o comm=
uname -a
```

Accounts and SSH keys
```
# List accounts with interactive shells (possible persistence via user creation)
awk -F: '($7 ~ /(bash|zsh|sh|fish)$/){print $0}' /etc/passwd

# Recently modified /etc/passwd and /etc/shadow timestamps
ls -l --time-style=long-iso /etc/passwd /etc/shadow

# Enumerate authorized_keys across users (look for unfamiliar keys or recent changes)
sudo find /root /home -maxdepth 3 -type f -name authorized_keys -exec ls -l {} \; -exec stat -c "mtime: %y | %n" {} \;

# Check SSH server config for unusual options (e.g., PermitRootLogin, AuthorizedKeysFile overrides)
sudo egrep -n 'PermitRootLogin|AuthorizedKeysFile|AllowUsers|AllowGroups|ForceCommand' /etc/ssh/sshd_config
```

Cron, at, and systemd timers
```
# System-wide crontab and cron directories
sudo ls -la /etc/crontab /etc/cron.d
sudo grep -R --line-number . /etc/cron.d 2>/dev/null
sudo ls -la /etc/cron.hourly /etc/cron.daily /etc/cron.weekly /etc/cron.monthly
sudo grep -n . /etc/crontab

# User crontabs (loop through users)
while IFS=: read -r user _; do
  crontab -u "$user" -l 2>/dev/null | sed "s/^/[user=$user] /"
done < <(cut -d: -f1 /etc/passwd)

# at jobs
atq
# For each job id from atq, inspect with: at -c <jobid>

# systemd timers (persistence via timers)
systemctl list-timers --all
# Inspect timer and unit details
# Replace <timer> with the timer name identified above
# systemctl cat <timer>
# systemctl cat <associated.service>
```

Systemd services and init scripts
```
# Enabled services
systemctl list-unit-files --type=service --state=enabled

# Running services and recent failures
systemctl --failed
systemctl list-units --type=service --state=running

# Inspect unknown services (look for odd names or non-standard paths)
# Replace suspicious.service with findings
# systemctl status suspicious.service
# journalctl -u suspicious.service --no-pager --since "7 days ago"
# systemctl cat suspicious.service

# Search for ExecStart lines running shells, curl/wget/nc/socat, or scripts in user-writable dirs
sudo grep -R -nE 'ExecStart=.*(bash|sh|zsh|python|perl|ruby|curl|wget|nc|ncat|socat|/dev/tcp|mkfifo)' \
  /etc/systemd/system /lib/systemd/system 2>/dev/null

# Legacy SysV init scripts (less common on modern systems)
ls -la /etc/init.d
```

Shell/profile startup files
```
# System-wide profiles
sudo egrep -nH . /etc/profile /etc/bash.bashrc 2>/dev/null

# Per-user startup files (bash/zsh). Scan for network beacons or suspicious commands.
sudo grep -R -nE '(curl|wget|nc|socat|bash -i|python -c|/dev/tcp/|mkfifo)' \
  /root/.* /home/*/.bashrc /home/*/.bash_profile /home/*/.profile /home/*/.zshrc 2>/dev/null
```

Boot scripts and desktop autostart
```
# rc.local (if present/used)
test -e /etc/rc.local && { ls -l /etc/rc.local; sudo sed -n '1,200p' /etc/rc.local; }

# Graphical session autostart entries
find /etc/xdg/autostart ~/.config/autostart -type f -name "*.desktop" -exec ls -l {} \; -exec grep -nE 'Exec=' {} \; 2>/dev/null
```

Dynamic linker tricks and PAM
```
# Suspicious global preload (could auto-load a malicious library)
if [ -f /etc/ld.so.preload ]; then
  echo "[/etc/ld.so.preload present]"; sudo cat /etc/ld.so.preload
fi

# Check for unexpected PAM exec hooks (can persist via login stack)
sudo grep -R -nE 'pam_exec\.so|session.*required.*pam_.*' /etc/pam.d 2>/dev/null
sudo sed -n '1,200p' /etc/pam.d/sshd
```

SUID/SGID and new listeners
```
# SUID/SGID binaries (look for unusual or recently modified ones)
sudo find / -xdev \( -perm -4000 -o -perm -2000 \) -type f -printf "%M %u:%g %TY-%Tm-%Td %TH:%TM %p\n" 2>/dev/null | sort

# Listening sockets and owning processes
ss -tulpen
# or
sudo lsof -i -P -n | grep LISTEN
```

Log review and auditing
```
# Authentication logs (Debian/Ubuntu vs RHEL/CentOS)
sudo tail -n 200 /var/log/auth.log 2>/dev/null || sudo tail -n 200 /var/log/secure 2>/dev/null

# System logs (recent boots, service activity)
journalctl -b -0 -n 200 --no-pager
journalctl -p warning -b --no-pager

# Optional: auditd quick checks (if enabled)
sudo ausearch -m EXECVE -ts recent 2>/dev/null | tail -n 50
```

Safe remediation examples (disable/collect evidence/remove)
```
# Before changes, capture evidence
ts=$(date +%F-%H%M%S)
mkdir -p ~/forensics-$ts

# Example: preserve suspicious unit and then disable it
svc="suspicious.service"
sudo systemctl cat "$svc" > ~/forensics-$ts/"$svc".unit 2>/dev/null
sudo journalctl -u "$svc" --since "14 days ago" > ~/forensics-$ts/"$svc".log 2>/dev/null
sudo systemctl disable --now "$svc"

# Example: back up and clear a malicious crontab entry (per user)
user="alice"
crontab -u "$user" -l > ~/forensics-$ts/"$user".crontab.bak 2>/dev/null
# Then edit interactively and remove the bad line:
# crontab -u "$user" -e
```

## Practical tips
- Ethics first: Do not implant persistence on systems you don’t own or lack explicit authorization to test. In lab scenarios, snapshot/backup and plan cleanup.
- Minimal footprint: Favor techniques that are easy to detect and remove in a lab; document every path edited and unit name created.
- Log correlation: After spotting an artifact (e.g., a new service), pivot to logs (journalctl and auth logs) and process/network views (ps/ss/lsof) to validate impact.
- Baselines help: Know what “normal” looks like for systemd units, crontabs, and SUID files for your distro/image; diff against a clean template.
- Permissions matter: Many persistence methods require root. If you find persistence as a non-root user, it will likely live in user-space (profile files, user crontab, desktop autostart).
- Defensive hardening: Use AIDE/Tripwire for file integrity, auditd for exec auditing, restrict sshd (no root login, key-only auth), and review sudoers regularly.

## Minimal cheat sheet (one-screen flow)
```
# Quick persistence hunt (as root where possible)

# 1) Accounts/SSH
awk -F: '($7 ~ /(bash|zsh|sh)$/){print $0}' /etc/passwd
sudo find /root /home -maxdepth 3 -type f -name authorized_keys -exec stat -c "%y %n" {} \;

# 2) Cron/Timers
sudo grep -n . /etc/crontab; sudo grep -R -n . /etc/cron.d 2>/dev/null
for u in $(cut -d: -f1 /etc/passwd); do crontab -u "$u" -l 2>/dev/null | sed "s/^/[user=$u] /"; done
systemctl list-timers --all

# 3) Services
systemctl list-unit-files --type=service --state=enabled
sudo grep -R -nE 'ExecStart=.*(curl|wget|nc|socat|bash|/dev/tcp|python)' /etc/systemd/system /lib/systemd/system 2>/dev/null

# 4) Startup files
sudo egrep -nH . /etc/profile /etc/bash.bashrc 2>/dev/null
sudo grep -R -nE '(curl|wget|nc|socat|/dev/tcp|bash -i)' /root/.* /home/*/.bash* /home/*/.profile /home/*/.zshrc 2>/dev/null
test -e /etc/rc.local && sudo sed -n '1,200p' /etc/rc.local

# 5) Advanced/Other
[ -f /etc/ld.so.preload ] && sudo cat /etc/ld.so.preload
sudo find / -xdev \( -perm -4000 -o -perm -2000 \) -type f -printf "%M %u:%g %TY-%Tm-%Td %TH:%TM %p\n" 2>/dev/null | sort
ss -tulpen

# 6) Logs
sudo tail -n 200 /var/log/auth.log 2>/dev/null || sudo tail -n 200 /var/log/secure 2>/dev/null
journalctl -b -0 -n 200 --no-pager
```

## Summary
- Persistence on Linux commonly leverages accounts/SSH keys, cron/at/timers, systemd services, shell startup files, boot scripts, dynamic linker preload, PAM, and SUID/SGID binaries.
- Without the transcript, this guide focused on high-level understanding, verification, detection, and safe cleanup—aligned to ethical, authorized lab practice for eJPT.
- Key paths to remember: /etc/systemd/system/*.service, /lib/systemd/system/*.service, /etc/crontab, /etc/cron.*, /var/spool/cron, ~/.ssh/authorized_keys, /etc/rc.local, /etc/profile and per-user shell init files, /etc/ld.so.preload, /etc/pam.d/*.
- For exam prep, be able to recognize these surfaces, enumerate them quickly, and understand what evidence they leave behind and how defenders would remove them.