# 04 - Exploiting Samba (eJPT study notes)

Note: The transcript was not provided. The outline below is inferred conservatively from the filename “04 - Exploiting Samba.mp4” in the Linux exploitation module. It reflects common eJPT lab workflows for enumerating and exploiting Samba on Linux. Your specific lab/version may differ.

## What the video covers (Introduction / big picture)
- Understanding Samba (SMB/CIFS on Linux) exposure on TCP 139/445 and UDP 137/138.
- Enumerating SMB to discover shares, users, OS, and Samba version.
- Identifying misconfigurations (anonymous/guest access, writable shares) and known RCE vulnerabilities tied to specific Samba versions.
- High-level exploitation paths often seen in labs:
  - CVE-2007-2447 (username map script) in Samba 3.0.20–3.0.25rc3.
  - CVE-2017-7494 (“SambaCry”) in Samba 3.5.0–4.6.4 (depending on patch level).
- Using standard tools (Nmap NSE, smbclient, smbmap, enum4linux-ng, rpcclient), and Metasploit modules for verification/exploitation in authorized lab environments.

Only test and exploit systems you own or have explicit permission to assess.

## Flow (ordered)
1. Scan and identify SMB ports/services.
2. Fingerprint Samba version and OS; enumerate shares and users.
3. Test anonymous/guest access; enumerate share contents; look for credentials/artifacts.
4. Assess share permissions (read/write) and safely pull files for offline analysis.
5. Map Samba version/misconfigurations to known vulnerabilities (searchsploit/vendor advisories).
6. Validate suspected vulnerabilities with safe checks where possible.
7. In a lab, use appropriate exploitation modules or techniques; verify access and enumerate post-exploitation.
8. Document findings and remediation recommendations.

## Tools highlighted
- Nmap (+ smb NSE scripts)
- smbclient (SMB CLI)
- smbmap (share/permission mapper)
- enum4linux-ng (SMB/NetBIOS enumeration)
- rpcclient (RPC over SMB enumeration)
- crackmapexec (quick credential/anonymous checks)
- searchsploit (Exploit-DB local index)
- Metasploit Framework (module search/check/exploit in labs)

## Typical command walkthrough (detailed, copy-paste friendly)
Replace <TARGET> with the target IP and run only against authorized systems.

- Quick port discovery:
```bash
nmap -p 139,445 -sS -sV -O --reason <TARGET>
nmap -sU -p 137,138 --reason <TARGET>
```

- SMB OS/version and share enumeration (Nmap NSE):
```bash
nmap -p 139,445 --script smb-os-discovery,smb-enum-shares,smb-enum-users -sV <TARGET>
```

- Try anonymous/guest share listing:
```bash
smbclient -L //<TARGET> -N
# If SMB dialect issues occur, try forcing protocols:
smbclient -L //<TARGET> -m SMB2 -N || smbclient -L //<TARGET> -m NT1 -N
```

- Map shares/permissions with smbmap:
```bash
# Anonymous
smbmap -H <TARGET>
smbmap -H <TARGET> -u '' -p ''
# If you have creds
# smbmap -H <TARGET> -u <USER> -p <PASS>
```

- Enumerate broadly with enum4linux-ng:
```bash
enum4linux-ng -A <TARGET>
# For null session
enum4linux-ng -A -u '' -p '' <TARGET>
```

- RPC over SMB (null session):
```bash
rpcclient -U "" -N <TARGET> -c "srvinfo; enumdomusers; getdompwinfo"
```

- Connect to a share and exfil files safely (authorized lab):
```bash
# Connect anonymously to a share (replace SHARE)
smbclient //<TARGET>/SHARE -N
# Inside smbclient:
# smb: \> help
# smb: \> ls
# smb: \> cd <dir>
# smb: \> get <file>
# Recursively pull all files:
# smb: \> recurse on
# smb: \> prompt off
# smb: \> mget *
```

- Mount a share locally (useful for large pulls; adjust vers as needed):
```bash
sudo mkdir -p /mnt/smb
sudo mount -t cifs //<TARGET>/SHARE /mnt/smb -o guest,vers=1.0  # try vers=2.0/3.0 if needed
ls -la /mnt/smb
sudo umount /mnt/smb
```

- Grep for interesting artifacts after download:
```bash
grep -RniE 'passw|cred|secret|key|ssh|token|conf' ./downloaded_smb/
```

- Identify known Samba vulns by version:
```bash
# Replace VERSION gleaned from nmap/enum (e.g., 3.0.20 or 4.5.0)
searchsploit samba | grep -iE '3\.0\.20|4\.5|cve-2007-2447|2017-7494' || searchsploit samba <VERSION>
```

- Metasploit verification (module discovery and safe checks):
```bash
msfconsole -q -x "search samba; exit"
# Notable modules to review (read 'info' and use 'check' where available):
#  - exploit/multi/samba/usermap_script       (CVE-2007-2447)
#  - exploit/linux/samba/is_known_pipename    (CVE-2017-7494)
#  - auxiliary/scanner/smb/smb_version        (fingerprint)
#  - auxiliary/scanner/smb/smb_enumshares     (enumeration)
```
Inside msfconsole (example workflow with placeholders; review module docs first, and only run in a lab):
```text
use auxiliary/scanner/smb/smb_version
set RHOSTS <TARGET>
run

use auxiliary/scanner/smb/smb_enumshares
set RHOSTS <TARGET>
run

# For suspected CVE-2007-2447
use exploit/multi/samba/usermap_script
show options
set RHOSTS <TARGET>
check   # Prefer check before exploit in labs

# For suspected CVE-2017-7494
use exploit/linux/samba/is_known_pipename
show options
set RHOSTS <TARGET>
check
```

Notes:
- Some older Nmap smb-vuln-* scripts have been deprecated/removed; prefer module docs, vendor advisories, and manual version mapping.
- If SMB1 is disabled or dialect negotiation fails, adjust smbclient “-m” or mount “vers” options.

## Practical tips
- Always try null/guest access first; many labs expose readable shares anonymous users can access.
- If smbclient fails, try forcing a protocol dialect: -m NT1 (SMB1) or -m SMB2/3.
- Use smbmap for quick permission snapshots; -R SHARE to recurse and -A 'regex' to search for sensitive filenames (id_rsa, .ssh, backup, .conf).
- Version-based exploitation is common in labs; confirm with multiple sources (NSE output, enum4linux-ng, rpcclient srvinfo).
- Writable shares can be leveraged in labs to stage files, but treat them as sensitive—don’t run untrusted binaries from shares on your host.
- Keep timeouts reasonable; SMB enumeration can be slow on unstable networks.
- Document share names, access level (R/W), interesting files, and suspected CVEs with exact versions.

## Minimal cheat sheet (one-screen flow)
```bash
# 1) Discover SMB
nmap -p 139,445 -sV -O <TARGET>

# 2) Enumerate via NSE
nmap -p 139,445 --script smb-os-discovery,smb-enum-shares,smb-enum-users -sV <TARGET>

# 3) Null/guest checks
smbclient -L //<TARGET> -N
smbmap -H <TARGET> -u '' -p ''
enum4linux-ng -A -u '' -p '' <TARGET>

# 4) Browse and pull files
smbclient //<TARGET>/SHARE -N
# smb: \> recurse on; prompt off; mget *

# 5) Mount share (if needed)
sudo mount -t cifs //<TARGET>/SHARE /mnt/smb -o guest,vers=1.0

# 6) Hunt for creds
grep -RniE 'pass|cred|ssh|key|token' ./downloaded_smb/

# 7) Map version to CVEs
searchsploit samba <VERSION>
# Review modules:
#  exploit/multi/samba/usermap_script     (CVE-2007-2447)
#  exploit/linux/samba/is_known_pipename  (CVE-2017-7494)

# 8) Metasploit (verify modules/options; prefer 'check' first; lab use only)
msfconsole -q
```

## Summary
- The video (inferred) walks through enumerating and exploiting Samba on Linux targets: identify SMB services, enumerate shares and users, and correlate Samba version/misconfigurations with known issues.
- Core tooling: Nmap NSE, smbclient, smbmap, enum4linux-ng, rpcclient, searchsploit; Metasploit for verification/exploitation in authorized labs.
- Common lab exploits: CVE-2007-2447 (usermap script) on Samba 3.0.20–3.0.25rc3 and CVE-2017-7494 (SambaCry) on certain 3.5–4.6 builds.
- Practice disciplined, permissioned testing: enumerate thoroughly, verify versions, prefer safe checks, and only exploit in controlled lab environments.