# 01 – AV Evasion With Shellter

Note: No transcript was provided. The following is a conservative, best-effort summary inferred from the filename and common eJPT course flow. Where exact commands/flags from the video would normally appear, I provide safe, lab-focused equivalents and emphasize defensive analysis. I will not provide step‑by‑step AV evasion instructions.

## What the video covers (Introduction / big picture)
- Conceptual overview of antivirus (AV) evasion and why static/sig-based detection can be bypassed.
- How Shellter works at a high level: dynamic instrumentation and shellcode injection into 32-bit Windows PE files to produce polymorphic, AV‑resistant executables.
- Typical lab setup: Kali/Parrot + Wine to run Shellter, a Windows VM to test, and basic verification/detection steps.
- Ethics, scope, and safe handling: AV evasion belongs strictly in an isolated, authorized lab. Do not deploy on production networks or third‑party software without explicit permission.

## Flow (ordered)
1. Ethics and lab isolation reminder (snapshots, no internet egress, separate host‑only network).
2. Environment prep on Linux (enable i386, install Wine and Shellter).
3. Windows VM prep (analysis tools: Sysinternals, Sysmon, PE analysis).
4. High-level Shellter workflow (what it asks and produces, without actionable evasion specifics).
5. Test execution in Windows VM (offline) to observe behavior.
6. Defensive analysis:
   - Static triage (hashing, strings, PE metadata).
   - Behavioral monitoring (process, network, registry, file writes).
   - Heuristics and YARA indicators.
7. Cleanup, revert snapshots, and lessons learned.

## Tools highlighted
- Shellter (dynamic instrumentation for Windows 32-bit PE)
- Wine/Wine32 (to run Shellter on Kali/Parrot)
- Virtualization: VirtualBox/VMware
- Windows analysis stack:
  - Sysinternals: Process Explorer, Process Monitor, Autoruns, Sigcheck
  - Sysmon (with a community config)
- Static/behavioral analysis on Linux:
  - peframe, capa, strings, file, exiftool
  - ClamAV (clamscan)
  - YARA (custom rules for injected/packed traits)
- Hashing: sha256sum (Linux), Get-FileHash (Windows)

## Typical command walkthrough (detailed, copy‑paste friendly)
The commands below focus on safe lab setup and defensive analysis. They do not walk through producing or using an AV‑evading backdoor.

- Kali/Parrot: prepare 32‑bit support and install Shellter and Wine
```
sudo dpkg --add-architecture i386
sudo apt update
sudo apt install -y wine32 shellter
wineboot --init
shellter -h
```

- Optional: install analysis helpers on Linux
```
sudo apt install -y clamav exiftool binutils
python3 -m pip install --user peframe
python3 -m pip install --user capa
# Ensure ~/.local/bin is on PATH if using pip --user
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc && source ~/.bashrc
```

- If you receive a Windows sample to analyze (from your instructor/lab), keep it offline. On Linux:
```
# Replace "sample.exe" with your lab-provided file
file sample.exe
sha256sum sample.exe
exiftool sample.exe
strings -a -n 6 sample.exe | head -n 50
peframe sample.exe
capa sample.exe
clamscan -v sample.exe
```

- Windows VM: core Sysinternals and Sysmon setup (for behavioral logging)
  - Install Sysinternals Suite (download from Microsoft).
  - Install Sysmon with a community config (example: SwiftOnSecurity). Run in elevated CMD/Powershell:
```
# From folder containing Sysmon64.exe and config xml (e.g., sysmonconfig.xml)
Sysmon64.exe -i sysmonconfig.xml
# Verify service
sc query sysmon64
```

- Windows: basic checks on the sample (PowerShell and Sysinternals)
```
# PowerShell hashing
Get-FileHash .\sample.exe -Algorithm SHA256

# Sigcheck (Sysinternals). Run from Sysinternals directory or add to PATH.
sigcheck64.exe -q -m .\sample.exe
```

- Windows: observe runtime behavior (GUI steps)
  - Process Explorer: verify parent/child process relationships, command lines, integrity levels, and signatures.
  - Process Monitor: set filters (Process Name is sample.exe). Look for:
    - Registry operations (autoruns-like persistence attempts)
    - File writes (temporary paths, unusual directories)
    - Network I/O (if your sandbox allows)
  - Autoruns: check for persistence artifacts (Run keys, services, scheduled tasks).

- Optional YARA (Linux example)
```
# Example stub YARA rule for generic injection/packing indicators (tune for your lab)
cat > shellter_like_suspicions.yar << 'EOF'
rule Suspicious_PE_Injection_Traits {
  meta:
    description = "Generic traits that sometimes appear in injected/packed PEs"
  strings:
    $s1 = "VirtualAlloc" ascii nocase
    $s2 = "WriteProcessMemory" ascii nocase
    $s3 = "CreateRemoteThread" ascii nocase
    $s4 = "IsDebuggerPresent" ascii nocase
  condition:
    uint16(0) == 0x5A4D and 2 of ($s*)
}
EOF

yara -r shellter_like_suspicions.yar sample.exe
```

## Practical tips
- Ethics and scope:
  - Only perform AV evasion research in a fully isolated, authorized lab.
  - Do not upload live samples to public scanning sites; if you need to compare, upload hashes only.
- Lab hygiene:
  - Snapshot before/after. Keep Windows VM offline or on a host‑only network.
  - Use a clean, non‑sensitive 32‑bit PE for experiments and keep originals archived.
- Shellter specifics (high level):
  - Works best with 32‑bit PE targets; often requires Wine on Linux.
  - Offers automatic/manual modes and a stealth‑oriented instrumentation approach.
  - Output is typically a modified PE with obfuscated control flow to hinder static detection.
- Defensive mindset:
  - Static: check PE anomalies (sections, timestamps, import table shifts, entropy).
  - Behavior: watch for suspicious API usage, network callbacks, persistence writes, child process chains.
  - Logging: Sysmon Event IDs (1 Process Create, 3 Network Connect, 7 Image Load, 11 FileCreate, 13 Registry, etc.).
- Safety:
  - Keep clear notes of every action and artifact path to simplify cleanup.
  - Never execute experimental binaries on your host OS.

## Minimal cheat sheet (one‑screen flow)
- Prep
  - Linux: enable i386, install wine32 + shellter
  - Windows VM: Sysinternals + Sysmon + snapshots
- High‑level Shellter concept
  - Dynamic instrumentation modifies a 32‑bit PE to add an obfuscated stub
- Defensive triage (Linux)
```
file sample.exe
sha256sum sample.exe
peframe sample.exe
capa sample.exe
strings -a -n 6 sample.exe | less
clamscan -v sample.exe
```
- Behavioral (Windows)
  - Sysmon: install with config, collect EIDs 1/3/7/11/13
  - ProcMon: filter on sample.exe; note file/registry/network activity
  - ProcExp: verify parent/child, command line, signer
  - Sigcheck: sigcheck64.exe -q -m .\sample.exe
- Cleanup
  - Revert snapshots; don't leak samples; keep hashes/notes only

## Summary
This module introduces AV evasion with Shellter from a conceptual and lab‑safe perspective: Shellter employs dynamic instrumentation to modify 32‑bit Windows PE files in ways that can evade naive, signature‑only detection. In a responsible, isolated lab you prepare your Linux host (Wine + Shellter) and a Windows VM with strong telemetry (Sysinternals, Sysmon) to study static and behavioral indicators. Rather than walking through offensive payload creation, the emphasis here is on environment preparation, safe handling, and defense: how to hash and statically inspect a suspicious PE, how to watch its runtime behavior, and how to reason about detection heuristics and logging.