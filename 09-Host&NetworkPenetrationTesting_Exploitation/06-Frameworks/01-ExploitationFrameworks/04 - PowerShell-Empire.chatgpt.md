# 04 - PowerShell-Empire (01-ExploitationFrameworks)

Note: No transcript was provided. The following summary is inferred conservatively from the filename and common eJPT coverage of PowerShell Empire. To remain ethical and safe, this guide focuses on big-picture concepts, lab safety, and defensive monitoring. It intentionally avoids step-by-step offensive usage instructions.

## What the video covers (Introduction / big picture)
- PowerShell Empire at a glance: a post-exploitation command-and-control (C2) framework focused on Windows and PowerShell.
- Core concepts: listeners, stagers, agents, and modules, and how they fit in a typical red-team workflow.
- Safe-lab and legal boundaries: using C2 frameworks only in isolated, authorized test environments.
- Blue-team detection and hardening against PowerShell-based C2, including logging, Sysmon, and Windows Defender ASR rules.
- Mapping to MITRE ATT&CK (for awareness): T1059.001 (PowerShell), T1105 (Ingress Tool Transfer), T1071.001 (Web protocols), T1053 (Scheduled Task), etc.

## Flow (ordered)
1. Understand Empire’s architecture:
   - Listener: server-side transport (e.g., HTTP/HTTPS) receiving callbacks.
   - Stager: a small delivery mechanism that fetches/loads the full agent.
   - Agent: the interactive implant running on the target host.
   - Modules: post-exploitation capabilities run via the agent.
2. Prepare an isolated lab (legal/authorized only): snapshot VMs; segregated network; no internet or only controlled egress.
3. Conceptual C2 lifecycle:
   - Configure listener with proper transport, certs, and OPSEC options.
   - Generate a stager that fits the initial access vector in your lab scenario.
   - Receive agent callbacks; task agents; run post-exploitation modules.
4. OPSEC considerations (high level): staging keys, jitter, kill dates, working hours, user-agent strings, and domain fronting.
5. Defensive lens:
   - Enable PowerShell logging and transcription.
   - Deploy Sysmon and monitor relevant event IDs.
   - Use EDR/Defender features (ASR, AMSI) to observe and block.
6. Cleanup and revert: remove lab artifacts, rotate credentials, revert snapshots, collect logs for learning.

## Tools highlighted
- PowerShell Empire (C2 framework; post-exploitation).
- Starkiller (GUI for Empire).
- Windows telemetry and monitoring:
  - PowerShell Operational logging (Event ID 4103/4104).
  - Windows Security logs (4688 process creation, 4624 logon).
  - Sysmon (process creation, network connections, image loads).
- EDR/Defender hardening:
  - Windows Defender Attack Surface Reduction (ASR) rules.
  - Constrained Language Mode (CLM), script execution policies, AMSI.

## Typical command walkthrough (detailed, copy-paste friendly)
To remain safe and ethical, this walkthrough focuses on defensive and lab-observation steps only. Use these in an isolated, authorized Windows lab to observe and learn how PowerShell C2 traffic and activity appears in logs.

1) Enable the PowerShell Operational log (Event ID 4104 script block logging)
```
wevtutil sl Microsoft-Windows-PowerShell/Operational /e:true
```

2) Enable PowerShell Script Block, Module Logging, and Transcription
```
# Run in an elevated PowerShell session
# Create directories for transcripts
New-Item -Path "C:\ProgramData\PS" -ItemType Directory -Force | Out-Null
New-Item -Path "C:\ProgramData\PS\Transcripts" -ItemType Directory -Force | Out-Null

# Script Block Logging
New-Item -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging -Force | Out-Null
Set-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging -Name EnableScriptBlockLogging -Value 1 -Type DWord

# Module Logging
New-Item -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging -Force | Out-Null
Set-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging -Name EnableModuleLogging -Value 1 -Type DWord
New-Item -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging\ModuleNames -Force | Out-Null
New-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging\ModuleNames -Name * -Value * -PropertyType String -Force

# Transcription
New-Item -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription -Force | Out-Null
Set-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription -Name EnableTranscripting -Value 1 -Type DWord
Set-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription -Name OutputDirectory -Value "C:\ProgramData\PS\Transcripts"
Set-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription -Name EnableInvocationHeader -Value 1 -Type DWord

# Optional: tighten execution policy (lab/enterprise-appropriate)
Set-ExecutionPolicy -ExecutionPolicy AllSigned -Scope LocalMachine -Force
```

3) Install Sysmon with a community config (to enrich process/network telemetry)
```
# Run in an elevated PowerShell session
$Temp    = $env:TEMP
$sysZip  = Join-Path $Temp "Sysmon.zip"
$sysDir  = Join-Path $Temp "Sysmon"
$config  = Join-Path $Temp "sysmonconfig.xml"

Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Sysmon.zip" -OutFile $sysZip
Expand-Archive -Path $sysZip -DestinationPath $sysDir -Force
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml" -OutFile $config

$sysmonExe = Join-Path $sysDir "Sysmon64.exe"
& $sysmonExe -accepteula -i $config
```

4) Hunt suspicious PowerShell activity (examples)
```
# View latest PowerShell script block events (4104)
Get-WinEvent -FilterHashtable @{ LogName = 'Microsoft-Windows-PowerShell/Operational'; Id = 4104 } -MaxEvents 50 |
  Select-Object TimeCreated, Id, Message

# Process creation events for PowerShell (Security 4688)
Get-WinEvent -FilterHashtable @{ LogName = 'Security'; Id = 4688 } -MaxEvents 200 |
  Where-Object { $_.Message -match 'New Process Name:\s+.*powershell\.exe' } |
  Select-Object TimeCreated, Message

# Sysmon process creation (Event ID 1) for PowerShell
Get-WinEvent -FilterHashtable @{ LogName = 'Microsoft-Windows-Sysmon/Operational'; Id = 1 } |
  Where-Object { $_.Message -match 'Image:.*\\powershell\.exe' } |
  Select-Object TimeCreated, Message

# Look for common suspicious strings (base64, IEX, downloadstring)
Get-WinEvent -FilterHashtable @{ LogName = 'Microsoft-Windows-PowerShell/Operational'; Id = 4104 } |
  Where-Object { $_.Message -match 'FromBase64String|IEX|Invoke-Expression|DownloadString|WebClient|Hidden|Bypass' } |
  Select-Object TimeCreated, Message
```

5) Optional: Defender ASR rules helpful against malicious PowerShell
```
# Requires Windows 10/11 Enterprise E5/Defender for Endpoint or equivalent licensing
# Always validate impact in a test OU before broad enablement
Set-MpPreference -AttackSurfaceReductionRules_Ids `
"D4F940AB-401B-4EFC-AADC-AD5F3C50688A", `  # Block Office from creating child processes
"5BEB7EFE-FD9A-4556-801D-275E5FFC04CC", `  # Block process creations from PS/Command Shell
"BE9BA2D9-53EA-4CDC-84E5-9B1EEEE46550" `   # Block Office from creating executable content
-AttackSurfaceReductionRules_Actions Enabled
```

6) Useful paths and logs (for quick reference)
- PowerShell Operational log (Event ID 4103/4104):
  - Event Viewer: Applications and Services Logs > Microsoft > Windows > PowerShell > Operational
  - File: C:\Windows\System32\Winevt\Logs\Microsoft-Windows-PowerShell%4Operational.evtx
- Sysmon log:
  - Event Viewer: Applications and Services Logs > Microsoft > Windows > Sysmon > Operational
  - File: C:\Windows\System32\Winevt\Logs\Microsoft-Windows-Sysmon%4Operational.evtx
- Transcripts: C:\ProgramData\PS\Transcripts

## Practical tips
- Legal and ethical first: use C2 tools only on assets you own or have explicit written permission to test. Keep lab isolated and revertible.
- Snapshot before you start; revert after. Maintain an audit trail of what you test and why.
- Treat Empire conceptually as: Listener (server) → Stager (delivery) → Agent (implant) → Modules (tasks).
- Expect OPSEC-conscious features in Empire: jitter, killdate, working hours, staging keys, TLS certs, URL patterns, user-agent customization.
- Detection ideas:
  - Unusual PowerShell launch patterns (powershell.exe with -ExecutionPolicy Bypass, -EncodedCommand).
  - Long base64 strings, IEX, DownloadString/WebClient usage in Event ID 4104.
  - Network egress over HTTP/HTTPS to uncommon domains/paths, and System process connecting outbound.
  - Child processes spawned by Office or script hosts (wscript/cscript) leading to PowerShell.
- Harden progressively: turn on logging first (observe), then enable ASR rules in audit, then block mode after validation.

## Minimal cheat sheet (one-screen flow)
- Architecture: Listener → Stager → Agent → Modules (post-exploitation).
- Lab safety:
  - Isolated network, snapshots, no production connectivity.
- Enable visibility:
  - wevtutil sl Microsoft-Windows-PowerShell/Operational /e:true
  - Enable ScriptBlock + Module logging + Transcription (registry keys as above).
  - Install Sysmon with community config.
- Hunt quickly:
  - Event ID 4104: script block content (look for IEX, base64, DownloadString).
  - Event ID 4688 / Sysmon 1: powershell.exe process creation with suspicious flags.
- Harden:
  - Set-ExecutionPolicy AllSigned (where feasible).
  - ASR rules (test in audit → enable).
  - EDR/AMSI monitoring on PowerShell execution.

## Summary
This video sits within an eJPT “Exploitation Frameworks” module and centers on PowerShell Empire, a post-exploitation C2 emphasizing PowerShell. The key takeaways are the architecture (listeners, stagers, agents, modules), the importance of operating only in authorized labs, and seeing Empire through both red-team and blue-team lenses. The notes provide a safe, defensive-focused walkthrough: enabling PowerShell logging, deploying Sysmon, and hunting typical PowerShell-C2 behavior in Windows event logs. These steps help you understand and detect Empire-like activity while respecting ethical and legal boundaries.